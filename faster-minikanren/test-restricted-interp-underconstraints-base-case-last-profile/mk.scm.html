<!DOCTYPE html>
<html>
<head>
<meta http-equiv=Content-Type content="text/html;charset=utf-8">
<title>mk.scm</title>
<style type="text/css">
* { border: 0; margin: 0; outline: 0; padding: 0; vertical-align: baseline; }
code, kbd, pre, samp { font-family: monospace, monospace; font-size: 1rem; }
html { -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased; }
table { border-collapse: collapse; border-spacing: 0; }
body { padding: 1rem; }
h1, h2, h3, h4 { line-height: 1.25; margin-bottom: 0.5rem; }
h1 { font-size: 1.296rem; }
h2 { font-size: 1.215rem; }
h3 { font-size: 1.138rem; }
h4 { font-size: 1.067rem; }
html { font-family: monospace, monospace; font-size: 1rem; }
p { margin-bottom: 1.25rem; }
.pc0 { background-color: #111111; color: white; white-space: nowrap; }
.pc1 { background-color: #607D8B; color: white; white-space: nowrap; }
.pc2 { background-color: #9C27B0; color: black; white-space: nowrap; }
.pc3 { background-color: #673AB7; color: white; white-space: nowrap; }
.pc4 { background-color: #3F51B5; color: white; white-space: nowrap; }
.pc5 { background-color: #2196F3; color: black; white-space: nowrap; }
.pc6 { background-color: #00BCD4; color: black; white-space: nowrap; }
.pc7 { background-color: #4CAF50; color: black; white-space: nowrap; }
.pc8 { background-color: #CDDC39; color: black; white-space: nowrap; }
.pc9 { background-color: #FFEB3B; color: black; white-space: nowrap; }
.pc10 { background-color: #FFC107; color: black; white-space: nowrap; }
.pc11 { background-color: #FF9800; color: black; white-space: nowrap; }
.pc12 { background-color: #F44336; color: white; white-space: nowrap; }
</style>
</head>
<body class=pc0>
<h1 style="margin-bottom: 1rem">mk.scm<span style="opacity: 0.5"> on Mon Jun 12 01:41:21 2023</span></h1>
<table><tr><td style="color: #666666; font-weight: bold; padding-right: 1rem; text-align: right"><pre>
<span id=line1>1
</span><span id=line2>2
</span><span id=line3>3
</span><span id=line4>4
</span><span id=line5>5
</span><span id=line6>6
</span><span id=line7>7
</span><span id=line8>8
</span><span id=line9>9
</span><span id=line10>10
</span><span id=line11>11
</span><span id=line12>12
</span><span id=line13>13
</span><span id=line14>14
</span><span id=line15>15
</span><span id=line16>16
</span><span id=line17>17
</span><span id=line18>18
</span><span id=line19>19
</span><span id=line20>20
</span><span id=line21>21
</span><span id=line22>22
</span><span id=line23>23
</span><span id=line24>24
</span><span id=line25>25
</span><span id=line26>26
</span><span id=line27>27
</span><span id=line28>28
</span><span id=line29>29
</span><span id=line30>30
</span><span id=line31>31
</span><span id=line32>32
</span><span id=line33>33
</span><span id=line34>34
</span><span id=line35>35
</span><span id=line36>36
</span><span id=line37>37
</span><span id=line38>38
</span><span id=line39>39
</span><span id=line40>40
</span><span id=line41>41
</span><span id=line42>42
</span><span id=line43>43
</span><span id=line44>44
</span><span id=line45>45
</span><span id=line46>46
</span><span id=line47>47
</span><span id=line48>48
</span><span id=line49>49
</span><span id=line50>50
</span><span id=line51>51
</span><span id=line52>52
</span><span id=line53>53
</span><span id=line54>54
</span><span id=line55>55
</span><span id=line56>56
</span><span id=line57>57
</span><span id=line58>58
</span><span id=line59>59
</span><span id=line60>60
</span><span id=line61>61
</span><span id=line62>62
</span><span id=line63>63
</span><span id=line64>64
</span><span id=line65>65
</span><span id=line66>66
</span><span id=line67>67
</span><span id=line68>68
</span><span id=line69>69
</span><span id=line70>70
</span><span id=line71>71
</span><span id=line72>72
</span><span id=line73>73
</span><span id=line74>74
</span><span id=line75>75
</span><span id=line76>76
</span><span id=line77>77
</span><span id=line78>78
</span><span id=line79>79
</span><span id=line80>80
</span><span id=line81>81
</span><span id=line82>82
</span><span id=line83>83
</span><span id=line84>84
</span><span id=line85>85
</span><span id=line86>86
</span><span id=line87>87
</span><span id=line88>88
</span><span id=line89>89
</span><span id=line90>90
</span><span id=line91>91
</span><span id=line92>92
</span><span id=line93>93
</span><span id=line94>94
</span><span id=line95>95
</span><span id=line96>96
</span><span id=line97>97
</span><span id=line98>98
</span><span id=line99>99
</span><span id=line100>100
</span><span id=line101>101
</span><span id=line102>102
</span><span id=line103>103
</span><span id=line104>104
</span><span id=line105>105
</span><span id=line106>106
</span><span id=line107>107
</span><span id=line108>108
</span><span id=line109>109
</span><span id=line110>110
</span><span id=line111>111
</span><span id=line112>112
</span><span id=line113>113
</span><span id=line114>114
</span><span id=line115>115
</span><span id=line116>116
</span><span id=line117>117
</span><span id=line118>118
</span><span id=line119>119
</span><span id=line120>120
</span><span id=line121>121
</span><span id=line122>122
</span><span id=line123>123
</span><span id=line124>124
</span><span id=line125>125
</span><span id=line126>126
</span><span id=line127>127
</span><span id=line128>128
</span><span id=line129>129
</span><span id=line130>130
</span><span id=line131>131
</span><span id=line132>132
</span><span id=line133>133
</span><span id=line134>134
</span><span id=line135>135
</span><span id=line136>136
</span><span id=line137>137
</span><span id=line138>138
</span><span id=line139>139
</span><span id=line140>140
</span><span id=line141>141
</span><span id=line142>142
</span><span id=line143>143
</span><span id=line144>144
</span><span id=line145>145
</span><span id=line146>146
</span><span id=line147>147
</span><span id=line148>148
</span><span id=line149>149
</span><span id=line150>150
</span><span id=line151>151
</span><span id=line152>152
</span><span id=line153>153
</span><span id=line154>154
</span><span id=line155>155
</span><span id=line156>156
</span><span id=line157>157
</span><span id=line158>158
</span><span id=line159>159
</span><span id=line160>160
</span><span id=line161>161
</span><span id=line162>162
</span><span id=line163>163
</span><span id=line164>164
</span><span id=line165>165
</span><span id=line166>166
</span><span id=line167>167
</span><span id=line168>168
</span><span id=line169>169
</span><span id=line170>170
</span><span id=line171>171
</span><span id=line172>172
</span><span id=line173>173
</span><span id=line174>174
</span><span id=line175>175
</span><span id=line176>176
</span><span id=line177>177
</span><span id=line178>178
</span><span id=line179>179
</span><span id=line180>180
</span><span id=line181>181
</span><span id=line182>182
</span><span id=line183>183
</span><span id=line184>184
</span><span id=line185>185
</span><span id=line186>186
</span><span id=line187>187
</span><span id=line188>188
</span><span id=line189>189
</span><span id=line190>190
</span><span id=line191>191
</span><span id=line192>192
</span><span id=line193>193
</span><span id=line194>194
</span><span id=line195>195
</span><span id=line196>196
</span><span id=line197>197
</span><span id=line198>198
</span><span id=line199>199
</span><span id=line200>200
</span><span id=line201>201
</span><span id=line202>202
</span><span id=line203>203
</span><span id=line204>204
</span><span id=line205>205
</span><span id=line206>206
</span><span id=line207>207
</span><span id=line208>208
</span><span id=line209>209
</span><span id=line210>210
</span><span id=line211>211
</span><span id=line212>212
</span><span id=line213>213
</span><span id=line214>214
</span><span id=line215>215
</span><span id=line216>216
</span><span id=line217>217
</span><span id=line218>218
</span><span id=line219>219
</span><span id=line220>220
</span><span id=line221>221
</span><span id=line222>222
</span><span id=line223>223
</span><span id=line224>224
</span><span id=line225>225
</span><span id=line226>226
</span><span id=line227>227
</span><span id=line228>228
</span><span id=line229>229
</span><span id=line230>230
</span><span id=line231>231
</span><span id=line232>232
</span><span id=line233>233
</span><span id=line234>234
</span><span id=line235>235
</span><span id=line236>236
</span><span id=line237>237
</span><span id=line238>238
</span><span id=line239>239
</span><span id=line240>240
</span><span id=line241>241
</span><span id=line242>242
</span><span id=line243>243
</span><span id=line244>244
</span><span id=line245>245
</span><span id=line246>246
</span><span id=line247>247
</span><span id=line248>248
</span><span id=line249>249
</span><span id=line250>250
</span><span id=line251>251
</span><span id=line252>252
</span><span id=line253>253
</span><span id=line254>254
</span><span id=line255>255
</span><span id=line256>256
</span><span id=line257>257
</span><span id=line258>258
</span><span id=line259>259
</span><span id=line260>260
</span><span id=line261>261
</span><span id=line262>262
</span><span id=line263>263
</span><span id=line264>264
</span><span id=line265>265
</span><span id=line266>266
</span><span id=line267>267
</span><span id=line268>268
</span><span id=line269>269
</span><span id=line270>270
</span><span id=line271>271
</span><span id=line272>272
</span><span id=line273>273
</span><span id=line274>274
</span><span id=line275>275
</span><span id=line276>276
</span><span id=line277>277
</span><span id=line278>278
</span><span id=line279>279
</span><span id=line280>280
</span><span id=line281>281
</span><span id=line282>282
</span><span id=line283>283
</span><span id=line284>284
</span><span id=line285>285
</span><span id=line286>286
</span><span id=line287>287
</span><span id=line288>288
</span><span id=line289>289
</span><span id=line290>290
</span><span id=line291>291
</span><span id=line292>292
</span><span id=line293>293
</span><span id=line294>294
</span><span id=line295>295
</span><span id=line296>296
</span><span id=line297>297
</span><span id=line298>298
</span><span id=line299>299
</span><span id=line300>300
</span><span id=line301>301
</span><span id=line302>302
</span><span id=line303>303
</span><span id=line304>304
</span><span id=line305>305
</span><span id=line306>306
</span><span id=line307>307
</span><span id=line308>308
</span><span id=line309>309
</span><span id=line310>310
</span><span id=line311>311
</span><span id=line312>312
</span><span id=line313>313
</span><span id=line314>314
</span><span id=line315>315
</span><span id=line316>316
</span><span id=line317>317
</span><span id=line318>318
</span><span id=line319>319
</span><span id=line320>320
</span><span id=line321>321
</span><span id=line322>322
</span><span id=line323>323
</span><span id=line324>324
</span><span id=line325>325
</span><span id=line326>326
</span><span id=line327>327
</span><span id=line328>328
</span><span id=line329>329
</span><span id=line330>330
</span><span id=line331>331
</span><span id=line332>332
</span><span id=line333>333
</span><span id=line334>334
</span><span id=line335>335
</span><span id=line336>336
</span><span id=line337>337
</span><span id=line338>338
</span><span id=line339>339
</span><span id=line340>340
</span><span id=line341>341
</span><span id=line342>342
</span><span id=line343>343
</span><span id=line344>344
</span><span id=line345>345
</span><span id=line346>346
</span><span id=line347>347
</span><span id=line348>348
</span><span id=line349>349
</span><span id=line350>350
</span><span id=line351>351
</span><span id=line352>352
</span><span id=line353>353
</span><span id=line354>354
</span><span id=line355>355
</span><span id=line356>356
</span><span id=line357>357
</span><span id=line358>358
</span><span id=line359>359
</span><span id=line360>360
</span><span id=line361>361
</span><span id=line362>362
</span><span id=line363>363
</span><span id=line364>364
</span><span id=line365>365
</span><span id=line366>366
</span><span id=line367>367
</span><span id=line368>368
</span><span id=line369>369
</span><span id=line370>370
</span><span id=line371>371
</span><span id=line372>372
</span><span id=line373>373
</span><span id=line374>374
</span><span id=line375>375
</span><span id=line376>376
</span><span id=line377>377
</span><span id=line378>378
</span><span id=line379>379
</span><span id=line380>380
</span><span id=line381>381
</span><span id=line382>382
</span><span id=line383>383
</span><span id=line384>384
</span><span id=line385>385
</span><span id=line386>386
</span><span id=line387>387
</span><span id=line388>388
</span><span id=line389>389
</span><span id=line390>390
</span><span id=line391>391
</span><span id=line392>392
</span><span id=line393>393
</span><span id=line394>394
</span><span id=line395>395
</span><span id=line396>396
</span><span id=line397>397
</span><span id=line398>398
</span><span id=line399>399
</span><span id=line400>400
</span><span id=line401>401
</span><span id=line402>402
</span><span id=line403>403
</span><span id=line404>404
</span><span id=line405>405
</span><span id=line406>406
</span><span id=line407>407
</span><span id=line408>408
</span><span id=line409>409
</span><span id=line410>410
</span><span id=line411>411
</span><span id=line412>412
</span><span id=line413>413
</span><span id=line414>414
</span><span id=line415>415
</span><span id=line416>416
</span><span id=line417>417
</span><span id=line418>418
</span><span id=line419>419
</span><span id=line420>420
</span><span id=line421>421
</span><span id=line422>422
</span><span id=line423>423
</span><span id=line424>424
</span><span id=line425>425
</span><span id=line426>426
</span><span id=line427>427
</span><span id=line428>428
</span><span id=line429>429
</span><span id=line430>430
</span><span id=line431>431
</span><span id=line432>432
</span><span id=line433>433
</span><span id=line434>434
</span><span id=line435>435
</span><span id=line436>436
</span><span id=line437>437
</span><span id=line438>438
</span><span id=line439>439
</span><span id=line440>440
</span><span id=line441>441
</span><span id=line442>442
</span><span id=line443>443
</span><span id=line444>444
</span><span id=line445>445
</span><span id=line446>446
</span><span id=line447>447
</span><span id=line448>448
</span><span id=line449>449
</span><span id=line450>450
</span><span id=line451>451
</span><span id=line452>452
</span><span id=line453>453
</span><span id=line454>454
</span><span id=line455>455
</span><span id=line456>456
</span><span id=line457>457
</span><span id=line458>458
</span><span id=line459>459
</span><span id=line460>460
</span><span id=line461>461
</span><span id=line462>462
</span><span id=line463>463
</span><span id=line464>464
</span><span id=line465>465
</span><span id=line466>466
</span><span id=line467>467
</span><span id=line468>468
</span><span id=line469>469
</span><span id=line470>470
</span><span id=line471>471
</span><span id=line472>472
</span><span id=line473>473
</span><span id=line474>474
</span><span id=line475>475
</span><span id=line476>476
</span><span id=line477>477
</span><span id=line478>478
</span><span id=line479>479
</span><span id=line480>480
</span><span id=line481>481
</span><span id=line482>482
</span><span id=line483>483
</span><span id=line484>484
</span><span id=line485>485
</span><span id=line486>486
</span><span id=line487>487
</span><span id=line488>488
</span><span id=line489>489
</span><span id=line490>490
</span><span id=line491>491
</span><span id=line492>492
</span><span id=line493>493
</span><span id=line494>494
</span><span id=line495>495
</span><span id=line496>496
</span><span id=line497>497
</span><span id=line498>498
</span><span id=line499>499
</span><span id=line500>500
</span><span id=line501>501
</span><span id=line502>502
</span><span id=line503>503
</span><span id=line504>504
</span><span id=line505>505
</span><span id=line506>506
</span><span id=line507>507
</span><span id=line508>508
</span><span id=line509>509
</span><span id=line510>510
</span><span id=line511>511
</span><span id=line512>512
</span><span id=line513>513
</span><span id=line514>514
</span><span id=line515>515
</span><span id=line516>516
</span><span id=line517>517
</span><span id=line518>518
</span><span id=line519>519
</span><span id=line520>520
</span><span id=line521>521
</span><span id=line522>522
</span><span id=line523>523
</span><span id=line524>524
</span><span id=line525>525
</span><span id=line526>526
</span><span id=line527>527
</span><span id=line528>528
</span><span id=line529>529
</span><span id=line530>530
</span><span id=line531>531
</span><span id=line532>532
</span><span id=line533>533
</span><span id=line534>534
</span><span id=line535>535
</span><span id=line536>536
</span><span id=line537>537
</span><span id=line538>538
</span><span id=line539>539
</span><span id=line540>540
</span><span id=line541>541
</span><span id=line542>542
</span><span id=line543>543
</span><span id=line544>544
</span><span id=line545>545
</span><span id=line546>546
</span><span id=line547>547
</span><span id=line548>548
</span><span id=line549>549
</span><span id=line550>550
</span><span id=line551>551
</span><span id=line552>552
</span><span id=line553>553
</span><span id=line554>554
</span><span id=line555>555
</span><span id=line556>556
</span><span id=line557>557
</span><span id=line558>558
</span><span id=line559>559
</span><span id=line560>560
</span><span id=line561>561
</span><span id=line562>562
</span><span id=line563>563
</span><span id=line564>564
</span><span id=line565>565
</span><span id=line566>566
</span><span id=line567>567
</span><span id=line568>568
</span><span id=line569>569
</span><span id=line570>570
</span><span id=line571>571
</span><span id=line572>572
</span><span id=line573>573
</span><span id=line574>574
</span><span id=line575>575
</span><span id=line576>576
</span><span id=line577>577
</span><span id=line578>578
</span><span id=line579>579
</span><span id=line580>580
</span><span id=line581>581
</span><span id=line582>582
</span><span id=line583>583
</span><span id=line584>584
</span><span id=line585>585
</span><span id=line586>586
</span><span id=line587>587
</span><span id=line588>588
</span><span id=line589>589
</span><span id=line590>590
</span><span id=line591>591
</span><span id=line592>592
</span><span id=line593>593
</span><span id=line594>594
</span><span id=line595>595
</span><span id=line596>596
</span><span id=line597>597
</span><span id=line598>598
</span><span id=line599>599
</span><span id=line600>600
</span><span id=line601>601
</span><span id=line602>602
</span><span id=line603>603
</span><span id=line604>604
</span><span id=line605>605
</span><span id=line606>606
</span><span id=line607>607
</span><span id=line608>608
</span><span id=line609>609
</span><span id=line610>610
</span><span id=line611>611
</span><span id=line612>612
</span><span id=line613>613
</span><span id=line614>614
</span><span id=line615>615
</span><span id=line616>616
</span><span id=line617>617
</span><span id=line618>618
</span><span id=line619>619
</span><span id=line620>620
</span><span id=line621>621
</span><span id=line622>622
</span><span id=line623>623
</span><span id=line624>624
</span><span id=line625>625
</span><span id=line626>626
</span><span id=line627>627
</span><span id=line628>628
</span><span id=line629>629
</span><span id=line630>630
</span><span id=line631>631
</span><span id=line632>632
</span><span id=line633>633
</span><span id=line634>634
</span><span id=line635>635
</span><span id=line636>636
</span><span id=line637>637
</span><span id=line638>638
</span><span id=line639>639
</span><span id=line640>640
</span><span id=line641>641
</span><span id=line642>642
</span><span id=line643>643
</span><span id=line644>644
</span><span id=line645>645
</span><span id=line646>646
</span><span id=line647>647
</span><span id=line648>648
</span><span id=line649>649
</span><span id=line650>650
</span><span id=line651>651
</span><span id=line652>652
</span><span id=line653>653
</span><span id=line654>654
</span><span id=line655>655
</span><span id=line656>656
</span><span id=line657>657
</span><span id=line658>658
</span><span id=line659>659
</span><span id=line660>660
</span><span id=line661>661
</span><span id=line662>662
</span><span id=line663>663
</span><span id=line664>664
</span><span id=line665>665
</span><span id=line666>666
</span><span id=line667>667
</span><span id=line668>668
</span><span id=line669>669
</span><span id=line670>670
</span><span id=line671>671
</span><span id=line672>672
</span><span id=line673>673
</span><span id=line674>674
</span><span id=line675>675
</span><span id=line676>676
</span><span id=line677>677
</span><span id=line678>678
</span><span id=line679>679
</span><span id=line680>680
</span><span id=line681>681
</span><span id=line682>682
</span><span id=line683>683
</span><span id=line684>684
</span><span id=line685>685
</span><span id=line686>686
</span><span id=line687>687
</span><span id=line688>688
</span><span id=line689>689
</span><span id=line690>690
</span><span id=line691>691
</span><span id=line692>692
</span><span id=line693>693
</span><span id=line694>694
</span><span id=line695>695
</span><span id=line696>696
</span><span id=line697>697
</span><span id=line698>698
</span><span id=line699>699
</span><span id=line700>700
</span><span id=line701>701
</span><span id=line702>702
</span><span id=line703>703
</span><span id=line704>704
</span><span id=line705>705
</span><span id=line706>706
</span><span id=line707>707
</span><span id=line708>708
</span><span id=line709>709
</span><span id=line710>710
</span><span id=line711>711
</span><span id=line712>712
</span><span id=line713>713
</span><span id=line714>714
</span><span id=line715>715
</span><span id=line716>716
</span><span id=line717>717
</span><span id=line718>718
</span><span id=line719>719
</span><span id=line720>720
</span><span id=line721>721
</span><span id=line722>722
</span><span id=line723>723
</span><span id=line724>724
</span><span id=line725>725
</span><span id=line726>726
</span><span id=line727>727
</span><span id=line728>728
</span><span id=line729>729
</span><span id=line730>730
</span><span id=line731>731
</span><span id=line732>732
</span><span id=line733>733
</span><span id=line734>734
</span><span id=line735>735
</span><span id=line736>736
</span><span id=line737>737
</span><span id=line738>738
</span><span id=line739>739
</span><span id=line740>740
</span><span id=line741>741
</span><span id=line742>742
</span><span id=line743>743
</span><span id=line744>744
</span><span id=line745>745
</span><span id=line746>746
</span><span id=line747>747
</span><span id=line748>748
</span><span id=line749>749
</span><span id=line750>750
</span><span id=line751>751
</span><span id=line752>752
</span><span id=line753>753
</span><span id=line754>754
</span><span id=line755>755
</span><span id=line756>756
</span><span id=line757>757
</span><span id=line758>758
</span><span id=line759>759
</span><span id=line760>760
</span><span id=line761>761
</span><span id=line762>762
</span><span id=line763>763
</span><span id=line764>764
</span><span id=line765>765
</span><span id=line766>766
</span><span id=line767>767
</span><span id=line768>768
</span><span id=line769>769
</span><span id=line770>770
</span><span id=line771>771
</span><span id=line772>772
</span><span id=line773>773
</span><span id=line774>774
</span><span id=line775>775
</span><span id=line776>776
</span><span id=line777>777
</span><span id=line778>778
</span><span id=line779>779
</span><span id=line780>780
</span><span id=line781>781
</span><span id=line782>782
</span><span id=line783>783
</span><span id=line784>784
</span><span id=line785>785
</span><span id=line786>786
</span><span id=line787>787
</span><span id=line788>788
</span><span id=line789>789
</span><span id=line790>790
</span></pre></td><td><pre>
<span class=pc2 title="line 1 char 1 count 1">(define always-wrap-reified? </span><span class=pc2 title="line 1 char 30 count 1">(</span><span class=pc2 title="line 1 char 31 count 1">make-parameter</span><span class=pc2 title="line 1 char 30 count 1"> </span><span class=pc2 title="line 1 char 46 count 1">#f</span><span class=pc2 title="line 1 char 30 count 1">)</span><span class=pc2 title="line 1 char 1 count 1">)</span>

; Scope object.
; Used to determine whether a branch has occured between variable
; creation and unification to allow the set-var-val! optimization
; in subst-add. Both variables and substitutions will contain a
; scope. When a substitution flows through a conde it is assigned
; a new scope.

; Creates a new scope that is not scope-eq? to any other scope
<span class=pc2 title="line 11 char 1 count 1">(define (new-scope) </span><span class=pc2 title="line 11 char 21 count 17,717,332">(</span><span class=pc2 title="line 11 char 22 count 17,717,332">list</span><span class=pc2 title="line 11 char 21 count 17,717,332"> </span><span class=pc2 title="line 11 char 27 count 17,717,332">'scope</span><span class=pc2 title="line 11 char 21 count 17,717,332">)</span><span class=pc2 title="line 11 char 1 count 1">)</span>
<span class=pc2 title="line 12 char 1 count 1">(define scope-eq? </span><span class=pc2 title="line 12 char 19 count 1">eq?</span><span class=pc2 title="line 12 char 1 count 1">)</span>

; Scope used when variable bindings should always be made in the
; substitution, as in disequality solving and reification. We
; don't want to set-var-val! a variable when checking if a
; disequality constraint holds!
<span class=pc2 title="line 18 char 1 count 1">(define nonlocal-scope </span><span class=pc2 title="line 18 char 24 count 1">(</span><span class=pc2 title="line 18 char 25 count 1">list</span><span class=pc2 title="line 18 char 24 count 1"> </span><span class=pc2 title="line 18 char 30 count 1">'non-local-scope</span><span class=pc2 title="line 18 char 24 count 1">)</span><span class=pc2 title="line 18 char 1 count 1">)</span>


; Logic variable object.
; Contains:
;   val - value for variable assigned by unification using
;      set-var-val! optimization. unbound if not yet set or
;      stored in substitution.
;   scope - scope that the variable was created in.
;   idx - unique numeric index for the variable. Used by the
;      trie substitution representation.
; Variable objects are compared by object identity.

; The unique val for variables that have not yet been bound
; to a value or are bound in the substitution. Also used
; as the sentinal value for substitution and constraint store
; lookup.
<span class=pc2 title="line 35 char 1 count 1">(define unbound </span><span class=pc2 title="line 35 char 17 count 1">(</span><span class=pc2 title="line 35 char 18 count 1">list</span><span class=pc2 title="line 35 char 17 count 1"> </span><span class=pc2 title="line 35 char 23 count 1">'unbound</span><span class=pc2 title="line 35 char 17 count 1">)</span><span class=pc2 title="line 35 char 1 count 1">)</span>
<span class=pc2 title="line 36 char 1 count 1">(define (unbound? v) </span><span class=pc9 title="line 36 char 22 count 2,056,089,930">(</span><span class=pc9 title="line 36 char 23 count 2,056,089,930">eq?</span><span class=pc9 title="line 36 char 22 count 2,056,089,930"> </span><span class=pc9 title="line 36 char 27 count 2,056,089,930">v</span><span class=pc9 title="line 36 char 22 count 2,056,089,930"> </span><span class=pc9 title="line 36 char 29 count 2,056,089,930">unbound</span><span class=pc9 title="line 36 char 22 count 2,056,089,930">)</span><span class=pc2 title="line 36 char 1 count 1">)</span>

<span class=pc2 title="line 38 char 1 count 1">(define var</span>
  <span class=pc2 title="line 39 char 3 count 1">(let ((counter </span><span class=pc2 title="line 39 char 18 count 1">-1</span><span class=pc2 title="line 39 char 3 count 1">))</span>
    <span class=pc2 title="line 40 char 5 count 1">(lambda (scope)</span>
      <span class=pc2 title="line 41 char 7 count 103,896,979">(set! counter </span><span class=pc2 title="line 41 char 21 count 103,896,979">(</span><span class=pc2 title="line 41 char 22 count 103,896,979">+</span><span class=pc2 title="line 41 char 21 count 103,896,979"> </span><span class=pc2 title="line 41 char 24 count 103,896,979">1</span><span class=pc2 title="line 41 char 21 count 103,896,979"> </span><span class=pc2 title="line 41 char 26 count 103,896,979">counter</span><span class=pc2 title="line 41 char 21 count 103,896,979">)</span><span class=pc2 title="line 41 char 7 count 103,896,979">)</span>
      <span class=pc2 title="line 42 char 7 count 103,896,979">(</span><span class=pc2 title="line 42 char 8 count 103,896,979">vector</span><span class=pc2 title="line 42 char 7 count 103,896,979"> </span><span class=pc2 title="line 42 char 15 count 103,896,979">unbound</span><span class=pc2 title="line 42 char 7 count 103,896,979"> </span><span class=pc2 title="line 42 char 23 count 103,896,979">scope</span><span class=pc2 title="line 42 char 7 count 103,896,979"> </span><span class=pc2 title="line 42 char 29 count 103,896,979">counter</span><span class=pc2 title="line 42 char 7 count 103,896,979">)</span><span class=pc2 title="line 40 char 5 count 1">)</span><span class=pc2 title="line 39 char 3 count 1">)</span><span class=pc2 title="line 38 char 1 count 1">)</span>

; Vectors are not allowed as terms, so terms that are vectors
; are variables.
<span class=pc2 title="line 46 char 1 count 1">(define (var? x) </span><span class=pc12 title="line 46 char 18 count 5,668,281,872">(</span><span class=pc12 title="line 46 char 19 count 5,668,281,872">vector?</span><span class=pc12 title="line 46 char 18 count 5,668,281,872"> </span><span class=pc12 title="line 46 char 27 count 5,668,281,872">x</span><span class=pc12 title="line 46 char 18 count 5,668,281,872">)</span><span class=pc2 title="line 46 char 1 count 1">)</span>

<span class=pc2 title="line 48 char 1 count 1">(define var-eq? </span><span class=pc2 title="line 48 char 17 count 1">eq?</span><span class=pc2 title="line 48 char 1 count 1">)</span>

<span class=pc2 title="line 50 char 1 count 1">(define (var-val x)   </span><span class=pc6 title="line 50 char 23 count 1,106,066,104">(</span><span class=pc6 title="line 50 char 24 count 1,106,066,104">vector-ref</span><span class=pc6 title="line 50 char 23 count 1,106,066,104"> </span><span class=pc6 title="line 50 char 35 count 1,106,066,104">x</span><span class=pc6 title="line 50 char 23 count 1,106,066,104"> </span><span class=pc6 title="line 50 char 37 count 1,106,066,104">0</span><span class=pc6 title="line 50 char 23 count 1,106,066,104">)</span><span class=pc2 title="line 50 char 1 count 1">)</span>
<span class=pc2 title="line 51 char 1 count 1">(define (var-scope x) </span><span class=pc2 title="line 51 char 23 count 61,147,290">(</span><span class=pc2 title="line 51 char 24 count 61,147,290">vector-ref</span><span class=pc2 title="line 51 char 23 count 61,147,290"> </span><span class=pc2 title="line 51 char 35 count 61,147,290">x</span><span class=pc2 title="line 51 char 23 count 61,147,290"> </span><span class=pc2 title="line 51 char 37 count 61,147,290">1</span><span class=pc2 title="line 51 char 23 count 61,147,290">)</span><span class=pc2 title="line 51 char 1 count 1">)</span>
<span class=pc2 title="line 52 char 1 count 1">(define (var-idx x)   </span><span class=pc6 title="line 52 char 23 count 1,022,269,033">(</span><span class=pc6 title="line 52 char 24 count 1,022,269,033">vector-ref</span><span class=pc6 title="line 52 char 23 count 1,022,269,033"> </span><span class=pc6 title="line 52 char 35 count 1,022,269,033">x</span><span class=pc6 title="line 52 char 23 count 1,022,269,033"> </span><span class=pc6 title="line 52 char 37 count 1,022,269,033">2</span><span class=pc6 title="line 52 char 23 count 1,022,269,033">)</span><span class=pc2 title="line 52 char 1 count 1">)</span>

<span class=pc2 title="line 54 char 1 count 1">(define (set-var-val! x v)</span>
  <span class=pc2 title="line 55 char 3 count 33,505,413">(</span><span class=pc2 title="line 55 char 4 count 33,505,413">vector-set!</span><span class=pc2 title="line 55 char 3 count 33,505,413"> </span><span class=pc2 title="line 55 char 16 count 33,505,413">x</span><span class=pc2 title="line 55 char 3 count 33,505,413"> </span><span class=pc2 title="line 55 char 18 count 33,505,413">0</span><span class=pc2 title="line 55 char 3 count 33,505,413"> </span><span class=pc2 title="line 55 char 20 count 33,505,413">v</span><span class=pc2 title="line 55 char 3 count 33,505,413">)</span><span class=pc2 title="line 54 char 1 count 1">)</span>


; Substitution object.
; Contains:
;   map - mapping of variables to values
;   scope - scope at current program point, for set-var-val!
;     optimization. Updated at conde. Included in the substitution
;     because it is required to fully define the substitution
;     and how it is to be extended.
;
; Implementation of the substitution map depends on the Scheme used,
; as we need a map. See mk.rkt and mk-vicare.scm.

<span class=pc2 title="line 69 char 1 count 1">(define empty-subst-map </span><span class=pc2 title="line 69 char 25 count 1">empty-intmap</span><span class=pc2 title="line 69 char 1 count 1">)</span>
<span class=pc2 title="line 70 char 1 count 1">(define subst-map-length </span><span class=pc2 title="line 70 char 26 count 1">intmap-count</span><span class=pc2 title="line 70 char 1 count 1">)</span>
<span class=pc2 title="line 71 char 1 count 1">(define (subst-map-lookup u S)</span>
  <span class=pc5 title="line 72 char 3 count 824,366,986">(</span><span class=pc5 title="line 72 char 4 count 824,366,986">intmap-ref</span><span class=pc5 title="line 72 char 3 count 824,366,986"> </span><span class=pc5 title="line 72 char 15 count 824,366,986">S</span><span class=pc5 title="line 72 char 3 count 824,366,986"> </span><span class=pc5 title="line 72 char 17 count 824,366,986">(</span><span class=pc5 title="line 72 char 18 count 824,366,986">var-idx</span><span class=pc5 title="line 72 char 17 count 824,366,986"> </span><span class=pc5 title="line 72 char 26 count 824,366,986">u</span><span class=pc5 title="line 72 char 17 count 824,366,986">)</span><span class=pc5 title="line 72 char 3 count 824,366,986">)</span><span class=pc2 title="line 71 char 1 count 1">)</span>
<span class=pc2 title="line 73 char 1 count 1">(define (subst-map-add S var val)</span>
  <span class=pc2 title="line 74 char 3 count 27,641,855">(</span><span class=pc2 title="line 74 char 4 count 27,641,855">intmap-set</span><span class=pc2 title="line 74 char 3 count 27,641,855"> </span><span class=pc2 title="line 74 char 15 count 27,641,855">S</span><span class=pc2 title="line 74 char 3 count 27,641,855"> </span><span class=pc2 title="line 74 char 17 count 27,641,855">(</span><span class=pc2 title="line 74 char 18 count 27,641,855">var-idx</span><span class=pc2 title="line 74 char 17 count 27,641,855"> </span><span class=pc2 title="line 74 char 26 count 27,641,855">var</span><span class=pc2 title="line 74 char 17 count 27,641,855">)</span><span class=pc2 title="line 74 char 3 count 27,641,855"> </span><span class=pc2 title="line 74 char 31 count 27,641,855">val</span><span class=pc2 title="line 74 char 3 count 27,641,855">)</span><span class=pc2 title="line 73 char 1 count 1">)</span>

<span class=pc2 title="line 76 char 1 count 1">(define (subst mapping scope)</span>
  <span class=pc2 title="line 77 char 3 count 121,666,040">(</span><span class=pc2 title="line 77 char 4 count 121,666,040">cons</span><span class=pc2 title="line 77 char 3 count 121,666,040"> </span><span class=pc2 title="line 77 char 9 count 121,666,040">mapping</span><span class=pc2 title="line 77 char 3 count 121,666,040"> </span><span class=pc2 title="line 77 char 17 count 121,666,040">scope</span><span class=pc2 title="line 77 char 3 count 121,666,040">)</span><span class=pc2 title="line 76 char 1 count 1">)</span>

<span class=pc2 title="line 79 char 1 count 1">(define subst-map </span><span class=pc2 title="line 79 char 19 count 1">car</span><span class=pc2 title="line 79 char 1 count 1">)</span>
<span class=pc2 title="line 80 char 1 count 1">(define subst-scope </span><span class=pc2 title="line 80 char 21 count 1">cdr</span><span class=pc2 title="line 80 char 1 count 1">)</span>

<span class=pc2 title="line 82 char 1 count 1">(define (subst-length S)</span>
  <span class=pc2 title="line 83 char 3 count 2">(</span><span class=pc2 title="line 83 char 4 count 2">subst-map-length</span><span class=pc2 title="line 83 char 3 count 2"> </span><span class=pc2 title="line 83 char 21 count 2">(</span><span class=pc2 title="line 83 char 22 count 2">subst-map</span><span class=pc2 title="line 83 char 21 count 2"> </span><span class=pc2 title="line 83 char 32 count 2">S</span><span class=pc2 title="line 83 char 21 count 2">)</span><span class=pc2 title="line 83 char 3 count 2">)</span><span class=pc2 title="line 82 char 1 count 1">)</span>

<span class=pc2 title="line 85 char 1 count 1">(define (subst-with-scope S new-scope)</span>
  <span class=pc2 title="line 86 char 3 count 94,024,260">(</span><span class=pc2 title="line 86 char 4 count 94,024,260">subst</span><span class=pc2 title="line 86 char 3 count 94,024,260"> </span><span class=pc2 title="line 86 char 10 count 94,024,260">(</span><span class=pc2 title="line 86 char 11 count 94,024,260">subst-map</span><span class=pc2 title="line 86 char 10 count 94,024,260"> </span><span class=pc2 title="line 86 char 21 count 94,024,260">S</span><span class=pc2 title="line 86 char 10 count 94,024,260">)</span><span class=pc2 title="line 86 char 3 count 94,024,260"> </span><span class=pc2 title="line 86 char 24 count 94,024,260">new-scope</span><span class=pc2 title="line 86 char 3 count 94,024,260">)</span><span class=pc2 title="line 85 char 1 count 1">)</span>

<span class=pc2 title="line 88 char 1 count 1">(define empty-subst </span><span class=pc2 title="line 88 char 21 count 1">(</span><span class=pc2 title="line 88 char 22 count 1">subst</span><span class=pc2 title="line 88 char 21 count 1"> </span><span class=pc2 title="line 88 char 28 count 1">empty-subst-map</span><span class=pc2 title="line 88 char 21 count 1"> </span><span class=pc2 title="line 88 char 44 count 1">(</span><span class=pc2 title="line 88 char 45 count 1">new-scope</span><span class=pc2 title="line 88 char 44 count 1">)</span><span class=pc2 title="line 88 char 21 count 1">)</span><span class=pc2 title="line 88 char 1 count 1">)</span>

<span class=pc2 title="line 90 char 1 count 1">(define (subst-add S x v)</span>
  <span class=pc2 title="line 90 char 1 count 1">; set-var-val! optimization: set the value directly on the</span>
  <span class=pc2 title="line 90 char 1 count 1">; variable object if we haven't branched since its creation</span>
  <span class=pc2 title="line 90 char 1 count 1">; (the scope of the variable and the substitution are the same).</span>
  <span class=pc2 title="line 90 char 1 count 1">; Otherwise extend the substitution mapping.</span>
  <span class=pc2 title="line 95 char 3 count 61,147,290">(if </span><span class=pc2 title="line 95 char 7 count 61,147,290">(</span><span class=pc2 title="line 95 char 8 count 61,147,290">scope-eq?</span><span class=pc2 title="line 95 char 7 count 61,147,290"> </span><span class=pc2 title="line 95 char 18 count 61,147,290">(</span><span class=pc2 title="line 95 char 19 count 61,147,290">var-scope</span><span class=pc2 title="line 95 char 18 count 61,147,290"> </span><span class=pc2 title="line 95 char 29 count 61,147,290">x</span><span class=pc2 title="line 95 char 18 count 61,147,290">)</span><span class=pc2 title="line 95 char 7 count 61,147,290"> </span><span class=pc2 title="line 95 char 32 count 61,147,290">(</span><span class=pc2 title="line 95 char 33 count 61,147,290">subst-scope</span><span class=pc2 title="line 95 char 32 count 61,147,290"> </span><span class=pc2 title="line 95 char 45 count 61,147,290">S</span><span class=pc2 title="line 95 char 32 count 61,147,290">)</span><span class=pc2 title="line 95 char 7 count 61,147,290">)</span>
    <span class=pc2 title="line 96 char 5 count 33,505,413">(begin </span><span class=pc2 title="line 96 char 12 count 33,505,413">(</span><span class=pc2 title="line 96 char 13 count 33,505,413">set-var-val!</span><span class=pc2 title="line 96 char 12 count 33,505,413"> </span><span class=pc2 title="line 96 char 26 count 33,505,413">x</span><span class=pc2 title="line 96 char 12 count 33,505,413"> </span><span class=pc2 title="line 96 char 28 count 33,505,413">v</span><span class=pc2 title="line 96 char 12 count 33,505,413">)</span>
           <span class=pc2 title="line 97 char 12 count 33,505,413">S</span><span class=pc2 title="line 96 char 5 count 33,505,413">)</span>
    <span class=pc2 title="line 98 char 5 count 27,641,877">(</span><span class=pc2 title="line 98 char 6 count 27,641,877">subst</span><span class=pc2 title="line 98 char 5 count 27,641,877"> </span><span class=pc2 title="line 98 char 12 count 27,641,877">(</span><span class=pc2 title="line 98 char 13 count 27,641,877">subst-map-add</span><span class=pc2 title="line 98 char 12 count 27,641,877"> </span><span class=pc2 title="line 98 char 27 count 27,641,877">(</span><span class=pc2 title="line 98 char 28 count 27,641,877">subst-map</span><span class=pc2 title="line 98 char 27 count 27,641,877"> </span><span class=pc2 title="line 98 char 38 count 27,641,877">S</span><span class=pc2 title="line 98 char 27 count 27,641,877">)</span><span class=pc2 title="line 98 char 12 count 27,641,877"> </span><span class=pc2 title="line 98 char 41 count 27,641,877">x</span><span class=pc2 title="line 98 char 12 count 27,641,877"> </span><span class=pc2 title="line 98 char 43 count 27,641,877">v</span><span class=pc2 title="line 98 char 12 count 27,641,877">)</span><span class=pc2 title="line 98 char 5 count 27,641,877"> </span><span class=pc2 title="line 98 char 46 count 27,641,877">(</span><span class=pc2 title="line 98 char 47 count 27,641,877">subst-scope</span><span class=pc2 title="line 98 char 46 count 27,641,877"> </span><span class=pc2 title="line 98 char 59 count 27,641,877">S</span><span class=pc2 title="line 98 char 46 count 27,641,877">)</span><span class=pc2 title="line 98 char 5 count 27,641,877">)</span><span class=pc2 title="line 95 char 3 count 61,147,290">)</span><span class=pc2 title="line 90 char 1 count 1">)</span>

<span class=pc2 title="line 100 char 1 count 1">(define (subst-lookup x S)</span>
  <span class=pc2 title="line 100 char 1 count 1">; set-var-val! optimization.</span>
  <span class=pc2 title="line 100 char 1 count 1">; Tried checking the scope here to avoid a subst-map-lookup</span>
  <span class=pc2 title="line 100 char 1 count 1">; if it was definitely unbound, but that was slower.</span>
  <span class=pc6 title="line 104 char 3 count 965,216,840">(if </span><span class=pc6 title="line 104 char 7 count 965,216,840">(</span><span class=pc6 title="line 104 char 8 count 965,216,840">not</span><span class=pc6 title="line 104 char 7 count 965,216,840"> </span><span class=pc6 title="line 104 char 12 count 965,216,840">(</span><span class=pc6 title="line 104 char 13 count 965,216,840">unbound?</span><span class=pc6 title="line 104 char 12 count 965,216,840"> </span><span class=pc6 title="line 104 char 22 count 965,216,840">(</span><span class=pc6 title="line 104 char 23 count 965,216,840">var-val</span><span class=pc6 title="line 104 char 22 count 965,216,840"> </span><span class=pc6 title="line 104 char 31 count 965,216,840">x</span><span class=pc6 title="line 104 char 22 count 965,216,840">)</span><span class=pc6 title="line 104 char 12 count 965,216,840">)</span><span class=pc6 title="line 104 char 7 count 965,216,840">)</span>
    <span class=pc2 title="line 105 char 5 count 140,849,264">(</span><span class=pc2 title="line 105 char 6 count 140,849,264">var-val</span><span class=pc2 title="line 105 char 5 count 140,849,264"> </span><span class=pc2 title="line 105 char 14 count 140,849,264">x</span><span class=pc2 title="line 105 char 5 count 140,849,264">)</span>
    <span class=pc5 title="line 106 char 5 count 824,367,576">(</span><span class=pc5 title="line 106 char 6 count 824,367,576">subst-map-lookup</span><span class=pc5 title="line 106 char 5 count 824,367,576"> </span><span class=pc5 title="line 106 char 23 count 824,367,576">x</span><span class=pc5 title="line 106 char 5 count 824,367,576"> </span><span class=pc5 title="line 106 char 25 count 824,367,576">(</span><span class=pc5 title="line 106 char 26 count 824,367,576">subst-map</span><span class=pc5 title="line 106 char 25 count 824,367,576"> </span><span class=pc5 title="line 106 char 36 count 824,367,576">S</span><span class=pc5 title="line 106 char 25 count 824,367,576">)</span><span class=pc5 title="line 106 char 5 count 824,367,576">)</span><span class=pc6 title="line 104 char 3 count 965,216,840">)</span><span class=pc2 title="line 100 char 1 count 1">)</span>

; Association object.
; Describes an association mapping the lhs to the rhs. Returned by
; unification to describe the associations that were added to the
; substitution (whose representation is opaque) and used to represent
; disequality constraints.
<span class=pc2 title="line 113 char 1 count 1">(define lhs </span><span class=pc2 title="line 113 char 13 count 1">car</span><span class=pc2 title="line 113 char 1 count 1">)</span>
<span class=pc2 title="line 114 char 1 count 1">(define rhs </span><span class=pc2 title="line 114 char 13 count 1">cdr</span><span class=pc2 title="line 114 char 1 count 1">)</span>

; Constraint record object.
;
; Describes the constraints attached to a single variable.
;
; Contains:
;   T - type constraint. instance of type-constraint or #f to indicate
;         no constraint
;   D - list of disequality constraints. Each disequality is a list of
;         associations. The constraint is violated if all associated
;         variables are equal in the substitution simultaneously. D
;         could contain duplicate constraints (created by distinct =/=
;         calls). A given disequality constraint is only attached to
;         one of the variables involved, as all components of the
;         constraint must be violated to cause failure.
;   A - list of absento constraints. Each constraint is a term.
;         The list contains no duplicates.

<span class=pc2 title="line 133 char 1 count 1">(define empty-c </span><span class=pc2 title="line 133 char 17 count 1">'(#f () ())</span><span class=pc2 title="line 133 char 1 count 1">)</span>

<span class=pc2 title="line 135 char 1 count 1">(define (c-T c) </span><span class=pc2 title="line 135 char 17 count 38,917,115">(</span><span class=pc2 title="line 135 char 18 count 38,917,115">car</span><span class=pc2 title="line 135 char 17 count 38,917,115"> </span><span class=pc2 title="line 135 char 22 count 38,917,115">c</span><span class=pc2 title="line 135 char 17 count 38,917,115">)</span><span class=pc2 title="line 135 char 1 count 1">)</span>
<span class=pc2 title="line 136 char 1 count 1">(define (c-D c) </span><span class=pc2 title="line 136 char 17 count 35,409,332">(</span><span class=pc2 title="line 136 char 18 count 35,409,332">cadr</span><span class=pc2 title="line 136 char 17 count 35,409,332"> </span><span class=pc2 title="line 136 char 23 count 35,409,332">c</span><span class=pc2 title="line 136 char 17 count 35,409,332">)</span><span class=pc2 title="line 136 char 1 count 1">)</span>
<span class=pc2 title="line 137 char 1 count 1">(define (c-A c) </span><span class=pc2 title="line 137 char 17 count 36,711,377">(</span><span class=pc2 title="line 137 char 18 count 36,711,377">caddr</span><span class=pc2 title="line 137 char 17 count 36,711,377"> </span><span class=pc2 title="line 137 char 24 count 36,711,377">c</span><span class=pc2 title="line 137 char 17 count 36,711,377">)</span><span class=pc2 title="line 137 char 1 count 1">)</span>

<span class=pc2 title="line 139 char 1 count 1">(define (c-with-T c T) </span><span class=pc2 title="line 139 char 24 count 1,047,701">(</span><span class=pc2 title="line 139 char 25 count 1,047,701">list</span><span class=pc2 title="line 139 char 24 count 1,047,701"> </span><span class=pc2 title="line 139 char 30 count 1,047,701">T</span><span class=pc2 title="line 139 char 24 count 1,047,701"> </span><span class=pc2 title="line 139 char 32 count 1,047,701">(</span><span class=pc2 title="line 139 char 33 count 1,047,701">c-D</span><span class=pc2 title="line 139 char 32 count 1,047,701"> </span><span class=pc2 title="line 139 char 37 count 1,047,701">c</span><span class=pc2 title="line 139 char 32 count 1,047,701">)</span><span class=pc2 title="line 139 char 24 count 1,047,701"> </span><span class=pc2 title="line 139 char 40 count 1,047,701">(</span><span class=pc2 title="line 139 char 41 count 1,047,701">c-A</span><span class=pc2 title="line 139 char 40 count 1,047,701"> </span><span class=pc2 title="line 139 char 45 count 1,047,701">c</span><span class=pc2 title="line 139 char 40 count 1,047,701">)</span><span class=pc2 title="line 139 char 24 count 1,047,701">)</span><span class=pc2 title="line 139 char 1 count 1">)</span>
<span class=pc2 title="line 140 char 1 count 1">(define (c-with-D c D) </span><span class=pc2 title="line 140 char 24 count 17,941,941">(</span><span class=pc2 title="line 140 char 25 count 17,941,941">list</span><span class=pc2 title="line 140 char 24 count 17,941,941"> </span><span class=pc2 title="line 140 char 30 count 17,941,941">(</span><span class=pc2 title="line 140 char 31 count 17,941,941">c-T</span><span class=pc2 title="line 140 char 30 count 17,941,941"> </span><span class=pc2 title="line 140 char 35 count 17,941,941">c</span><span class=pc2 title="line 140 char 30 count 17,941,941">)</span><span class=pc2 title="line 140 char 24 count 17,941,941"> </span><span class=pc2 title="line 140 char 38 count 17,941,941">D</span><span class=pc2 title="line 140 char 24 count 17,941,941"> </span><span class=pc2 title="line 140 char 40 count 17,941,941">(</span><span class=pc2 title="line 140 char 41 count 17,941,941">c-A</span><span class=pc2 title="line 140 char 40 count 17,941,941"> </span><span class=pc2 title="line 140 char 45 count 17,941,941">c</span><span class=pc2 title="line 140 char 40 count 17,941,941">)</span><span class=pc2 title="line 140 char 24 count 17,941,941">)</span><span class=pc2 title="line 140 char 1 count 1">)</span>
<span class=pc2 title="line 141 char 1 count 1">(define (c-with-A c A) </span><span class=pc2 title="line 141 char 24 count 12,021,258">(</span><span class=pc2 title="line 141 char 25 count 12,021,258">list</span><span class=pc2 title="line 141 char 24 count 12,021,258"> </span><span class=pc2 title="line 141 char 30 count 12,021,258">(</span><span class=pc2 title="line 141 char 31 count 12,021,258">c-T</span><span class=pc2 title="line 141 char 30 count 12,021,258"> </span><span class=pc2 title="line 141 char 35 count 12,021,258">c</span><span class=pc2 title="line 141 char 30 count 12,021,258">)</span><span class=pc2 title="line 141 char 24 count 12,021,258"> </span><span class=pc2 title="line 141 char 38 count 12,021,258">(</span><span class=pc2 title="line 141 char 39 count 12,021,258">c-D</span><span class=pc2 title="line 141 char 38 count 12,021,258"> </span><span class=pc2 title="line 141 char 43 count 12,021,258">c</span><span class=pc2 title="line 141 char 38 count 12,021,258">)</span><span class=pc2 title="line 141 char 24 count 12,021,258"> </span><span class=pc2 title="line 141 char 46 count 12,021,258">A</span><span class=pc2 title="line 141 char 24 count 12,021,258">)</span><span class=pc2 title="line 141 char 1 count 1">)</span>

; Constraint store object.
; Mapping of representative variable to constraint record. Constraints
; are always on the representative element and must be moved / merged
; when that element changes.

<span class=pc2 title="line 148 char 1 count 1">(define empty-C </span><span class=pc2 title="line 148 char 17 count 1">empty-intmap</span><span class=pc2 title="line 148 char 1 count 1">)</span>

<span class=pc2 title="line 150 char 1 count 1">(define (set-c st x c)</span>
  <span class=pc2 title="line 151 char 3 count 31,010,881">(</span><span class=pc2 title="line 151 char 4 count 31,010,881">state-with-C</span>
    <span class=pc2 title="line 152 char 5 count 31,010,037">(</span><span class=pc2 title="line 152 char 6 count 31,010,037">set-v</span><span class=pc2 title="line 152 char 5 count 31,010,037"> </span><span class=pc2 title="line 152 char 12 count 31,010,037">st</span><span class=pc2 title="line 152 char 5 count 31,010,037"> </span><span class=pc2 title="line 152 char 15 count 31,010,037">x</span><span class=pc2 title="line 152 char 5 count 31,010,037">)</span>
    <span class=pc2 title="line 153 char 5 count 31,010,881">(</span><span class=pc2 title="line 153 char 6 count 31,010,881">intmap-set</span><span class=pc2 title="line 153 char 5 count 31,010,881"> </span><span class=pc2 title="line 153 char 17 count 31,010,881">(</span><span class=pc2 title="line 153 char 18 count 31,010,881">state-C</span><span class=pc2 title="line 153 char 17 count 31,010,881"> </span><span class=pc2 title="line 153 char 26 count 31,010,881">st</span><span class=pc2 title="line 153 char 17 count 31,010,881">)</span><span class=pc2 title="line 153 char 5 count 31,010,881"> </span><span class=pc2 title="line 153 char 30 count 31,010,881">(</span><span class=pc2 title="line 153 char 31 count 31,010,881">var-idx</span><span class=pc2 title="line 153 char 30 count 31,010,881"> </span><span class=pc2 title="line 153 char 39 count 31,010,881">x</span><span class=pc2 title="line 153 char 30 count 31,010,881">)</span><span class=pc2 title="line 153 char 5 count 31,010,881"> </span><span class=pc2 title="line 153 char 42 count 31,010,881">c</span><span class=pc2 title="line 153 char 5 count 31,010,881">)</span><span class=pc2 title="line 151 char 3 count 31,010,881">)</span><span class=pc2 title="line 150 char 1 count 1">)</span>

<span class=pc2 title="line 155 char 1 count 1">(define (lookup-c st x)</span>
  <span class=pc2 title="line 156 char 3 count 76,185,502">(let ((res </span><span class=pc2 title="line 156 char 14 count 76,185,502">(</span><span class=pc2 title="line 156 char 15 count 76,185,502">intmap-ref</span><span class=pc2 title="line 156 char 14 count 76,185,502"> </span><span class=pc2 title="line 156 char 26 count 76,185,502">(</span><span class=pc2 title="line 156 char 27 count 76,185,502">state-C</span><span class=pc2 title="line 156 char 26 count 76,185,502"> </span><span class=pc2 title="line 156 char 35 count 76,185,502">st</span><span class=pc2 title="line 156 char 26 count 76,185,502">)</span><span class=pc2 title="line 156 char 14 count 76,185,502"> </span><span class=pc2 title="line 156 char 39 count 76,185,502">(</span><span class=pc2 title="line 156 char 40 count 76,185,502">var-idx</span><span class=pc2 title="line 156 char 39 count 76,185,502"> </span><span class=pc2 title="line 156 char 48 count 76,185,502">x</span><span class=pc2 title="line 156 char 39 count 76,185,502">)</span><span class=pc2 title="line 156 char 14 count 76,185,502">)</span><span class=pc2 title="line 156 char 3 count 76,185,502">))</span>
    <span class=pc2 title="line 157 char 5 count 76,185,287">(if </span><span class=pc2 title="line 157 char 9 count 76,185,287">(</span><span class=pc2 title="line 157 char 10 count 76,185,287">unbound?</span><span class=pc2 title="line 157 char 9 count 76,185,287"> </span><span class=pc2 title="line 157 char 19 count 76,185,287">res</span><span class=pc2 title="line 157 char 9 count 76,185,287">)</span>
      <span class=pc2 title="line 158 char 7 count 40,864,969">empty-c</span>
      <span class=pc2 title="line 159 char 7 count 35,320,318">res</span><span class=pc2 title="line 157 char 5 count 76,185,287">)</span><span class=pc2 title="line 156 char 3 count 76,185,502">)</span><span class=pc2 title="line 155 char 1 count 1">)</span>

; t:unbind in mk-vicare.scm either is buggy or doesn't do what I would expect, so
; I implement remove by setting the value to the empty constraint record.
<span class=pc2 title="line 163 char 1 count 1">(define (remove-c x st)</span>
  <span class=pc2 title="line 164 char 3 count 4,398,526">(</span><span class=pc2 title="line 164 char 4 count 4,398,526">state-with-C</span><span class=pc2 title="line 164 char 3 count 4,398,526"> </span><span class=pc2 title="line 164 char 17 count 4,398,526">st</span><span class=pc2 title="line 164 char 3 count 4,398,526"> </span><span class=pc2 title="line 164 char 20 count 4,398,526">(</span><span class=pc2 title="line 164 char 21 count 4,398,526">intmap-set</span><span class=pc2 title="line 164 char 20 count 4,398,526"> </span><span class=pc2 title="line 164 char 32 count 4,398,526">(</span><span class=pc2 title="line 164 char 33 count 4,398,526">state-C</span><span class=pc2 title="line 164 char 32 count 4,398,526"> </span><span class=pc2 title="line 164 char 41 count 4,398,526">st</span><span class=pc2 title="line 164 char 32 count 4,398,526">)</span><span class=pc2 title="line 164 char 20 count 4,398,526"> </span><span class=pc2 title="line 164 char 45 count 4,398,526">(</span><span class=pc2 title="line 164 char 46 count 4,398,526">var-idx</span><span class=pc2 title="line 164 char 45 count 4,398,526"> </span><span class=pc2 title="line 164 char 54 count 4,398,526">x</span><span class=pc2 title="line 164 char 45 count 4,398,526">)</span><span class=pc2 title="line 164 char 20 count 4,398,526"> </span><span class=pc2 title="line 164 char 57 count 4,398,526">empty-c</span><span class=pc2 title="line 164 char 20 count 4,398,526">)</span><span class=pc2 title="line 164 char 3 count 4,398,526">)</span><span class=pc2 title="line 163 char 1 count 1">)</span>


;; WEB June 4 02023 -- State object code has been moved to
;; `mk-underconstraints.scm`


; Unification

; UnificationResult: (or/c (values Substitution (Listof Association))
;                          (values #f #f)
; An extended substitution and a list of associations added during the unification,
;  or (values #f #f) indicating unification failed.

; Term, Term, Substitution -&gt; UnificationResult
<span class=pc2 title="line 179 char 1 count 1">(define (unify u v s)</span>
  <span class=pc3 title="line 180 char 3 count 317,283,112">(let ((u </span><span class=pc3 title="line 180 char 12 count 317,282,718">(</span><span class=pc3 title="line 180 char 13 count 317,282,718">walk</span><span class=pc3 title="line 180 char 12 count 317,282,718"> </span><span class=pc3 title="line 180 char 18 count 317,282,718">u</span><span class=pc3 title="line 180 char 12 count 317,282,718"> </span><span class=pc3 title="line 180 char 20 count 317,282,718">s</span><span class=pc3 title="line 180 char 12 count 317,282,718">)</span><span class=pc3 title="line 180 char 3 count 317,283,112">)</span>
        <span class=pc3 title="line 180 char 3 count 317,283,112">(v </span><span class=pc3 title="line 181 char 12 count 317,283,112">(</span><span class=pc3 title="line 181 char 13 count 317,283,112">walk</span><span class=pc3 title="line 181 char 12 count 317,283,112"> </span><span class=pc3 title="line 181 char 18 count 317,283,112">v</span><span class=pc3 title="line 181 char 12 count 317,283,112"> </span><span class=pc3 title="line 181 char 20 count 317,283,112">s</span><span class=pc3 title="line 181 char 12 count 317,283,112">)</span><span class=pc3 title="line 180 char 3 count 317,283,112">))</span>
    <span class=pc3 title="line 182 char 5 count 317,282,254">(cond</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc3 title="line 183 char 8 count 317,282,254">(</span><span class=pc3 title="line 183 char 9 count 317,282,254">eq?</span><span class=pc3 title="line 183 char 8 count 317,282,254"> </span><span class=pc3 title="line 183 char 13 count 317,282,254">u</span><span class=pc3 title="line 183 char 8 count 317,282,254"> </span><span class=pc3 title="line 183 char 15 count 317,282,254">v</span><span class=pc3 title="line 183 char 8 count 317,282,254">)</span><span class=pc3 title="line 182 char 5 count 317,282,254"> </span><span class=pc2 title="line 183 char 18 count 43,894,251">(</span><span class=pc2 title="line 183 char 19 count 43,894,251">values</span><span class=pc2 title="line 183 char 18 count 43,894,251"> </span><span class=pc2 title="line 183 char 26 count 43,894,251">s</span><span class=pc2 title="line 183 char 18 count 43,894,251"> </span><span class=pc2 title="line 183 char 28 count 43,894,251">'()</span><span class=pc2 title="line 183 char 18 count 43,894,251">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc3 title="line 184 char 8 count 273,388,003">(and </span><span class=pc3 title="line 184 char 13 count 273,388,003">(</span><span class=pc3 title="line 184 char 14 count 273,388,003">var?</span><span class=pc3 title="line 184 char 13 count 273,388,003"> </span><span class=pc3 title="line 184 char 19 count 273,388,003">u</span><span class=pc3 title="line 184 char 13 count 273,388,003">)</span><span class=pc3 title="line 184 char 8 count 273,388,003"> </span><span class=pc2 title="line 184 char 22 count 41,738,094">(</span><span class=pc2 title="line 184 char 23 count 41,738,094">var?</span><span class=pc2 title="line 184 char 22 count 41,738,094"> </span><span class=pc2 title="line 184 char 28 count 41,738,094">v</span><span class=pc2 title="line 184 char 22 count 41,738,094">)</span><span class=pc3 title="line 184 char 8 count 273,388,003">)</span>
       <span class=pc2 title="line 185 char 8 count 3,337,357">(if </span><span class=pc2 title="line 185 char 12 count 3,337,357">(</span><span class=pc2 title="line 185 char 13 count 3,337,357">&gt;</span><span class=pc2 title="line 185 char 12 count 3,337,357"> </span><span class=pc2 title="line 185 char 15 count 3,337,357">(</span><span class=pc2 title="line 185 char 16 count 3,337,357">var-idx</span><span class=pc2 title="line 185 char 15 count 3,337,357"> </span><span class=pc2 title="line 185 char 24 count 3,337,357">u</span><span class=pc2 title="line 185 char 15 count 3,337,357">)</span><span class=pc2 title="line 185 char 12 count 3,337,357"> </span><span class=pc2 title="line 185 char 27 count 3,337,357">(</span><span class=pc2 title="line 185 char 28 count 3,337,357">var-idx</span><span class=pc2 title="line 185 char 27 count 3,337,357"> </span><span class=pc2 title="line 185 char 36 count 3,337,357">v</span><span class=pc2 title="line 185 char 27 count 3,337,357">)</span><span class=pc2 title="line 185 char 12 count 3,337,357">)</span>
         <span class=pc2 title="line 186 char 10 count 3,163,417">(</span><span class=pc2 title="line 186 char 11 count 3,163,417">ext-s-check</span><span class=pc2 title="line 186 char 10 count 3,163,417"> </span><span class=pc2 title="line 186 char 23 count 3,163,417">u</span><span class=pc2 title="line 186 char 10 count 3,163,417"> </span><span class=pc2 title="line 186 char 25 count 3,163,417">v</span><span class=pc2 title="line 186 char 10 count 3,163,417"> </span><span class=pc2 title="line 186 char 27 count 3,163,417">s</span><span class=pc2 title="line 186 char 10 count 3,163,417">)</span>
         <span class=pc2 title="line 187 char 10 count 173,940">(</span><span class=pc2 title="line 187 char 11 count 173,940">ext-s-check</span><span class=pc2 title="line 187 char 10 count 173,940"> </span><span class=pc2 title="line 187 char 23 count 173,940">v</span><span class=pc2 title="line 187 char 10 count 173,940"> </span><span class=pc2 title="line 187 char 25 count 173,940">u</span><span class=pc2 title="line 187 char 10 count 173,940"> </span><span class=pc2 title="line 187 char 27 count 173,940">s</span><span class=pc2 title="line 187 char 10 count 173,940">)</span><span class=pc2 title="line 185 char 8 count 3,337,357">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc3 title="line 188 char 8 count 270,050,646">(</span><span class=pc3 title="line 188 char 9 count 270,050,646">var?</span><span class=pc3 title="line 188 char 8 count 270,050,646"> </span><span class=pc3 title="line 188 char 14 count 270,050,646">u</span><span class=pc3 title="line 188 char 8 count 270,050,646">)</span><span class=pc3 title="line 182 char 5 count 317,282,254"> </span><span class=pc2 title="line 188 char 17 count 38,400,737">(</span><span class=pc2 title="line 188 char 18 count 38,400,737">ext-s-check</span><span class=pc2 title="line 188 char 17 count 38,400,737"> </span><span class=pc2 title="line 188 char 30 count 38,400,737">u</span><span class=pc2 title="line 188 char 17 count 38,400,737"> </span><span class=pc2 title="line 188 char 32 count 38,400,737">v</span><span class=pc2 title="line 188 char 17 count 38,400,737"> </span><span class=pc2 title="line 188 char 34 count 38,400,737">s</span><span class=pc2 title="line 188 char 17 count 38,400,737">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc3 title="line 189 char 8 count 231,649,909">(</span><span class=pc3 title="line 189 char 9 count 231,649,909">var?</span><span class=pc3 title="line 189 char 8 count 231,649,909"> </span><span class=pc3 title="line 189 char 14 count 231,649,909">v</span><span class=pc3 title="line 189 char 8 count 231,649,909">)</span><span class=pc3 title="line 182 char 5 count 317,282,254"> </span><span class=pc2 title="line 189 char 17 count 19,472,222">(</span><span class=pc2 title="line 189 char 18 count 19,472,222">ext-s-check</span><span class=pc2 title="line 189 char 17 count 19,472,222"> </span><span class=pc2 title="line 189 char 30 count 19,472,222">v</span><span class=pc2 title="line 189 char 17 count 19,472,222"> </span><span class=pc2 title="line 189 char 32 count 19,472,222">u</span><span class=pc2 title="line 189 char 17 count 19,472,222"> </span><span class=pc2 title="line 189 char 34 count 19,472,222">s</span><span class=pc2 title="line 189 char 17 count 19,472,222">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc3 title="line 190 char 8 count 212,177,687">(and </span><span class=pc3 title="line 190 char 13 count 212,177,687">(</span><span class=pc3 title="line 190 char 14 count 212,177,687">pair?</span><span class=pc3 title="line 190 char 13 count 212,177,687"> </span><span class=pc3 title="line 190 char 20 count 212,177,687">u</span><span class=pc3 title="line 190 char 13 count 212,177,687">)</span><span class=pc3 title="line 190 char 8 count 212,177,687"> </span><span class=pc2 title="line 190 char 23 count 131,905,350">(</span><span class=pc2 title="line 190 char 24 count 131,905,350">pair?</span><span class=pc2 title="line 190 char 23 count 131,905,350"> </span><span class=pc2 title="line 190 char 30 count 131,905,350">v</span><span class=pc2 title="line 190 char 23 count 131,905,350">)</span><span class=pc3 title="line 190 char 8 count 212,177,687">)</span>
       <span class=pc2 title="line 191 char 8 count 117,476,443">(let-values (((s added-car) </span><span class=pc2 title="line 191 char 36 count 117,476,443">(</span><span class=pc2 title="line 191 char 37 count 117,476,443">unify</span><span class=pc2 title="line 191 char 36 count 117,476,443"> </span><span class=pc2 title="line 191 char 43 count 117,476,443">(</span><span class=pc2 title="line 191 char 44 count 117,476,443">car</span><span class=pc2 title="line 191 char 43 count 117,476,443"> </span><span class=pc2 title="line 191 char 48 count 117,476,443">u</span><span class=pc2 title="line 191 char 43 count 117,476,443">)</span><span class=pc2 title="line 191 char 36 count 117,476,443"> </span><span class=pc2 title="line 191 char 51 count 117,476,443">(</span><span class=pc2 title="line 191 char 52 count 117,476,443">car</span><span class=pc2 title="line 191 char 51 count 117,476,443"> </span><span class=pc2 title="line 191 char 56 count 117,476,443">v</span><span class=pc2 title="line 191 char 51 count 117,476,443">)</span><span class=pc2 title="line 191 char 36 count 117,476,443"> </span><span class=pc2 title="line 191 char 59 count 117,476,443">s</span><span class=pc2 title="line 191 char 36 count 117,476,443">)</span><span class=pc2 title="line 191 char 8 count 117,476,443">))</span>
         <span class=pc2 title="line 192 char 10 count 117,472,618">(if </span><span class=pc2 title="line 192 char 14 count 117,472,618">s</span>
           <span class=pc2 title="line 193 char 12 count 50,737,992">(let-values (((s added-cdr) </span><span class=pc2 title="line 193 char 40 count 50,737,992">(</span><span class=pc2 title="line 193 char 41 count 50,737,992">unify</span><span class=pc2 title="line 193 char 40 count 50,737,992"> </span><span class=pc2 title="line 193 char 47 count 50,737,992">(</span><span class=pc2 title="line 193 char 48 count 50,737,992">cdr</span><span class=pc2 title="line 193 char 47 count 50,737,992"> </span><span class=pc2 title="line 193 char 52 count 50,737,992">u</span><span class=pc2 title="line 193 char 47 count 50,737,992">)</span><span class=pc2 title="line 193 char 40 count 50,737,992"> </span><span class=pc2 title="line 193 char 55 count 50,737,992">(</span><span class=pc2 title="line 193 char 56 count 50,737,992">cdr</span><span class=pc2 title="line 193 char 55 count 50,737,992"> </span><span class=pc2 title="line 193 char 60 count 50,737,992">v</span><span class=pc2 title="line 193 char 55 count 50,737,992">)</span><span class=pc2 title="line 193 char 40 count 50,737,992"> </span><span class=pc2 title="line 193 char 63 count 50,737,992">s</span><span class=pc2 title="line 193 char 40 count 50,737,992">)</span><span class=pc2 title="line 193 char 12 count 50,737,992">))</span>
             <span class=pc2 title="line 193 char 12 count 50,737,992">; Right now appends the list of added values from sub-unifications.</span>
             <span class=pc2 title="line 193 char 12 count 50,737,992">; Alternatively could be threaded monadically, which could be faster</span>
             <span class=pc2 title="line 193 char 12 count 50,737,992">; or slower.</span>
             <span class=pc2 title="line 197 char 14 count 50,731,511">(</span><span class=pc2 title="line 197 char 15 count 50,731,511">values</span><span class=pc2 title="line 197 char 14 count 50,731,511"> </span><span class=pc2 title="line 197 char 22 count 50,731,511">s</span><span class=pc2 title="line 197 char 14 count 50,731,511"> </span><span class=pc2 title="line 197 char 24 count 50,731,511">(</span><span class=pc2 title="line 197 char 25 count 50,731,511">append</span><span class=pc2 title="line 197 char 24 count 50,731,511"> </span><span class=pc2 title="line 197 char 32 count 50,731,511">added-car</span><span class=pc2 title="line 197 char 24 count 50,731,511"> </span><span class=pc2 title="line 197 char 42 count 50,731,511">added-cdr</span><span class=pc2 title="line 197 char 24 count 50,731,511">)</span><span class=pc2 title="line 197 char 14 count 50,731,511">)</span><span class=pc2 title="line 193 char 12 count 50,737,992">)</span>
           <span class=pc2 title="line 198 char 12 count 66,734,626">(</span><span class=pc2 title="line 198 char 13 count 66,734,626">values</span><span class=pc2 title="line 198 char 12 count 66,734,626"> </span><span class=pc2 title="line 198 char 20 count 66,734,626">#f</span><span class=pc2 title="line 198 char 12 count 66,734,626"> </span><span class=pc2 title="line 198 char 23 count 66,734,626">#f</span><span class=pc2 title="line 198 char 12 count 66,734,626">)</span><span class=pc2 title="line 192 char 10 count 117,472,618">)</span><span class=pc2 title="line 191 char 8 count 117,476,443">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(</span><span class=pc2 title="line 199 char 8 count 94,701,244">(</span><span class=pc2 title="line 199 char 9 count 94,701,244">equal?</span><span class=pc2 title="line 199 char 8 count 94,701,244"> </span><span class=pc2 title="line 199 char 16 count 94,701,244">u</span><span class=pc2 title="line 199 char 8 count 94,701,244"> </span><span class=pc2 title="line 199 char 18 count 94,701,244">v</span><span class=pc2 title="line 199 char 8 count 94,701,244">)</span><span class=pc3 title="line 182 char 5 count 317,282,254"> </span><span class=pc1 title="line 199 char 21 count 0">(</span><span class=pc1 title="line 199 char 22 count 0">values</span><span class=pc1 title="line 199 char 21 count 0"> </span><span class=pc1 title="line 199 char 29 count 0">s</span><span class=pc1 title="line 199 char 21 count 0"> </span><span class=pc1 title="line 199 char 31 count 0">'()</span><span class=pc1 title="line 199 char 21 count 0">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">)</span>
      <span class=pc3 title="line 182 char 5 count 317,282,254">(else </span><span class=pc2 title="line 200 char 13 count 94,701,149">(</span><span class=pc2 title="line 200 char 14 count 94,701,149">values</span><span class=pc2 title="line 200 char 13 count 94,701,149"> </span><span class=pc2 title="line 200 char 21 count 94,701,149">#f</span><span class=pc2 title="line 200 char 13 count 94,701,149"> </span><span class=pc2 title="line 200 char 24 count 94,701,149">#f</span><span class=pc2 title="line 200 char 13 count 94,701,149">)</span><span class=pc3 title="line 182 char 5 count 317,282,254">))</span><span class=pc3 title="line 180 char 3 count 317,283,112">)</span><span class=pc2 title="line 179 char 1 count 1">)</span>

; Term, Substitution -&gt; Term
<span class=pc2 title="line 203 char 1 count 1">(define (walk u S)</span>
  <span class=pc10 title="line 204 char 3 count 2,484,246,639">(let rec ((u </span><span class=pc10 title="line 204 char 16 count 2,484,246,639">u</span><span class=pc10 title="line 204 char 3 count 2,484,246,639">))</span>
    <span class=pc11 title="line 205 char 5 count 3,043,590,865">(if </span><span class=pc11 title="line 205 char 9 count 3,043,590,865">(</span><span class=pc11 title="line 205 char 10 count 3,043,590,865">var?</span><span class=pc11 title="line 205 char 9 count 3,043,590,865"> </span><span class=pc11 title="line 205 char 15 count 3,043,590,865">u</span><span class=pc11 title="line 205 char 9 count 3,043,590,865">)</span>
      <span class=pc6 title="line 206 char 7 count 965,217,553">(let ((val </span><span class=pc6 title="line 206 char 18 count 965,217,553">(</span><span class=pc6 title="line 206 char 19 count 965,217,553">subst-lookup</span><span class=pc6 title="line 206 char 18 count 965,217,553"> </span><span class=pc6 title="line 206 char 32 count 965,217,553">u</span><span class=pc6 title="line 206 char 18 count 965,217,553"> </span><span class=pc6 title="line 206 char 34 count 965,217,553">S</span><span class=pc6 title="line 206 char 18 count 965,217,553">)</span><span class=pc6 title="line 206 char 7 count 965,217,553">))</span>
        <span class=pc6 title="line 207 char 9 count 965,212,987">(if </span><span class=pc6 title="line 207 char 13 count 965,212,987">(</span><span class=pc6 title="line 207 char 14 count 965,212,987">unbound?</span><span class=pc6 title="line 207 char 13 count 965,212,987"> </span><span class=pc6 title="line 207 char 23 count 965,212,987">val</span><span class=pc6 title="line 207 char 13 count 965,212,987">)</span>
          <span class=pc4 title="line 208 char 11 count 405,866,770">u</span>
          <span class=pc4 title="line 209 char 11 count 559,346,217">(</span><span class=pc4 title="line 209 char 12 count 559,346,217">rec</span><span class=pc4 title="line 209 char 11 count 559,346,217"> </span><span class=pc4 title="line 209 char 16 count 559,346,217">val</span><span class=pc4 title="line 209 char 11 count 559,346,217">)</span><span class=pc6 title="line 207 char 9 count 965,212,987">)</span><span class=pc6 title="line 206 char 7 count 965,217,553">)</span>
      <span class=pc9 title="line 210 char 7 count 2,078,373,312">u</span><span class=pc11 title="line 205 char 5 count 3,043,590,865">)</span><span class=pc10 title="line 204 char 3 count 2,484,246,639">)</span><span class=pc2 title="line 203 char 1 count 1">)</span>

; Var, Term, Substitution -&gt; Boolean
<span class=pc2 title="line 213 char 1 count 1">(define (occurs-check x v S)</span>
  <span class=pc8 title="line 214 char 3 count 1,741,044,796">(let ((v </span><span class=pc8 title="line 214 char 12 count 1,741,044,796">(</span><span class=pc8 title="line 214 char 13 count 1,741,044,796">walk</span><span class=pc8 title="line 214 char 12 count 1,741,044,796"> </span><span class=pc8 title="line 214 char 18 count 1,741,044,796">v</span><span class=pc8 title="line 214 char 12 count 1,741,044,796"> </span><span class=pc8 title="line 214 char 20 count 1,741,044,796">S</span><span class=pc8 title="line 214 char 12 count 1,741,044,796">)</span><span class=pc8 title="line 214 char 3 count 1,741,044,796">))</span>
    <span class=pc8 title="line 215 char 5 count 1,741,039,229">(cond</span>
      <span class=pc8 title="line 215 char 5 count 1,741,039,229">(</span><span class=pc8 title="line 216 char 8 count 1,741,039,229">(</span><span class=pc8 title="line 216 char 9 count 1,741,039,229">var?</span><span class=pc8 title="line 216 char 8 count 1,741,039,229"> </span><span class=pc8 title="line 216 char 14 count 1,741,039,229">v</span><span class=pc8 title="line 216 char 8 count 1,741,039,229">)</span><span class=pc8 title="line 215 char 5 count 1,741,039,229"> </span><span class=pc3 title="line 216 char 17 count 323,091,424">(</span><span class=pc3 title="line 216 char 18 count 323,091,424">var-eq?</span><span class=pc3 title="line 216 char 17 count 323,091,424"> </span><span class=pc3 title="line 216 char 26 count 323,091,424">v</span><span class=pc3 title="line 216 char 17 count 323,091,424"> </span><span class=pc3 title="line 216 char 28 count 323,091,424">x</span><span class=pc3 title="line 216 char 17 count 323,091,424">)</span><span class=pc8 title="line 215 char 5 count 1,741,039,229">)</span>
      <span class=pc8 title="line 215 char 5 count 1,741,039,229">(</span><span class=pc7 title="line 217 char 8 count 1,417,947,805">(</span><span class=pc7 title="line 217 char 9 count 1,417,947,805">pair?</span><span class=pc7 title="line 217 char 8 count 1,417,947,805"> </span><span class=pc7 title="line 217 char 15 count 1,417,947,805">v</span><span class=pc7 title="line 217 char 8 count 1,417,947,805">)</span>
       <span class=pc5 title="line 218 char 8 count 840,074,776">(or </span><span class=pc5 title="line 218 char 12 count 840,074,776">(</span><span class=pc5 title="line 218 char 13 count 840,074,776">occurs-check</span><span class=pc5 title="line 218 char 12 count 840,074,776"> </span><span class=pc5 title="line 218 char 26 count 840,074,776">x</span><span class=pc5 title="line 218 char 12 count 840,074,776"> </span><span class=pc5 title="line 218 char 28 count 840,074,776">(</span><span class=pc5 title="line 218 char 29 count 840,074,776">car</span><span class=pc5 title="line 218 char 28 count 840,074,776"> </span><span class=pc5 title="line 218 char 33 count 840,074,776">v</span><span class=pc5 title="line 218 char 28 count 840,074,776">)</span><span class=pc5 title="line 218 char 12 count 840,074,776"> </span><span class=pc5 title="line 218 char 36 count 840,074,776">S</span><span class=pc5 title="line 218 char 12 count 840,074,776">)</span>
           <span class=pc5 title="line 219 char 12 count 839,760,927">(</span><span class=pc5 title="line 219 char 13 count 839,760,927">occurs-check</span><span class=pc5 title="line 219 char 12 count 839,760,927"> </span><span class=pc5 title="line 219 char 26 count 839,760,927">x</span><span class=pc5 title="line 219 char 12 count 839,760,927"> </span><span class=pc5 title="line 219 char 28 count 839,760,927">(</span><span class=pc5 title="line 219 char 29 count 839,760,927">cdr</span><span class=pc5 title="line 219 char 28 count 839,760,927"> </span><span class=pc5 title="line 219 char 33 count 839,760,927">v</span><span class=pc5 title="line 219 char 28 count 839,760,927">)</span><span class=pc5 title="line 219 char 12 count 839,760,927"> </span><span class=pc5 title="line 219 char 36 count 839,760,927">S</span><span class=pc5 title="line 219 char 12 count 839,760,927">)</span><span class=pc5 title="line 218 char 8 count 840,074,776">)</span><span class=pc8 title="line 215 char 5 count 1,741,039,229">)</span>
      <span class=pc8 title="line 215 char 5 count 1,741,039,229">(else </span><span class=pc4 title="line 220 char 13 count 577,873,029">#f</span><span class=pc8 title="line 215 char 5 count 1,741,039,229">))</span><span class=pc8 title="line 214 char 3 count 1,741,044,796">)</span><span class=pc2 title="line 213 char 1 count 1">)</span>

; Var, Term, Substitution -&gt; UnificationResult
<span class=pc2 title="line 223 char 1 count 1">(define (ext-s-check x v S)</span>
  <span class=pc2 title="line 224 char 3 count 61,210,283">(if </span><span class=pc2 title="line 224 char 7 count 61,210,283">(</span><span class=pc2 title="line 224 char 8 count 61,210,283">occurs-check</span><span class=pc2 title="line 224 char 7 count 61,210,283"> </span><span class=pc2 title="line 224 char 21 count 61,210,283">x</span><span class=pc2 title="line 224 char 7 count 61,210,283"> </span><span class=pc2 title="line 224 char 23 count 61,210,283">v</span><span class=pc2 title="line 224 char 7 count 61,210,283"> </span><span class=pc2 title="line 224 char 25 count 61,210,283">S</span><span class=pc2 title="line 224 char 7 count 61,210,283">)</span>
    <span class=pc2 title="line 225 char 5 count 56,210">(</span><span class=pc2 title="line 225 char 6 count 56,210">values</span><span class=pc2 title="line 225 char 5 count 56,210"> </span><span class=pc2 title="line 225 char 13 count 56,210">#f</span><span class=pc2 title="line 225 char 5 count 56,210"> </span><span class=pc2 title="line 225 char 16 count 56,210">#f</span><span class=pc2 title="line 225 char 5 count 56,210">)</span>
    <span class=pc2 title="line 226 char 5 count 61,147,316">(</span><span class=pc2 title="line 226 char 6 count 61,147,316">values</span><span class=pc2 title="line 226 char 5 count 61,147,316"> </span><span class=pc2 title="line 226 char 13 count 61,147,316">(</span><span class=pc2 title="line 226 char 14 count 61,147,316">subst-add</span><span class=pc2 title="line 226 char 13 count 61,147,316"> </span><span class=pc2 title="line 226 char 24 count 61,147,316">S</span><span class=pc2 title="line 226 char 13 count 61,147,316"> </span><span class=pc2 title="line 226 char 26 count 61,147,316">x</span><span class=pc2 title="line 226 char 13 count 61,147,316"> </span><span class=pc2 title="line 226 char 28 count 61,147,316">v</span><span class=pc2 title="line 226 char 13 count 61,147,316">)</span><span class=pc2 title="line 226 char 5 count 61,147,316"> </span><span class=pc2 title="line 226 char 31 count 61,147,316">(</span><span class=pc2 title="line 226 char 32 count 61,147,316">list</span><span class=pc2 title="line 226 char 31 count 61,147,316"> </span><span class=pc2 title="line 226 char 37 count 61,147,316">(</span><span class=pc2 title="line 226 char 38 count 61,147,316">cons</span><span class=pc2 title="line 226 char 37 count 61,147,316"> </span><span class=pc2 title="line 226 char 43 count 61,147,316">x</span><span class=pc2 title="line 226 char 37 count 61,147,316"> </span><span class=pc2 title="line 226 char 45 count 61,147,316">v</span><span class=pc2 title="line 226 char 37 count 61,147,316">)</span><span class=pc2 title="line 226 char 31 count 61,147,316">)</span><span class=pc2 title="line 226 char 5 count 61,147,316">)</span><span class=pc2 title="line 224 char 3 count 61,210,283">)</span><span class=pc2 title="line 223 char 1 count 1">)</span>

<span class=pc2 title="line 228 char 1 count 1">(define (unify* S+ S)</span>
  <span class=pc2 title="line 229 char 3 count 76,308,340">(</span><span class=pc2 title="line 229 char 4 count 76,308,340">unify</span><span class=pc2 title="line 229 char 3 count 76,308,340"> </span><span class=pc2 title="line 229 char 10 count 76,308,258">(</span><span class=pc2 title="line 229 char 11 count 76,308,258">map</span><span class=pc2 title="line 229 char 10 count 76,308,258"> </span><span class=pc2 title="line 229 char 15 count 76,308,258">lhs</span><span class=pc2 title="line 229 char 10 count 76,308,258"> </span><span class=pc2 title="line 229 char 19 count 76,308,258">S+</span><span class=pc2 title="line 229 char 10 count 76,308,258">)</span><span class=pc2 title="line 229 char 3 count 76,308,340"> </span><span class=pc2 title="line 229 char 23 count 76,308,340">(</span><span class=pc2 title="line 229 char 24 count 76,308,340">map</span><span class=pc2 title="line 229 char 23 count 76,308,340"> </span><span class=pc2 title="line 229 char 28 count 76,308,340">rhs</span><span class=pc2 title="line 229 char 23 count 76,308,340"> </span><span class=pc2 title="line 229 char 32 count 76,308,340">S+</span><span class=pc2 title="line 229 char 23 count 76,308,340">)</span><span class=pc2 title="line 229 char 3 count 76,308,340"> </span><span class=pc2 title="line 229 char 36 count 76,308,340">S</span><span class=pc2 title="line 229 char 3 count 76,308,340">)</span><span class=pc2 title="line 228 char 1 count 1">)</span>

; Search

; SearchStream: #f | SuspendedStream | State | (Pair State SuspendedStream)
; SuspendedStream: (-&gt; SearchStream)

; Match on search streams. The State type must not be a pair with a procedure
; in its cdr, lest a single result be interpreted as multiple results.
;
; (() e0)     failure
; ((f) e1)    suspension for interleaving. separate from success or failure to ensure
;              it goes all the way to the top of the tree.
; ((c) e2)    single result. Used rather than (cons c (lambda () #f))
;              to avoid returning to search a part of the tree that
;              will inevitably fail.
; ((c f) e3)  multiple results. `f` is a thunk to avoid unnecessary computation
;              in the case that the LHS the last answer needed to satisfy the
;              query. It also triggers interleaving; the search looks for
;              answers in alternate branches before returning.
(define-syntax case-inf
  (syntax-rules ()
    ((_ e (() e0) ((f^) e1) ((c^) e2) ((c f) e3))
     (let ((stream e))
       (cond
         (<span class=pc9 title="line 254 char 11 count 2,124,741,906">(</span><span class=pc9 title="line 254 char 12 count 2,124,741,906">not</span><span class=pc9 title="line 254 char 11 count 2,124,741,906"> </span><span class=pc9 title="line 254 char 16 count 2,124,741,906">stream</span><span class=pc9 title="line 254 char 11 count 2,124,741,906">)</span> e0)
         (<span class=pc9 title="line 255 char 11 count 2,001,185,410">(</span><span class=pc9 title="line 255 char 12 count 2,001,185,410">procedure?</span><span class=pc9 title="line 255 char 11 count 2,001,185,410"> </span><span class=pc9 title="line 255 char 23 count 2,001,185,410">stream</span><span class=pc9 title="line 255 char 11 count 2,001,185,410">)</span>  (let ((f^ <span class=pc9 title="line 255 char 42 count 1,932,178,174">stream</span>)) e1))
         (<span class=pc2 title="line 256 char 11 count 69,007,207">(</span><span class=pc2 title="line 256 char 12 count 69,007,207">not</span><span class=pc2 title="line 256 char 11 count 69,007,207"> </span><span class=pc2 title="line 256 char 16 count 69,007,207">(and </span><span class=pc2 title="line 256 char 21 count 69,007,207">(</span><span class=pc2 title="line 256 char 22 count 69,007,207">pair?</span><span class=pc2 title="line 256 char 21 count 69,007,207"> </span><span class=pc2 title="line 256 char 28 count 69,007,207">stream</span><span class=pc2 title="line 256 char 21 count 69,007,207">)</span>
                 <span class=pc2 title="line 257 char 18 count 69,007,207">(</span><span class=pc2 title="line 257 char 19 count 69,007,207">procedure?</span><span class=pc2 title="line 257 char 18 count 69,007,207"> </span><span class=pc2 title="line 257 char 30 count 69,007,207">(</span><span class=pc2 title="line 257 char 31 count 69,007,207">cdr</span><span class=pc2 title="line 257 char 30 count 69,007,207"> </span><span class=pc2 title="line 257 char 35 count 69,007,207">stream</span><span class=pc2 title="line 257 char 30 count 69,007,207">)</span><span class=pc2 title="line 257 char 18 count 69,007,207">)</span><span class=pc2 title="line 256 char 16 count 69,007,207">)</span><span class=pc2 title="line 256 char 11 count 69,007,207">)</span>
          (let ((c^ <span class=pc2 title="line 258 char 21 count 64,077,132">stream</span>)) e2))
         (else (let ((c <span class=pc2 title="line 259 char 25 count 4,930,075">(</span><span class=pc2 title="line 259 char 26 count 4,930,075">car</span><span class=pc2 title="line 259 char 25 count 4,930,075"> </span><span class=pc2 title="line 259 char 30 count 4,930,075">stream</span><span class=pc2 title="line 259 char 25 count 4,930,075">)</span>) (f <span class=pc2 title="line 259 char 42 count 4,930,075">(</span><span class=pc2 title="line 259 char 43 count 4,930,075">cdr</span><span class=pc2 title="line 259 char 42 count 4,930,075"> </span><span class=pc2 title="line 259 char 47 count 4,930,075">stream</span><span class=pc2 title="line 259 char 42 count 4,930,075">)</span>))
                 e3)))))))

; SearchStream, SuspendedStream -&gt; SearchStream,
;
; f is a thunk to avoid unnecesarry computation in the case that the
; first answer produced by c-inf is enough to satisfy the query.
<span class=pc2 title="line 266 char 1 count 1">(define (mplus stream f)</span>
  <span class=pc2 title="line 267 char 3 count 154,356,408">(case-inf </span><span class=pc2 title="line 267 char 13 count 154,356,408">stream</span>
    <span class=pc2 title="line 267 char 3 count 154,356,408">(() </span><span class=pc2 title="line 268 char 9 count 40,583,472">(</span><span class=pc2 title="line 268 char 10 count 40,583,472">f</span><span class=pc2 title="line 268 char 9 count 40,583,472">)</span><span class=pc2 title="line 267 char 3 count 154,356,408">)</span>
    <span class=pc2 title="line 267 char 3 count 154,356,408">((f^) </span><span class=pc2 title="line 269 char 11 count 108,842,835">(lambda () </span><span class=pc2 title="line 269 char 22 count 107,363,377">(</span><span class=pc2 title="line 269 char 23 count 107,363,377">mplus</span><span class=pc2 title="line 269 char 22 count 107,363,377"> </span><span class=pc2 title="line 269 char 29 count 107,363,377">(</span><span class=pc2 title="line 269 char 30 count 107,363,377">f</span><span class=pc2 title="line 269 char 29 count 107,363,377">)</span><span class=pc2 title="line 269 char 22 count 107,363,377"> </span><span class=pc2 title="line 269 char 33 count 107,363,377">f^</span><span class=pc2 title="line 269 char 22 count 107,363,377">)</span><span class=pc2 title="line 269 char 11 count 108,842,835">)</span><span class=pc2 title="line 267 char 3 count 154,356,408">)</span>
    <span class=pc2 title="line 267 char 3 count 154,356,408">((c) </span><span class=pc2 title="line 270 char 10 count 2,765,068">(</span><span class=pc2 title="line 270 char 11 count 2,765,068">cons</span><span class=pc2 title="line 270 char 10 count 2,765,068"> </span><span class=pc2 title="line 270 char 16 count 2,765,068">c</span><span class=pc2 title="line 270 char 10 count 2,765,068"> </span><span class=pc2 title="line 270 char 18 count 2,765,068">f</span><span class=pc2 title="line 270 char 10 count 2,765,068">)</span><span class=pc2 title="line 267 char 3 count 154,356,408">)</span>
    <span class=pc2 title="line 267 char 3 count 154,356,408">((c f^) </span><span class=pc2 title="line 271 char 13 count 2,165,009">(</span><span class=pc2 title="line 271 char 14 count 2,165,009">cons</span><span class=pc2 title="line 271 char 13 count 2,165,009"> </span><span class=pc2 title="line 271 char 19 count 2,165,009">c</span><span class=pc2 title="line 271 char 13 count 2,165,009"> </span><span class=pc2 title="line 271 char 21 count 2,165,009">(lambda () </span><span class=pc2 title="line 271 char 32 count 1,847,374">(</span><span class=pc2 title="line 271 char 33 count 1,847,374">mplus</span><span class=pc2 title="line 271 char 32 count 1,847,374"> </span><span class=pc2 title="line 271 char 39 count 1,847,374">(</span><span class=pc2 title="line 271 char 40 count 1,847,374">f</span><span class=pc2 title="line 271 char 39 count 1,847,374">)</span><span class=pc2 title="line 271 char 32 count 1,847,374"> </span><span class=pc2 title="line 271 char 43 count 1,847,374">f^</span><span class=pc2 title="line 271 char 32 count 1,847,374">)</span><span class=pc2 title="line 271 char 21 count 2,165,009">)</span><span class=pc2 title="line 271 char 13 count 2,165,009">)</span><span class=pc2 title="line 267 char 3 count 154,356,408">))</span><span class=pc2 title="line 266 char 1 count 1">)</span>

; SearchStream, Goal -&gt; SearchStream
<span class=pc2 title="line 274 char 1 count 1">(define (bind stream g)</span>
  <span class=pc9 title="line 275 char 3 count 1,927,695,179">(case-inf </span><span class=pc9 title="line 275 char 13 count 1,927,695,179">stream</span>
    <span class=pc9 title="line 275 char 3 count 1,927,695,179">(() </span><span class=pc2 title="line 276 char 9 count 82,962,353">#f</span><span class=pc9 title="line 275 char 3 count 1,927,695,179">)</span>
    <span class=pc9 title="line 275 char 3 count 1,927,695,179">((f) </span><span class=pc8 title="line 277 char 10 count 1,780,797,422">(lambda () </span><span class=pc8 title="line 277 char 21 count 1,779,338,748">(</span><span class=pc8 title="line 277 char 22 count 1,779,338,748">bind</span><span class=pc8 title="line 277 char 21 count 1,779,338,748"> </span><span class=pc8 title="line 277 char 27 count 1,779,338,748">(</span><span class=pc8 title="line 277 char 28 count 1,779,338,748">f</span><span class=pc8 title="line 277 char 27 count 1,779,338,748">)</span><span class=pc8 title="line 277 char 21 count 1,779,338,748"> </span><span class=pc8 title="line 277 char 31 count 1,779,338,748">g</span><span class=pc8 title="line 277 char 21 count 1,779,338,748">)</span><span class=pc8 title="line 277 char 10 count 1,780,797,422">)</span><span class=pc9 title="line 275 char 3 count 1,927,695,179">)</span>
    <span class=pc9 title="line 275 char 3 count 1,927,695,179">((c) </span><span class=pc2 title="line 278 char 10 count 61,312,064">(</span><span class=pc2 title="line 278 char 11 count 61,312,064">g</span><span class=pc2 title="line 278 char 10 count 61,312,064"> </span><span class=pc2 title="line 278 char 13 count 61,312,064">c</span><span class=pc2 title="line 278 char 10 count 61,312,064">)</span><span class=pc9 title="line 275 char 3 count 1,927,695,179">)</span>
    <span class=pc9 title="line 275 char 3 count 1,927,695,179">((c f) </span><span class=pc2 title="line 279 char 12 count 2,623,311">(</span><span class=pc2 title="line 279 char 13 count 2,623,311">mplus</span><span class=pc2 title="line 279 char 12 count 2,623,311"> </span><span class=pc2 title="line 279 char 19 count 2,623,311">(</span><span class=pc2 title="line 279 char 20 count 2,623,311">g</span><span class=pc2 title="line 279 char 19 count 2,623,311"> </span><span class=pc2 title="line 279 char 22 count 2,623,311">c</span><span class=pc2 title="line 279 char 19 count 2,623,311">)</span><span class=pc2 title="line 279 char 12 count 2,623,311"> </span><span class=pc2 title="line 279 char 25 count 2,623,311">(lambda () </span><span class=pc2 title="line 279 char 36 count 2,604,017">(</span><span class=pc2 title="line 279 char 37 count 2,604,017">bind</span><span class=pc2 title="line 279 char 36 count 2,604,017"> </span><span class=pc2 title="line 279 char 42 count 2,604,017">(</span><span class=pc2 title="line 279 char 43 count 2,604,017">f</span><span class=pc2 title="line 279 char 42 count 2,604,017">)</span><span class=pc2 title="line 279 char 36 count 2,604,017"> </span><span class=pc2 title="line 279 char 46 count 2,604,017">g</span><span class=pc2 title="line 279 char 36 count 2,604,017">)</span><span class=pc2 title="line 279 char 25 count 2,623,311">)</span><span class=pc2 title="line 279 char 12 count 2,623,311">)</span><span class=pc9 title="line 275 char 3 count 1,927,695,179">))</span><span class=pc2 title="line 274 char 1 count 1">)</span>

; Int, SuspendedStream -&gt; (ListOf SearchResult)
<span class=pc2 title="line 282 char 1 count 1">(define (take n f)</span>
  <span class=pc2 title="line 283 char 3 count 529,747">(if </span><span class=pc2 title="line 283 char 7 count 529,747">(and </span><span class=pc2 title="line 283 char 12 count 529,747">n</span><span class=pc2 title="line 283 char 7 count 529,747"> </span><span class=pc2 title="line 283 char 14 count 529,747">(</span><span class=pc2 title="line 283 char 15 count 529,747">zero?</span><span class=pc2 title="line 283 char 14 count 529,747"> </span><span class=pc2 title="line 283 char 21 count 529,747">n</span><span class=pc2 title="line 283 char 14 count 529,747">)</span><span class=pc2 title="line 283 char 7 count 529,747">)</span>
    <span class=pc2 title="line 284 char 5 count 1">'()</span>
    <span class=pc2 title="line 285 char 5 count 529,746">(case-inf </span><span class=pc2 title="line 285 char 15 count 529,746">(</span><span class=pc2 title="line 285 char 16 count 529,746">f</span><span class=pc2 title="line 285 char 15 count 529,746">)</span>
      <span class=pc2 title="line 285 char 5 count 529,746">(() </span><span class=pc1 title="line 286 char 11 count 0">'()</span><span class=pc2 title="line 285 char 5 count 529,746">)</span>
      <span class=pc2 title="line 285 char 5 count 529,746">((f) </span><span class=pc2 title="line 287 char 12 count 529,745">(</span><span class=pc2 title="line 287 char 13 count 529,745">take</span><span class=pc2 title="line 287 char 12 count 529,745"> </span><span class=pc2 title="line 287 char 18 count 529,745">n</span><span class=pc2 title="line 287 char 12 count 529,745"> </span><span class=pc2 title="line 287 char 20 count 529,745">f</span><span class=pc2 title="line 287 char 12 count 529,745">)</span><span class=pc2 title="line 285 char 5 count 529,746">)</span>
      <span class=pc2 title="line 285 char 5 count 529,746">((c) </span><span class=pc1 title="line 288 char 12 count 0">(</span><span class=pc1 title="line 288 char 13 count 0">cons</span><span class=pc1 title="line 288 char 12 count 0"> </span><span class=pc1 title="line 288 char 18 count 0">c</span><span class=pc1 title="line 288 char 12 count 0"> </span><span class=pc1 title="line 288 char 20 count 0">'()</span><span class=pc1 title="line 288 char 12 count 0">)</span><span class=pc2 title="line 285 char 5 count 529,746">)</span>
      <span class=pc2 title="line 285 char 5 count 529,746">((c f) </span><span class=pc2 title="line 289 char 14 count 1">(</span><span class=pc2 title="line 289 char 15 count 1">cons</span><span class=pc2 title="line 289 char 14 count 1"> </span><span class=pc2 title="line 289 char 20 count 1">c</span><span class=pc2 title="line 289 char 14 count 1"> </span><span class=pc2 title="line 289 char 22 count 1">(</span><span class=pc2 title="line 289 char 23 count 1">take</span><span class=pc2 title="line 289 char 22 count 1"> </span><span class=pc2 title="line 289 char 28 count 1">(and </span><span class=pc2 title="line 289 char 33 count 1">n</span><span class=pc2 title="line 289 char 28 count 1"> </span><span class=pc2 title="line 289 char 35 count 1">(</span><span class=pc2 title="line 289 char 36 count 1">-</span><span class=pc2 title="line 289 char 35 count 1"> </span><span class=pc2 title="line 289 char 38 count 1">n</span><span class=pc2 title="line 289 char 35 count 1"> </span><span class=pc2 title="line 289 char 40 count 1">1</span><span class=pc2 title="line 289 char 35 count 1">)</span><span class=pc2 title="line 289 char 28 count 1">)</span><span class=pc2 title="line 289 char 22 count 1"> </span><span class=pc2 title="line 289 char 44 count 1">f</span><span class=pc2 title="line 289 char 22 count 1">)</span><span class=pc2 title="line 289 char 14 count 1">)</span><span class=pc2 title="line 285 char 5 count 529,746">))</span><span class=pc2 title="line 283 char 3 count 529,747">)</span><span class=pc2 title="line 282 char 1 count 1">)</span>

; (bind* e:SearchStream g:Goal ...) -&gt; SearchStream
(define-syntax bind*
  (syntax-rules ()
    ((_ e) e)
    ((_ e g0 g ...) (bind* (<span class=pc2 title="line 295 char 29 count 129,882,470">bind</span> e g0) g ...))))

; (suspend e:SearchStream) -&gt; SuspendedStream
; Used to clearly mark the locations where search is suspended in order to
; interleave with other branches.
(define-syntax suspend (syntax-rules () ((_ body) (lambda () body))))

; (mplus* e:SearchStream ...+) -&gt; SearchStream
(define-syntax mplus*
  (syntax-rules ()
    ((_ e) e)
    ((_ e0 e ...)
     (<span class=pc2 title="line 307 char 7 count 42,560,424">mplus</span> e0 (suspend (mplus* e ...))))))

; (fresh (x:id ...) g:Goal ...+) -&gt; Goal
(define-syntax fresh
  (syntax-rules ()
    ((_ (x ...) g0 g ...)
     (lambda (st)
       (suspend
         (let ((scope <span class=pc2 title="line 315 char 23 count 23,561,052">(</span><span class=pc2 title="line 315 char 24 count 23,561,052">subst-scope</span><span class=pc2 title="line 315 char 23 count 23,561,052"> </span><span class=pc2 title="line 315 char 36 count 23,561,052">(</span><span class=pc2 title="line 315 char 37 count 23,561,052">state-S</span><span class=pc2 title="line 315 char 36 count 23,561,052"> </span><span class=pc2 title="line 315 char 45 count 23,561,052">st</span><span class=pc2 title="line 315 char 36 count 23,561,052">)</span><span class=pc2 title="line 315 char 23 count 23,561,052">)</span>))
           (let ((x <span class=pc2 title="line 316 char 21 count 103,896,979">(</span><span class=pc2 title="line 316 char 22 count 103,896,979">var</span><span class=pc2 title="line 316 char 21 count 103,896,979"> </span><span class=pc2 title="line 316 char 26 count 103,896,979">scope</span><span class=pc2 title="line 316 char 21 count 103,896,979">)</span>) ...)
             (bind* (g0 <span class=pc2 title="line 317 char 25 count 23,561,050">st</span>) g ...))))))))

; (conde [g:Goal ...] ...+) -&gt; Goal
(define-syntax conde
  (syntax-rules ()
    ((_ (g0 g ...) (g1 g^ ...) ...)
     (lambda (st)
       (<span class=pc2 title="line 324 char 9 count 17,939,377">bind</span>
        <span class=pc2 title="line 325 char 9 count 17,939,377">(</span><span class=pc2 title="line 325 char 10 count 17,939,377">(</span><span class=pc2 title="line 325 char 11 count 17,939,377">trigger-underconstraintso</span><span class=pc2 title="line 325 char 10 count 17,939,377">)</span><span class=pc2 title="line 325 char 9 count 17,939,377"> </span><span class=pc2 title="line 325 char 38 count 17,939,377">st</span><span class=pc2 title="line 325 char 9 count 17,939,377">)</span>
        (lambda (st)
          (suspend
           (let ((st <span class=pc2 title="line 328 char 22 count 17,551,031">(</span><span class=pc2 title="line 328 char 23 count 17,551,031">state-with-scope</span><span class=pc2 title="line 328 char 22 count 17,551,031"> </span><span class=pc2 title="line 328 char 40 count 17,551,031">st</span><span class=pc2 title="line 328 char 22 count 17,551,031"> </span><span class=pc2 title="line 328 char 43 count 17,551,031">(</span><span class=pc2 title="line 328 char 44 count 17,551,031">new-scope</span><span class=pc2 title="line 328 char 43 count 17,551,031">)</span><span class=pc2 title="line 328 char 22 count 17,551,031">)</span>))
             (mplus*
              (bind* (g0 <span class=pc2 title="line 330 char 26 count 17,551,021">st</span>) g ...)
              (bind* (g1 <span class=pc2 title="line 331 char 26 count 42,006,839">st</span>) g^ ...) ...)))))))))

;;; WEB June 11 02023
;;; Moved `run` and `run*` to `mk-underconstraints.scm`

(define-syntax defrel
  (syntax-rules ()
   ;; No suspend given single goal; search order for relations designed with define
   ((_ (name arg ...) g)
    (define (name arg ...) g))
   ;; Use of fresh suspends when forming a conjunction to avoid nontermination
   ((_ (name arg ...) g ...)
    (define (name arg ...) (fresh () g ...)))))



; Constraints
; C refers to the constraint store map
; c refers to an individual constraint record

; Constraint: State -&gt; (or/c #f State)
;
; (note that a Constraint is a Goal but a Goal is not a Constraint.
;  Constraint implementations currently use this more restrained type.
;  See `and-foldl` and `update-constraints`.)

; Invariants assumed for type constraints:
; 1. Must be positive, not negative. not-pairo wouldn't work.
; 2. Each type must have infinitely many possible values to avoid
;      incorrectness in combination with disequality constraints,
;      like: (fresh (x) (booleano x) (=/= x #t) (=/= x #f))
; 3. Types must be disjoint from each other and from pairs.

; Predicate: Any -&gt; (or #f Any)
; CompareResult: (or '&lt; '&gt; '=)
; Ordering: T, T -&gt; CompareResult where T is defined by the corresponding predicate.

; Predicate Symbol CompareResult -&gt; TypeConstraint
<span class=pc2 title="line 369 char 1 count 1">(define (type-constraint predicate reified ordering)</span>
  <span class=pc2 title="line 370 char 3 count 3">(</span><span class=pc2 title="line 370 char 4 count 3">list</span><span class=pc2 title="line 370 char 3 count 3"> </span><span class=pc2 title="line 370 char 9 count 3">predicate</span><span class=pc2 title="line 370 char 3 count 3"> </span><span class=pc2 title="line 370 char 19 count 3">reified</span><span class=pc2 title="line 370 char 3 count 3"> </span><span class=pc2 title="line 370 char 27 count 3">ordering</span><span class=pc2 title="line 370 char 3 count 3">)</span><span class=pc2 title="line 369 char 1 count 1">)</span>

<span class=pc2 title="line 372 char 1 count 1">(define type-constraint-predicate </span><span class=pc2 title="line 372 char 35 count 1">car</span><span class=pc2 title="line 372 char 1 count 1">)</span>
<span class=pc2 title="line 373 char 1 count 1">(define type-constraint-reified </span><span class=pc2 title="line 373 char 33 count 1">cadr</span><span class=pc2 title="line 373 char 1 count 1">)</span>
<span class=pc2 title="line 374 char 1 count 1">(define type-constraint-ordering </span><span class=pc2 title="line 374 char 34 count 1">caddr</span><span class=pc2 title="line 374 char 1 count 1">)</span>

; TypeConstraint -&gt; (Term -&gt; Goal)
<span class=pc2 title="line 377 char 1 count 1">(define (apply-type-constraint tc)</span>
  <span class=pc2 title="line 378 char 3 count 2,492,987">(lambda (u)</span>
    <span class=pc2 title="line 379 char 5 count 16,335,325">(lambda (st)</span>
      <span class=pc2 title="line 380 char 7 count 9,709,732">(let ((type-pred </span><span class=pc2 title="line 380 char 24 count 9,709,732">(</span><span class=pc2 title="line 380 char 25 count 9,709,732">type-constraint-predicate</span><span class=pc2 title="line 380 char 24 count 9,709,732"> </span><span class=pc2 title="line 380 char 51 count 9,709,732">tc</span><span class=pc2 title="line 380 char 24 count 9,709,732">)</span><span class=pc2 title="line 380 char 7 count 9,709,732">))</span>
        <span class=pc2 title="line 381 char 9 count 9,709,732">(let ((term </span><span class=pc2 title="line 381 char 21 count 9,709,732">(</span><span class=pc2 title="line 381 char 22 count 9,709,732">walk</span><span class=pc2 title="line 381 char 21 count 9,709,732"> </span><span class=pc2 title="line 381 char 27 count 9,709,732">u</span><span class=pc2 title="line 381 char 21 count 9,709,732"> </span><span class=pc2 title="line 381 char 29 count 9,709,732">(</span><span class=pc2 title="line 381 char 30 count 9,709,732">state-S</span><span class=pc2 title="line 381 char 29 count 9,709,732"> </span><span class=pc2 title="line 381 char 38 count 9,709,732">st</span><span class=pc2 title="line 381 char 29 count 9,709,732">)</span><span class=pc2 title="line 381 char 21 count 9,709,732">)</span><span class=pc2 title="line 381 char 9 count 9,709,732">))</span>
          <span class=pc2 title="line 382 char 11 count 9,709,710">(cond</span>
            <span class=pc2 title="line 382 char 11 count 9,709,710">(</span><span class=pc2 title="line 383 char 14 count 9,709,710">(</span><span class=pc2 title="line 383 char 15 count 9,709,710">type-pred</span><span class=pc2 title="line 383 char 14 count 9,709,710"> </span><span class=pc2 title="line 383 char 25 count 9,709,710">term</span><span class=pc2 title="line 383 char 14 count 9,709,710">)</span><span class=pc2 title="line 382 char 11 count 9,709,710"> </span><span class=pc2 title="line 383 char 31 count 5,041,014">st</span><span class=pc2 title="line 382 char 11 count 9,709,710">)</span>
            <span class=pc2 title="line 382 char 11 count 9,709,710">(</span><span class=pc2 title="line 384 char 14 count 4,668,696">(</span><span class=pc2 title="line 384 char 15 count 4,668,696">var?</span><span class=pc2 title="line 384 char 14 count 4,668,696"> </span><span class=pc2 title="line 384 char 20 count 4,668,696">term</span><span class=pc2 title="line 384 char 14 count 4,668,696">)</span>
             <span class=pc2 title="line 385 char 14 count 2,061,326">(let* ((c </span><span class=pc2 title="line 385 char 24 count 2,061,326">(</span><span class=pc2 title="line 385 char 25 count 2,061,326">lookup-c</span><span class=pc2 title="line 385 char 24 count 2,061,326"> </span><span class=pc2 title="line 385 char 34 count 2,061,326">st</span><span class=pc2 title="line 385 char 24 count 2,061,326"> </span><span class=pc2 title="line 385 char 37 count 2,061,326">term</span><span class=pc2 title="line 385 char 24 count 2,061,326">)</span><span class=pc2 title="line 385 char 14 count 2,061,326">)</span>
                    <span class=pc2 title="line 385 char 14 count 2,061,326">(T </span><span class=pc2 title="line 386 char 24 count 2,061,315">(</span><span class=pc2 title="line 386 char 25 count 2,061,315">c-T</span><span class=pc2 title="line 386 char 24 count 2,061,315"> </span><span class=pc2 title="line 386 char 29 count 2,061,315">c</span><span class=pc2 title="line 386 char 24 count 2,061,315">)</span><span class=pc2 title="line 385 char 14 count 2,061,326">))</span>
               <span class=pc2 title="line 387 char 16 count 2,061,315">(cond</span>
                 <span class=pc2 title="line 387 char 16 count 2,061,315">(</span><span class=pc2 title="line 388 char 19 count 2,061,315">(</span><span class=pc2 title="line 388 char 20 count 2,061,315">eq?</span><span class=pc2 title="line 388 char 19 count 2,061,315"> </span><span class=pc2 title="line 388 char 24 count 2,061,315">T</span><span class=pc2 title="line 388 char 19 count 2,061,315"> </span><span class=pc2 title="line 388 char 26 count 2,061,315">tc</span><span class=pc2 title="line 388 char 19 count 2,061,315">)</span><span class=pc2 title="line 387 char 16 count 2,061,315"> </span><span class=pc2 title="line 388 char 30 count 977,610">st</span><span class=pc2 title="line 387 char 16 count 2,061,315">)</span>
                 <span class=pc2 title="line 387 char 16 count 2,061,315">(</span><span class=pc2 title="line 389 char 19 count 1,083,705">(</span><span class=pc2 title="line 389 char 20 count 1,083,705">not</span><span class=pc2 title="line 389 char 19 count 1,083,705"> </span><span class=pc2 title="line 389 char 24 count 1,083,705">T</span><span class=pc2 title="line 389 char 19 count 1,083,705">)</span><span class=pc2 title="line 387 char 16 count 2,061,315"> </span><span class=pc2 title="line 389 char 27 count 1,047,701">(</span><span class=pc2 title="line 389 char 28 count 1,047,701">set-c</span><span class=pc2 title="line 389 char 27 count 1,047,701"> </span><span class=pc2 title="line 389 char 34 count 1,047,701">st</span><span class=pc2 title="line 389 char 27 count 1,047,701"> </span><span class=pc2 title="line 389 char 37 count 1,047,701">term</span><span class=pc2 title="line 389 char 27 count 1,047,701"> </span><span class=pc2 title="line 389 char 42 count 1,047,701">(</span><span class=pc2 title="line 389 char 43 count 1,047,701">c-with-T</span><span class=pc2 title="line 389 char 42 count 1,047,701"> </span><span class=pc2 title="line 389 char 52 count 1,047,701">c</span><span class=pc2 title="line 389 char 42 count 1,047,701"> </span><span class=pc2 title="line 389 char 54 count 1,047,701">tc</span><span class=pc2 title="line 389 char 42 count 1,047,701">)</span><span class=pc2 title="line 389 char 27 count 1,047,701">)</span><span class=pc2 title="line 387 char 16 count 2,061,315">)</span>
                 <span class=pc2 title="line 387 char 16 count 2,061,315">(else </span><span class=pc2 title="line 390 char 24 count 36,004">#f</span><span class=pc2 title="line 387 char 16 count 2,061,315">))</span><span class=pc2 title="line 385 char 14 count 2,061,326">)</span><span class=pc2 title="line 382 char 11 count 9,709,710">)</span>
            <span class=pc2 title="line 382 char 11 count 9,709,710">(else </span><span class=pc2 title="line 391 char 19 count 2,607,370">#f</span><span class=pc2 title="line 382 char 11 count 9,709,710">))</span><span class=pc2 title="line 381 char 9 count 9,709,732">)</span><span class=pc2 title="line 380 char 7 count 9,709,732">)</span><span class=pc2 title="line 379 char 5 count 16,335,325">)</span><span class=pc2 title="line 378 char 3 count 2,492,987">)</span><span class=pc2 title="line 377 char 1 count 1">)</span>

(define-syntax declare-type-constraints
  (syntax-rules ()
    ((_ tc-list (name predicate reified ordering) ...)
     (begin
       (define tc-list (<span class=pc2 title="line 397 char 25 count 1">list</span> (<span class=pc2 title="line 397 char 31 count 3">type-constraint</span> predicate 'reified ordering) ...))
       (define-values
         (name ...)
         (<span class=pc2 title="line 400 char 11 count 1">apply</span> <span class=pc2 title="line 400 char 17 count 1">values</span> (<span class=pc2 title="line 400 char 25 count 1">map</span> <span class=pc2 title="line 400 char 29 count 1">apply-type-constraint</span> tc-list)))))))

; Orderings
<span class=pc2 title="line 403 char 1 count 1">(define (number-compare a b) </span><span class=pc1 title="line 403 char 30 count 0">(cond (</span><span class=pc1 title="line 403 char 37 count 0">(</span><span class=pc1 title="line 403 char 38 count 0">=</span><span class=pc1 title="line 403 char 37 count 0"> </span><span class=pc1 title="line 403 char 40 count 0">a</span><span class=pc1 title="line 403 char 37 count 0"> </span><span class=pc1 title="line 403 char 42 count 0">b</span><span class=pc1 title="line 403 char 37 count 0">)</span><span class=pc1 title="line 403 char 30 count 0"> </span><span class=pc1 title="line 403 char 45 count 0">'=</span><span class=pc1 title="line 403 char 30 count 0">) (</span><span class=pc1 title="line 403 char 50 count 0">(</span><span class=pc1 title="line 403 char 51 count 0">&lt;</span><span class=pc1 title="line 403 char 50 count 0"> </span><span class=pc1 title="line 403 char 53 count 0">a</span><span class=pc1 title="line 403 char 50 count 0"> </span><span class=pc1 title="line 403 char 55 count 0">b</span><span class=pc1 title="line 403 char 50 count 0">)</span><span class=pc1 title="line 403 char 30 count 0"> </span><span class=pc1 title="line 403 char 58 count 0">'&lt;</span><span class=pc1 title="line 403 char 30 count 0">) (else </span><span class=pc1 title="line 403 char 68 count 0">'&gt;</span><span class=pc1 title="line 403 char 30 count 0">))</span><span class=pc2 title="line 403 char 1 count 1">)</span>
<span class=pc2 title="line 404 char 1 count 1">(define (string-compare a b) </span><span class=pc2 title="line 404 char 30 count 31">(cond (</span><span class=pc2 title="line 404 char 37 count 31">(</span><span class=pc2 title="line 404 char 38 count 31">string=?</span><span class=pc2 title="line 404 char 37 count 31"> </span><span class=pc2 title="line 404 char 47 count 31">a</span><span class=pc2 title="line 404 char 37 count 31"> </span><span class=pc2 title="line 404 char 49 count 31">b</span><span class=pc2 title="line 404 char 37 count 31">)</span><span class=pc2 title="line 404 char 30 count 31"> </span><span class=pc2 title="line 404 char 52 count 14">'=</span><span class=pc2 title="line 404 char 30 count 31">) (</span><span class=pc2 title="line 404 char 57 count 17">(</span><span class=pc2 title="line 404 char 58 count 17">string&lt;?</span><span class=pc2 title="line 404 char 57 count 17"> </span><span class=pc2 title="line 404 char 67 count 17">a</span><span class=pc2 title="line 404 char 57 count 17"> </span><span class=pc2 title="line 404 char 69 count 17">b</span><span class=pc2 title="line 404 char 57 count 17">)</span><span class=pc2 title="line 404 char 30 count 31"> </span><span class=pc2 title="line 404 char 72 count 7">'&lt;</span><span class=pc2 title="line 404 char 30 count 31">) (else </span><span class=pc2 title="line 404 char 82 count 10">'&gt;</span><span class=pc2 title="line 404 char 30 count 31">))</span><span class=pc2 title="line 404 char 1 count 1">)</span>
<span class=pc2 title="line 405 char 1 count 1">(define (symbol-compare a b) </span><span class=pc2 title="line 405 char 30 count 31">(</span><span class=pc2 title="line 405 char 31 count 31">string-compare</span><span class=pc2 title="line 405 char 30 count 31"> </span><span class=pc2 title="line 405 char 46 count 31">(</span><span class=pc2 title="line 405 char 47 count 31">symbol-&gt;string</span><span class=pc2 title="line 405 char 46 count 31"> </span><span class=pc2 title="line 405 char 62 count 31">a</span><span class=pc2 title="line 405 char 46 count 31">)</span><span class=pc2 title="line 405 char 30 count 31"> </span><span class=pc2 title="line 405 char 65 count 31">(</span><span class=pc2 title="line 405 char 66 count 31">symbol-&gt;string</span><span class=pc2 title="line 405 char 65 count 31"> </span><span class=pc2 title="line 405 char 81 count 31">b</span><span class=pc2 title="line 405 char 65 count 31">)</span><span class=pc2 title="line 405 char 30 count 31">)</span><span class=pc2 title="line 405 char 1 count 1">)</span>

(declare-type-constraints <span class=pc2 title="line 407 char 27 count 1">type-constraints</span>
  (<span class=pc2 title="line 408 char 4 count 1">numbero</span> <span class=pc2 title="line 408 char 12 count 1">number?</span> num <span class=pc2 title="line 408 char 24 count 1">number-compare</span>)
  (<span class=pc2 title="line 409 char 4 count 1">stringo</span> <span class=pc2 title="line 409 char 12 count 1">string?</span> str <span class=pc2 title="line 409 char 24 count 1">string-compare</span>)
  (<span class=pc2 title="line 410 char 4 count 1">symbolo</span> <span class=pc2 title="line 410 char 12 count 1">symbol?</span> sym <span class=pc2 title="line 410 char 24 count 1">symbol-compare</span>))

<span class=pc2 title="line 412 char 1 count 1">(define (add-to-D st v d)</span>
  <span class=pc2 title="line 413 char 3 count 17,942,050">(let* ((c </span><span class=pc2 title="line 413 char 13 count 17,942,050">(</span><span class=pc2 title="line 413 char 14 count 17,942,050">lookup-c</span><span class=pc2 title="line 413 char 13 count 17,942,050"> </span><span class=pc2 title="line 413 char 23 count 17,942,050">st</span><span class=pc2 title="line 413 char 13 count 17,942,050"> </span><span class=pc2 title="line 413 char 26 count 17,942,050">v</span><span class=pc2 title="line 413 char 13 count 17,942,050">)</span><span class=pc2 title="line 413 char 3 count 17,942,050">)</span>
         <span class=pc2 title="line 413 char 3 count 17,942,050">(c^ </span><span class=pc2 title="line 414 char 14 count 17,941,955">(</span><span class=pc2 title="line 414 char 15 count 17,941,955">c-with-D</span><span class=pc2 title="line 414 char 14 count 17,941,955"> </span><span class=pc2 title="line 414 char 24 count 17,941,955">c</span><span class=pc2 title="line 414 char 14 count 17,941,955"> </span><span class=pc2 title="line 414 char 26 count 17,941,955">(</span><span class=pc2 title="line 414 char 27 count 17,941,955">cons</span><span class=pc2 title="line 414 char 26 count 17,941,955"> </span><span class=pc2 title="line 414 char 32 count 17,941,955">d</span><span class=pc2 title="line 414 char 26 count 17,941,955"> </span><span class=pc2 title="line 414 char 34 count 17,941,955">(</span><span class=pc2 title="line 414 char 35 count 17,941,955">c-D</span><span class=pc2 title="line 414 char 34 count 17,941,955"> </span><span class=pc2 title="line 414 char 39 count 17,941,955">c</span><span class=pc2 title="line 414 char 34 count 17,941,955">)</span><span class=pc2 title="line 414 char 26 count 17,941,955">)</span><span class=pc2 title="line 414 char 14 count 17,941,955">)</span><span class=pc2 title="line 413 char 3 count 17,942,050">))</span>
    <span class=pc2 title="line 415 char 5 count 17,941,941">(</span><span class=pc2 title="line 415 char 6 count 17,941,941">set-c</span><span class=pc2 title="line 415 char 5 count 17,941,941"> </span><span class=pc2 title="line 415 char 12 count 17,941,941">st</span><span class=pc2 title="line 415 char 5 count 17,941,941"> </span><span class=pc2 title="line 415 char 15 count 17,941,941">v</span><span class=pc2 title="line 415 char 5 count 17,941,941"> </span><span class=pc2 title="line 415 char 17 count 17,941,941">c^</span><span class=pc2 title="line 415 char 5 count 17,941,941">)</span><span class=pc2 title="line 413 char 3 count 17,942,050">)</span><span class=pc2 title="line 412 char 1 count 1">)</span>

; (ListOf Association) -&gt; Goal
<span class=pc2 title="line 418 char 1 count 1">(define (=/=* S+)</span>
  <span class=pc2 title="line 419 char 3 count 86,506,134">(lambda (st)</span>
    <span class=pc2 title="line 420 char 5 count 76,306,989">(let-values (((S added) </span><span class=pc2 title="line 420 char 29 count 76,306,989">(</span><span class=pc2 title="line 420 char 30 count 76,306,989">unify*</span><span class=pc2 title="line 420 char 29 count 76,306,989"> </span><span class=pc2 title="line 420 char 37 count 76,306,989">S+</span><span class=pc2 title="line 420 char 29 count 76,306,989"> </span><span class=pc2 title="line 420 char 40 count 76,306,989">(</span><span class=pc2 title="line 420 char 41 count 76,306,989">subst-with-scope</span>
                                         <span class=pc2 title="line 421 char 42 count 76,306,989">(</span><span class=pc2 title="line 421 char 43 count 76,306,989">state-S</span><span class=pc2 title="line 421 char 42 count 76,306,989"> </span><span class=pc2 title="line 421 char 51 count 76,306,989">st</span><span class=pc2 title="line 421 char 42 count 76,306,989">)</span>
                                         <span class=pc2 title="line 422 char 42 count 76,306,989">nonlocal-scope</span><span class=pc2 title="line 420 char 40 count 76,306,989">)</span><span class=pc2 title="line 420 char 29 count 76,306,989">)</span><span class=pc2 title="line 420 char 5 count 76,306,989">))</span>
      <span class=pc2 title="line 423 char 7 count 76,305,502">(cond</span>
        <span class=pc2 title="line 423 char 7 count 76,305,502">(</span><span class=pc2 title="line 424 char 10 count 76,305,502">(</span><span class=pc2 title="line 424 char 11 count 76,305,502">not</span><span class=pc2 title="line 424 char 10 count 76,305,502"> </span><span class=pc2 title="line 424 char 15 count 76,305,502">S</span><span class=pc2 title="line 424 char 10 count 76,305,502">)</span><span class=pc2 title="line 423 char 7 count 76,305,502"> </span><span class=pc2 title="line 424 char 18 count 57,745,309">st</span><span class=pc2 title="line 423 char 7 count 76,305,502">)</span>
        <span class=pc2 title="line 423 char 7 count 76,305,502">(</span><span class=pc2 title="line 425 char 10 count 18,560,193">(</span><span class=pc2 title="line 425 char 11 count 18,560,193">null?</span><span class=pc2 title="line 425 char 10 count 18,560,193"> </span><span class=pc2 title="line 425 char 17 count 18,560,193">added</span><span class=pc2 title="line 425 char 10 count 18,560,193">)</span><span class=pc2 title="line 423 char 7 count 76,305,502"> </span><span class=pc2 title="line 425 char 24 count 928,296">#f</span><span class=pc2 title="line 423 char 7 count 76,305,502">)</span>
        <span class=pc2 title="line 423 char 7 count 76,305,502">(else</span>
          <span class=pc2 title="line 423 char 7 count 76,305,502">; Attach the constraint to variables in of the disequality elements</span>
          <span class=pc2 title="line 423 char 7 count 76,305,502">; (el).  We only need to choose one because all elements must fail to</span>
          <span class=pc2 title="line 423 char 7 count 76,305,502">; cause the constraint to fail.</span>
          <span class=pc2 title="line 430 char 11 count 17,631,897">(let ((el </span><span class=pc2 title="line 430 char 21 count 17,631,897">(</span><span class=pc2 title="line 430 char 22 count 17,631,897">car</span><span class=pc2 title="line 430 char 21 count 17,631,897"> </span><span class=pc2 title="line 430 char 26 count 17,631,897">added</span><span class=pc2 title="line 430 char 21 count 17,631,897">)</span><span class=pc2 title="line 430 char 11 count 17,631,897">))</span>
            <span class=pc2 title="line 431 char 13 count 17,631,897">(let ((st </span><span class=pc2 title="line 431 char 23 count 17,631,897">(</span><span class=pc2 title="line 431 char 24 count 17,631,897">add-to-D</span><span class=pc2 title="line 431 char 23 count 17,631,897"> </span><span class=pc2 title="line 431 char 33 count 17,631,897">st</span><span class=pc2 title="line 431 char 23 count 17,631,897"> </span><span class=pc2 title="line 431 char 36 count 17,631,897">(</span><span class=pc2 title="line 431 char 37 count 17,631,897">car</span><span class=pc2 title="line 431 char 36 count 17,631,897"> </span><span class=pc2 title="line 431 char 41 count 17,631,897">el</span><span class=pc2 title="line 431 char 36 count 17,631,897">)</span><span class=pc2 title="line 431 char 23 count 17,631,897"> </span><span class=pc2 title="line 431 char 45 count 17,631,897">added</span><span class=pc2 title="line 431 char 23 count 17,631,897">)</span><span class=pc2 title="line 431 char 13 count 17,631,897">))</span>
              <span class=pc2 title="line 432 char 15 count 17,631,244">(if </span><span class=pc2 title="line 432 char 19 count 17,631,244">(</span><span class=pc2 title="line 432 char 20 count 17,631,244">var?</span><span class=pc2 title="line 432 char 19 count 17,631,244"> </span><span class=pc2 title="line 432 char 25 count 17,631,244">(</span><span class=pc2 title="line 432 char 26 count 17,631,244">cdr</span><span class=pc2 title="line 432 char 25 count 17,631,244"> </span><span class=pc2 title="line 432 char 30 count 17,631,244">el</span><span class=pc2 title="line 432 char 25 count 17,631,244">)</span><span class=pc2 title="line 432 char 19 count 17,631,244">)</span>
                <span class=pc2 title="line 433 char 17 count 310,163">(</span><span class=pc2 title="line 433 char 18 count 310,163">add-to-D</span><span class=pc2 title="line 433 char 17 count 310,163"> </span><span class=pc2 title="line 433 char 27 count 310,163">st</span><span class=pc2 title="line 433 char 17 count 310,163"> </span><span class=pc2 title="line 433 char 30 count 310,163">(</span><span class=pc2 title="line 433 char 31 count 310,163">cdr</span><span class=pc2 title="line 433 char 30 count 310,163"> </span><span class=pc2 title="line 433 char 35 count 310,163">el</span><span class=pc2 title="line 433 char 30 count 310,163">)</span><span class=pc2 title="line 433 char 17 count 310,163"> </span><span class=pc2 title="line 433 char 39 count 310,163">added</span><span class=pc2 title="line 433 char 17 count 310,163">)</span>
                <span class=pc2 title="line 434 char 17 count 17,321,081">st</span><span class=pc2 title="line 432 char 15 count 17,631,244">)</span><span class=pc2 title="line 431 char 13 count 17,631,897">)</span><span class=pc2 title="line 430 char 11 count 17,631,897">)</span><span class=pc2 title="line 423 char 7 count 76,305,502">))</span><span class=pc2 title="line 420 char 5 count 76,306,989">)</span><span class=pc2 title="line 419 char 3 count 86,506,134">)</span><span class=pc2 title="line 418 char 1 count 1">)</span>

; Term, Term -&gt; Goal
<span class=pc2 title="line 437 char 1 count 1">(define (=/= u v)</span>
  <span class=pc2 title="line 438 char 3 count 54,220,359">(</span><span class=pc2 title="line 438 char 4 count 54,220,359">=/=*</span><span class=pc2 title="line 438 char 3 count 54,220,359"> </span><span class=pc2 title="line 438 char 9 count 54,220,359">(</span><span class=pc2 title="line 438 char 10 count 54,220,359">list</span><span class=pc2 title="line 438 char 9 count 54,220,359"> </span><span class=pc2 title="line 438 char 15 count 54,220,359">(</span><span class=pc2 title="line 438 char 16 count 54,220,359">cons</span><span class=pc2 title="line 438 char 15 count 54,220,359"> </span><span class=pc2 title="line 438 char 21 count 54,220,359">u</span><span class=pc2 title="line 438 char 15 count 54,220,359"> </span><span class=pc2 title="line 438 char 23 count 54,220,359">v</span><span class=pc2 title="line 438 char 15 count 54,220,359">)</span><span class=pc2 title="line 438 char 9 count 54,220,359">)</span><span class=pc2 title="line 438 char 3 count 54,220,359">)</span><span class=pc2 title="line 437 char 1 count 1">)</span>

; Term, Term -&gt; Goal
; Generalized 'absento': 'term1' can be any legal term (old version
; of faster-miniKanren required 'term1' to be a ground atom).
<span class=pc2 title="line 443 char 1 count 1">(define (absento term1 term2)</span>
  <span class=pc2 title="line 444 char 3 count 48,059,076">(lambda (st)</span>
    <span class=pc2 title="line 445 char 5 count 46,763,875">(let ((term1 </span><span class=pc2 title="line 445 char 18 count 46,763,795">(</span><span class=pc2 title="line 445 char 19 count 46,763,795">walk</span><span class=pc2 title="line 445 char 18 count 46,763,795"> </span><span class=pc2 title="line 445 char 24 count 46,763,795">term1</span><span class=pc2 title="line 445 char 18 count 46,763,795"> </span><span class=pc2 title="line 445 char 30 count 46,763,795">(</span><span class=pc2 title="line 445 char 31 count 46,763,795">state-S</span><span class=pc2 title="line 445 char 30 count 46,763,795"> </span><span class=pc2 title="line 445 char 39 count 46,763,795">st</span><span class=pc2 title="line 445 char 30 count 46,763,795">)</span><span class=pc2 title="line 445 char 18 count 46,763,795">)</span><span class=pc2 title="line 445 char 5 count 46,763,875">)</span>
          <span class=pc2 title="line 445 char 5 count 46,763,875">(term2 </span><span class=pc2 title="line 446 char 18 count 46,763,875">(</span><span class=pc2 title="line 446 char 19 count 46,763,875">walk</span><span class=pc2 title="line 446 char 18 count 46,763,875"> </span><span class=pc2 title="line 446 char 24 count 46,763,875">term2</span><span class=pc2 title="line 446 char 18 count 46,763,875"> </span><span class=pc2 title="line 446 char 30 count 46,763,875">(</span><span class=pc2 title="line 446 char 31 count 46,763,875">state-S</span><span class=pc2 title="line 446 char 30 count 46,763,875"> </span><span class=pc2 title="line 446 char 39 count 46,763,875">st</span><span class=pc2 title="line 446 char 30 count 46,763,875">)</span><span class=pc2 title="line 446 char 18 count 46,763,875">)</span><span class=pc2 title="line 445 char 5 count 46,763,875">))</span>
      <span class=pc2 title="line 447 char 7 count 46,763,765">(let ((st^ </span><span class=pc2 title="line 447 char 18 count 46,763,765">(</span><span class=pc2 title="line 447 char 19 count 46,763,765">(</span><span class=pc2 title="line 447 char 20 count 46,763,765">=/=</span><span class=pc2 title="line 447 char 19 count 46,763,765"> </span><span class=pc2 title="line 447 char 24 count 46,763,765">term1</span><span class=pc2 title="line 447 char 19 count 46,763,765"> </span><span class=pc2 title="line 447 char 30 count 46,763,765">term2</span><span class=pc2 title="line 447 char 19 count 46,763,765">)</span><span class=pc2 title="line 447 char 18 count 46,763,765"> </span><span class=pc2 title="line 447 char 37 count 46,763,765">st</span><span class=pc2 title="line 447 char 18 count 46,763,765">)</span><span class=pc2 title="line 447 char 7 count 46,763,765">))</span>
        <span class=pc2 title="line 448 char 9 count 46,762,268">(and </span><span class=pc2 title="line 448 char 14 count 46,762,268">st^</span>
             <span class=pc2 title="line 449 char 14 count 46,761,386">(cond</span>
               <span class=pc2 title="line 449 char 14 count 46,761,386">(</span><span class=pc2 title="line 450 char 17 count 46,761,386">(</span><span class=pc2 title="line 450 char 18 count 46,761,386">pair?</span><span class=pc2 title="line 450 char 17 count 46,761,386"> </span><span class=pc2 title="line 450 char 24 count 46,761,386">term2</span><span class=pc2 title="line 450 char 17 count 46,761,386">)</span>
                <span class=pc2 title="line 451 char 17 count 13,034,335">(let ((st^^ </span><span class=pc2 title="line 451 char 29 count 13,034,335">(</span><span class=pc2 title="line 451 char 30 count 13,034,335">(</span><span class=pc2 title="line 451 char 31 count 13,034,335">absento</span><span class=pc2 title="line 451 char 30 count 13,034,335"> </span><span class=pc2 title="line 451 char 39 count 13,034,335">term1</span><span class=pc2 title="line 451 char 30 count 13,034,335"> </span><span class=pc2 title="line 451 char 45 count 13,034,335">(</span><span class=pc2 title="line 451 char 46 count 13,034,335">car</span><span class=pc2 title="line 451 char 45 count 13,034,335"> </span><span class=pc2 title="line 451 char 50 count 13,034,335">term2</span><span class=pc2 title="line 451 char 45 count 13,034,335">)</span><span class=pc2 title="line 451 char 30 count 13,034,335">)</span><span class=pc2 title="line 451 char 29 count 13,034,335"> </span><span class=pc2 title="line 451 char 58 count 13,034,335">st^</span><span class=pc2 title="line 451 char 29 count 13,034,335">)</span><span class=pc2 title="line 451 char 17 count 13,034,335">))</span>
                  <span class=pc2 title="line 452 char 19 count 13,032,889">(and </span><span class=pc2 title="line 452 char 24 count 13,032,889">st^^</span><span class=pc2 title="line 452 char 19 count 13,032,889"> </span><span class=pc2 title="line 452 char 29 count 13,032,889">(</span><span class=pc2 title="line 452 char 30 count 13,032,889">(</span><span class=pc2 title="line 452 char 31 count 13,032,889">absento</span><span class=pc2 title="line 452 char 30 count 13,032,889"> </span><span class=pc2 title="line 452 char 39 count 13,032,889">term1</span><span class=pc2 title="line 452 char 30 count 13,032,889"> </span><span class=pc2 title="line 452 char 45 count 13,032,889">(</span><span class=pc2 title="line 452 char 46 count 13,032,889">cdr</span><span class=pc2 title="line 452 char 45 count 13,032,889"> </span><span class=pc2 title="line 452 char 50 count 13,032,889">term2</span><span class=pc2 title="line 452 char 45 count 13,032,889">)</span><span class=pc2 title="line 452 char 30 count 13,032,889">)</span><span class=pc2 title="line 452 char 29 count 13,032,889"> </span><span class=pc2 title="line 452 char 58 count 13,032,889">st^^</span><span class=pc2 title="line 452 char 29 count 13,032,889">)</span><span class=pc2 title="line 452 char 19 count 13,032,889">)</span><span class=pc2 title="line 451 char 17 count 13,034,335">)</span><span class=pc2 title="line 449 char 14 count 46,761,386">)</span>
               <span class=pc2 title="line 449 char 14 count 46,761,386">(</span><span class=pc2 title="line 453 char 17 count 33,727,051">(</span><span class=pc2 title="line 453 char 18 count 33,727,051">var?</span><span class=pc2 title="line 453 char 17 count 33,727,051"> </span><span class=pc2 title="line 453 char 23 count 33,727,051">term2</span><span class=pc2 title="line 453 char 17 count 33,727,051">)</span>
                <span class=pc2 title="line 454 char 17 count 13,323,385">(let* ((c </span><span class=pc2 title="line 454 char 27 count 13,323,385">(</span><span class=pc2 title="line 454 char 28 count 13,323,385">lookup-c</span><span class=pc2 title="line 454 char 27 count 13,323,385"> </span><span class=pc2 title="line 454 char 37 count 13,323,385">st^</span><span class=pc2 title="line 454 char 27 count 13,323,385"> </span><span class=pc2 title="line 454 char 41 count 13,323,385">term2</span><span class=pc2 title="line 454 char 27 count 13,323,385">)</span><span class=pc2 title="line 454 char 17 count 13,323,385">)</span>
                       <span class=pc2 title="line 454 char 17 count 13,323,385">(A </span><span class=pc2 title="line 455 char 27 count 13,323,335">(</span><span class=pc2 title="line 455 char 28 count 13,323,335">c-A</span><span class=pc2 title="line 455 char 27 count 13,323,335"> </span><span class=pc2 title="line 455 char 32 count 13,323,335">c</span><span class=pc2 title="line 455 char 27 count 13,323,335">)</span><span class=pc2 title="line 454 char 17 count 13,323,385">))</span>
                  <span class=pc2 title="line 456 char 19 count 13,323,335">(if </span><span class=pc2 title="line 456 char 23 count 13,323,335">(</span><span class=pc2 title="line 456 char 24 count 13,323,335">memv</span><span class=pc2 title="line 456 char 23 count 13,323,335"> </span><span class=pc2 title="line 456 char 29 count 13,323,335">term1</span><span class=pc2 title="line 456 char 23 count 13,323,335"> </span><span class=pc2 title="line 456 char 35 count 13,323,335">A</span><span class=pc2 title="line 456 char 23 count 13,323,335">)</span>
                    <span class=pc2 title="line 457 char 21 count 1,302,051">st^</span>
                    <span class=pc2 title="line 458 char 21 count 12,021,263">(let ((c^ </span><span class=pc2 title="line 458 char 31 count 12,021,263">(</span><span class=pc2 title="line 458 char 32 count 12,021,263">c-with-A</span><span class=pc2 title="line 458 char 31 count 12,021,263"> </span><span class=pc2 title="line 458 char 41 count 12,021,263">c</span><span class=pc2 title="line 458 char 31 count 12,021,263"> </span><span class=pc2 title="line 458 char 43 count 12,021,263">(</span><span class=pc2 title="line 458 char 44 count 12,021,263">cons</span><span class=pc2 title="line 458 char 43 count 12,021,263"> </span><span class=pc2 title="line 458 char 49 count 12,021,263">term1</span><span class=pc2 title="line 458 char 43 count 12,021,263"> </span><span class=pc2 title="line 458 char 55 count 12,021,263">A</span><span class=pc2 title="line 458 char 43 count 12,021,263">)</span><span class=pc2 title="line 458 char 31 count 12,021,263">)</span><span class=pc2 title="line 458 char 21 count 12,021,263">))</span>
                      <span class=pc2 title="line 459 char 23 count 12,021,258">(</span><span class=pc2 title="line 459 char 24 count 12,021,258">set-c</span><span class=pc2 title="line 459 char 23 count 12,021,258"> </span><span class=pc2 title="line 459 char 30 count 12,021,258">st^</span><span class=pc2 title="line 459 char 23 count 12,021,258"> </span><span class=pc2 title="line 459 char 34 count 12,021,258">term2</span><span class=pc2 title="line 459 char 23 count 12,021,258"> </span><span class=pc2 title="line 459 char 40 count 12,021,258">c^</span><span class=pc2 title="line 459 char 23 count 12,021,258">)</span><span class=pc2 title="line 458 char 21 count 12,021,263">)</span><span class=pc2 title="line 456 char 19 count 13,323,335">)</span><span class=pc2 title="line 454 char 17 count 13,323,385">)</span><span class=pc2 title="line 449 char 14 count 46,761,386">)</span>
               <span class=pc2 title="line 449 char 14 count 46,761,386">(else </span><span class=pc2 title="line 460 char 22 count 20,403,666">st^</span><span class=pc2 title="line 449 char 14 count 46,761,386">))</span><span class=pc2 title="line 448 char 9 count 46,762,268">)</span><span class=pc2 title="line 447 char 7 count 46,763,765">)</span><span class=pc2 title="line 445 char 5 count 46,763,875">)</span><span class=pc2 title="line 444 char 3 count 48,059,076">)</span><span class=pc2 title="line 443 char 1 count 1">)</span>

; Fold lst with proc and initial value init. If proc ever returns #f,
; return with #f immediately. Used for applying a series of
; constraints to a state, failing if any operation fails.
<span class=pc2 title="line 465 char 1 count 1">(define (and-foldl proc init lst)</span>
  <span class=pc2 title="line 466 char 3 count 128,486,708">(if </span><span class=pc2 title="line 466 char 7 count 128,486,708">(</span><span class=pc2 title="line 466 char 8 count 128,486,708">null?</span><span class=pc2 title="line 466 char 7 count 128,486,708"> </span><span class=pc2 title="line 466 char 14 count 128,486,708">lst</span><span class=pc2 title="line 466 char 7 count 128,486,708">)</span>
    <span class=pc2 title="line 467 char 5 count 39,350,454">init</span>
    <span class=pc2 title="line 468 char 5 count 89,136,194">(let ((res </span><span class=pc2 title="line 468 char 16 count 89,136,194">(</span><span class=pc2 title="line 468 char 17 count 89,136,194">proc</span><span class=pc2 title="line 468 char 16 count 89,136,194"> </span><span class=pc2 title="line 468 char 22 count 89,136,194">(</span><span class=pc2 title="line 468 char 23 count 89,136,194">car</span><span class=pc2 title="line 468 char 22 count 89,136,194"> </span><span class=pc2 title="line 468 char 27 count 89,136,194">lst</span><span class=pc2 title="line 468 char 22 count 89,136,194">)</span><span class=pc2 title="line 468 char 16 count 89,136,194"> </span><span class=pc2 title="line 468 char 32 count 89,136,194">init</span><span class=pc2 title="line 468 char 16 count 89,136,194">)</span><span class=pc2 title="line 468 char 5 count 89,136,194">))</span>
      <span class=pc2 title="line 469 char 7 count 89,130,543">(and </span><span class=pc2 title="line 469 char 12 count 89,130,543">res</span><span class=pc2 title="line 469 char 7 count 89,130,543"> </span><span class=pc2 title="line 469 char 16 count 88,347,099">(</span><span class=pc2 title="line 469 char 17 count 88,347,099">and-foldl</span><span class=pc2 title="line 469 char 16 count 88,347,099"> </span><span class=pc2 title="line 469 char 27 count 88,347,099">proc</span><span class=pc2 title="line 469 char 16 count 88,347,099"> </span><span class=pc2 title="line 469 char 32 count 88,347,099">res</span><span class=pc2 title="line 469 char 16 count 88,347,099"> </span><span class=pc2 title="line 469 char 36 count 88,347,099">(</span><span class=pc2 title="line 469 char 37 count 88,347,099">cdr</span><span class=pc2 title="line 469 char 36 count 88,347,099"> </span><span class=pc2 title="line 469 char 41 count 88,347,099">lst</span><span class=pc2 title="line 469 char 36 count 88,347,099">)</span><span class=pc2 title="line 469 char 16 count 88,347,099">)</span><span class=pc2 title="line 469 char 7 count 89,130,543">)</span><span class=pc2 title="line 468 char 5 count 89,136,194">)</span><span class=pc2 title="line 466 char 3 count 128,486,708">)</span><span class=pc2 title="line 465 char 1 count 1">)</span>

;; WEB June 4, 02023 -- the definition of `==` has been moved to
;; `mk-underconstraints.scm`

; Not fully optimized. Could do absento update with fewer
; hash-refs / hash-sets.
<span class=pc2 title="line 476 char 1 count 1">(define (update-constraints a st)</span>
  <span class=pc2 title="line 477 char 3 count 42,857,655">(let ((st </span><span class=pc2 title="line 477 char 13 count 42,857,655">(</span><span class=pc2 title="line 477 char 14 count 42,857,655">set-v</span><span class=pc2 title="line 477 char 13 count 42,857,655"> </span><span class=pc2 title="line 477 char 20 count 42,857,655">st</span><span class=pc2 title="line 477 char 13 count 42,857,655"> </span><span class=pc2 title="line 477 char 23 count 42,857,655">(</span><span class=pc2 title="line 477 char 24 count 42,857,655">lhs</span><span class=pc2 title="line 477 char 23 count 42,857,655"> </span><span class=pc2 title="line 477 char 28 count 42,857,655">a</span><span class=pc2 title="line 477 char 23 count 42,857,655">)</span><span class=pc2 title="line 477 char 13 count 42,857,655">)</span><span class=pc2 title="line 477 char 3 count 42,857,655">))</span>
    <span class=pc2 title="line 478 char 5 count 42,857,524">(let ((old-c </span><span class=pc2 title="line 478 char 18 count 42,857,524">(</span><span class=pc2 title="line 478 char 19 count 42,857,524">lookup-c</span><span class=pc2 title="line 478 char 18 count 42,857,524"> </span><span class=pc2 title="line 478 char 28 count 42,857,524">st</span><span class=pc2 title="line 478 char 18 count 42,857,524"> </span><span class=pc2 title="line 478 char 31 count 42,857,524">(</span><span class=pc2 title="line 478 char 32 count 42,857,524">lhs</span><span class=pc2 title="line 478 char 31 count 42,857,524"> </span><span class=pc2 title="line 478 char 36 count 42,857,524">a</span><span class=pc2 title="line 478 char 31 count 42,857,524">)</span><span class=pc2 title="line 478 char 18 count 42,857,524">)</span><span class=pc2 title="line 478 char 5 count 42,857,524">))</span>
      <span class=pc2 title="line 479 char 7 count 42,857,422">(if </span><span class=pc2 title="line 479 char 11 count 42,857,422">(</span><span class=pc2 title="line 479 char 12 count 42,857,422">eq?</span><span class=pc2 title="line 479 char 11 count 42,857,422"> </span><span class=pc2 title="line 479 char 16 count 42,857,422">old-c</span><span class=pc2 title="line 479 char 11 count 42,857,422"> </span><span class=pc2 title="line 479 char 22 count 42,857,422">empty-c</span><span class=pc2 title="line 479 char 11 count 42,857,422">)</span>
          <span class=pc2 title="line 480 char 11 count 38,458,891">st</span>
          <span class=pc2 title="line 481 char 11 count 4,398,531">(let ((st </span><span class=pc2 title="line 481 char 21 count 4,398,531">(</span><span class=pc2 title="line 481 char 22 count 4,398,531">remove-c</span><span class=pc2 title="line 481 char 21 count 4,398,531"> </span><span class=pc2 title="line 481 char 31 count 4,398,531">(</span><span class=pc2 title="line 481 char 32 count 4,398,531">lhs</span><span class=pc2 title="line 481 char 31 count 4,398,531"> </span><span class=pc2 title="line 481 char 36 count 4,398,531">a</span><span class=pc2 title="line 481 char 31 count 4,398,531">)</span><span class=pc2 title="line 481 char 21 count 4,398,531"> </span><span class=pc2 title="line 481 char 39 count 4,398,531">st</span><span class=pc2 title="line 481 char 21 count 4,398,531">)</span><span class=pc2 title="line 481 char 11 count 4,398,531">))</span>
            <span class=pc2 title="line 482 char 13 count 4,398,416">(</span><span class=pc2 title="line 482 char 14 count 4,398,416">and-foldl</span><span class=pc2 title="line 482 char 13 count 4,398,416"> </span><span class=pc2 title="line 482 char 24 count 4,398,416">(lambda (op st) </span><span class=pc2 title="line 482 char 40 count 46,278,488">(</span><span class=pc2 title="line 482 char 41 count 46,278,488">op</span><span class=pc2 title="line 482 char 40 count 46,278,488"> </span><span class=pc2 title="line 482 char 44 count 46,278,488">st</span><span class=pc2 title="line 482 char 40 count 46,278,488">)</span><span class=pc2 title="line 482 char 24 count 4,398,416">)</span><span class=pc2 title="line 482 char 13 count 4,398,416"> </span><span class=pc2 title="line 482 char 49 count 4,398,416">st</span>
                       <span class=pc2 title="line 483 char 24 count 4,398,416">(</span><span class=pc2 title="line 483 char 25 count 4,398,416">append</span>
                        <span class=pc2 title="line 484 char 25 count 4,398,361">(if </span><span class=pc2 title="line 484 char 29 count 4,398,361">(</span><span class=pc2 title="line 484 char 30 count 4,398,361">c-T</span><span class=pc2 title="line 484 char 29 count 4,398,361"> </span><span class=pc2 title="line 484 char 34 count 4,398,361">old-c</span><span class=pc2 title="line 484 char 29 count 4,398,361">)</span>
                            <span class=pc2 title="line 485 char 29 count 2,492,984">(</span><span class=pc2 title="line 485 char 30 count 2,492,984">list</span><span class=pc2 title="line 485 char 29 count 2,492,984"> </span><span class=pc2 title="line 485 char 35 count 2,492,984">(</span><span class=pc2 title="line 485 char 36 count 2,492,984">(</span><span class=pc2 title="line 485 char 37 count 2,492,984">apply-type-constraint</span><span class=pc2 title="line 485 char 36 count 2,492,984"> </span><span class=pc2 title="line 485 char 59 count 2,492,984">(</span><span class=pc2 title="line 485 char 60 count 2,492,984">c-T</span><span class=pc2 title="line 485 char 59 count 2,492,984"> </span><span class=pc2 title="line 485 char 64 count 2,492,984">old-c</span><span class=pc2 title="line 485 char 59 count 2,492,984">)</span><span class=pc2 title="line 485 char 36 count 2,492,984">)</span><span class=pc2 title="line 485 char 35 count 2,492,984"> </span><span class=pc2 title="line 485 char 72 count 2,492,984">(</span><span class=pc2 title="line 485 char 73 count 2,492,984">rhs</span><span class=pc2 title="line 485 char 72 count 2,492,984"> </span><span class=pc2 title="line 485 char 77 count 2,492,984">a</span><span class=pc2 title="line 485 char 72 count 2,492,984">)</span><span class=pc2 title="line 485 char 35 count 2,492,984">)</span><span class=pc2 title="line 485 char 29 count 2,492,984">)</span>
                            <span class=pc2 title="line 486 char 29 count 1,905,377">'()</span><span class=pc2 title="line 484 char 25 count 4,398,361">)</span>
                        <span class=pc2 title="line 487 char 25 count 4,398,398">(</span><span class=pc2 title="line 487 char 26 count 4,398,398">map</span><span class=pc2 title="line 487 char 25 count 4,398,398"> </span><span class=pc2 title="line 487 char 30 count 4,398,398">(lambda (atom) </span><span class=pc2 title="line 487 char 45 count 21,991,847">(</span><span class=pc2 title="line 487 char 46 count 21,991,847">absento</span><span class=pc2 title="line 487 char 45 count 21,991,847"> </span><span class=pc2 title="line 487 char 54 count 21,991,847">atom</span><span class=pc2 title="line 487 char 45 count 21,991,847"> </span><span class=pc2 title="line 487 char 59 count 21,991,847">(</span><span class=pc2 title="line 487 char 60 count 21,991,847">rhs</span><span class=pc2 title="line 487 char 59 count 21,991,847"> </span><span class=pc2 title="line 487 char 64 count 21,991,847">a</span><span class=pc2 title="line 487 char 59 count 21,991,847">)</span><span class=pc2 title="line 487 char 45 count 21,991,847">)</span><span class=pc2 title="line 487 char 30 count 4,398,398">)</span><span class=pc2 title="line 487 char 25 count 4,398,398"> </span><span class=pc2 title="line 487 char 69 count 4,398,398">(</span><span class=pc2 title="line 487 char 70 count 4,398,398">c-A</span><span class=pc2 title="line 487 char 69 count 4,398,398"> </span><span class=pc2 title="line 487 char 74 count 4,398,398">old-c</span><span class=pc2 title="line 487 char 69 count 4,398,398">)</span><span class=pc2 title="line 487 char 25 count 4,398,398">)</span>
                        <span class=pc2 title="line 488 char 25 count 4,398,416">(</span><span class=pc2 title="line 488 char 26 count 4,398,416">map</span><span class=pc2 title="line 488 char 25 count 4,398,416"> </span><span class=pc2 title="line 488 char 30 count 4,398,416">=/=*</span><span class=pc2 title="line 488 char 25 count 4,398,416"> </span><span class=pc2 title="line 488 char 35 count 4,398,416">(</span><span class=pc2 title="line 488 char 36 count 4,398,416">c-D</span><span class=pc2 title="line 488 char 35 count 4,398,416"> </span><span class=pc2 title="line 488 char 40 count 4,398,416">old-c</span><span class=pc2 title="line 488 char 35 count 4,398,416">)</span><span class=pc2 title="line 488 char 25 count 4,398,416">)</span><span class=pc2 title="line 483 char 24 count 4,398,416">)</span><span class=pc2 title="line 482 char 13 count 4,398,416">)</span><span class=pc2 title="line 481 char 11 count 4,398,531">)</span><span class=pc2 title="line 479 char 7 count 42,857,422">)</span><span class=pc2 title="line 478 char 5 count 42,857,524">)</span><span class=pc2 title="line 477 char 3 count 42,857,655">)</span><span class=pc2 title="line 476 char 1 count 1">)</span>

<span class=pc2 title="line 490 char 1 count 1">(define (walk* v S)</span>
  <span class=pc2 title="line 491 char 3 count 5,398,558">(let ((v </span><span class=pc2 title="line 491 char 12 count 5,398,558">(</span><span class=pc2 title="line 491 char 13 count 5,398,558">walk</span><span class=pc2 title="line 491 char 12 count 5,398,558"> </span><span class=pc2 title="line 491 char 18 count 5,398,558">v</span><span class=pc2 title="line 491 char 12 count 5,398,558"> </span><span class=pc2 title="line 491 char 20 count 5,398,558">S</span><span class=pc2 title="line 491 char 12 count 5,398,558">)</span><span class=pc2 title="line 491 char 3 count 5,398,558">))</span>
    <span class=pc2 title="line 492 char 5 count 5,398,558">(cond</span>
      <span class=pc2 title="line 492 char 5 count 5,398,558">(</span><span class=pc2 title="line 493 char 8 count 5,398,558">(</span><span class=pc2 title="line 493 char 9 count 5,398,558">var?</span><span class=pc2 title="line 493 char 8 count 5,398,558"> </span><span class=pc2 title="line 493 char 14 count 5,398,558">v</span><span class=pc2 title="line 493 char 8 count 5,398,558">)</span><span class=pc2 title="line 492 char 5 count 5,398,558"> </span><span class=pc2 title="line 493 char 17 count 2,543,857">v</span><span class=pc2 title="line 492 char 5 count 5,398,558">)</span>
      <span class=pc2 title="line 492 char 5 count 5,398,558">(</span><span class=pc2 title="line 494 char 8 count 2,854,701">(</span><span class=pc2 title="line 494 char 9 count 2,854,701">pair?</span><span class=pc2 title="line 494 char 8 count 2,854,701"> </span><span class=pc2 title="line 494 char 15 count 2,854,701">v</span><span class=pc2 title="line 494 char 8 count 2,854,701">)</span>
       <span class=pc2 title="line 495 char 8 count 2,621,374">(</span><span class=pc2 title="line 495 char 9 count 2,621,374">cons</span><span class=pc2 title="line 495 char 8 count 2,621,374"> </span><span class=pc2 title="line 495 char 14 count 2,621,374">(</span><span class=pc2 title="line 495 char 15 count 2,621,374">walk*</span><span class=pc2 title="line 495 char 14 count 2,621,374"> </span><span class=pc2 title="line 495 char 21 count 2,621,374">(</span><span class=pc2 title="line 495 char 22 count 2,621,374">car</span><span class=pc2 title="line 495 char 21 count 2,621,374"> </span><span class=pc2 title="line 495 char 26 count 2,621,374">v</span><span class=pc2 title="line 495 char 21 count 2,621,374">)</span><span class=pc2 title="line 495 char 14 count 2,621,374"> </span><span class=pc2 title="line 495 char 29 count 2,621,374">S</span><span class=pc2 title="line 495 char 14 count 2,621,374">)</span><span class=pc2 title="line 495 char 8 count 2,621,374"> </span><span class=pc2 title="line 495 char 32 count 2,621,374">(</span><span class=pc2 title="line 495 char 33 count 2,621,374">walk*</span><span class=pc2 title="line 495 char 32 count 2,621,374"> </span><span class=pc2 title="line 495 char 39 count 2,621,374">(</span><span class=pc2 title="line 495 char 40 count 2,621,374">cdr</span><span class=pc2 title="line 495 char 39 count 2,621,374"> </span><span class=pc2 title="line 495 char 44 count 2,621,374">v</span><span class=pc2 title="line 495 char 39 count 2,621,374">)</span><span class=pc2 title="line 495 char 32 count 2,621,374"> </span><span class=pc2 title="line 495 char 47 count 2,621,374">S</span><span class=pc2 title="line 495 char 32 count 2,621,374">)</span><span class=pc2 title="line 495 char 8 count 2,621,374">)</span><span class=pc2 title="line 492 char 5 count 5,398,558">)</span>
      <span class=pc2 title="line 492 char 5 count 5,398,558">(else </span><span class=pc2 title="line 496 char 13 count 233,327">v</span><span class=pc2 title="line 492 char 5 count 5,398,558">))</span><span class=pc2 title="line 491 char 3 count 5,398,558">)</span><span class=pc2 title="line 490 char 1 count 1">)</span>

(define-syntax project
  (syntax-rules ()
    ((_ (x ...) g g* ...)
     (lambda (st)
       (let ((x (walk* x (state-S st))) ...)
         ((fresh () g g* ...) st))))))

;; WEB June 4, 02023 -- the definitions of `succeed` and `fail` have
;; been moved to `mk-underconstraints.scm`

; Reification

; S - substitution
; T - type constraints
; A - absento constriants
; D - disequality constraints

<span class=pc2 title="line 515 char 1 count 1">(define (reify x)</span>
  <span class=pc2 title="line 516 char 3 count 1">(lambda (st)</span>
    <span class=pc2 title="line 517 char 5 count 1">(let* ((S </span><span class=pc2 title="line 517 char 15 count 1">(</span><span class=pc2 title="line 517 char 16 count 1">state-S</span><span class=pc2 title="line 517 char 15 count 1"> </span><span class=pc2 title="line 517 char 24 count 1">st</span><span class=pc2 title="line 517 char 15 count 1">)</span><span class=pc2 title="line 517 char 5 count 1">)</span>
           <span class=pc2 title="line 517 char 5 count 1">(v </span><span class=pc2 title="line 518 char 15 count 1">(</span><span class=pc2 title="line 518 char 16 count 1">walk*</span><span class=pc2 title="line 518 char 15 count 1"> </span><span class=pc2 title="line 518 char 22 count 1">x</span><span class=pc2 title="line 518 char 15 count 1"> </span><span class=pc2 title="line 518 char 24 count 1">S</span><span class=pc2 title="line 518 char 15 count 1">)</span><span class=pc2 title="line 517 char 5 count 1">)</span>
           <span class=pc2 title="line 517 char 5 count 1">(R </span><span class=pc2 title="line 519 char 15 count 1">(</span><span class=pc2 title="line 519 char 16 count 1">reify-S</span><span class=pc2 title="line 519 char 15 count 1"> </span><span class=pc2 title="line 519 char 24 count 1">v</span><span class=pc2 title="line 519 char 15 count 1"> </span><span class=pc2 title="line 519 char 26 count 1">(</span><span class=pc2 title="line 519 char 27 count 1">subst</span><span class=pc2 title="line 519 char 26 count 1"> </span><span class=pc2 title="line 519 char 33 count 1">empty-subst-map</span><span class=pc2 title="line 519 char 26 count 1"> </span><span class=pc2 title="line 519 char 49 count 1">nonlocal-scope</span><span class=pc2 title="line 519 char 26 count 1">)</span><span class=pc2 title="line 519 char 15 count 1">)</span><span class=pc2 title="line 517 char 5 count 1">)</span>
           <span class=pc2 title="line 517 char 5 count 1">(relevant-vars </span><span class=pc2 title="line 520 char 27 count 1">(</span><span class=pc2 title="line 520 char 28 count 1">vars</span><span class=pc2 title="line 520 char 27 count 1"> </span><span class=pc2 title="line 520 char 33 count 1">v</span><span class=pc2 title="line 520 char 27 count 1">)</span><span class=pc2 title="line 517 char 5 count 1">))</span>
      <span class=pc2 title="line 521 char 7 count 1">(let*-values (((T D A) </span><span class=pc2 title="line 521 char 30 count 1">(</span><span class=pc2 title="line 521 char 31 count 1">extract-and-normalize</span><span class=pc2 title="line 521 char 30 count 1"> </span><span class=pc2 title="line 521 char 53 count 1">st</span><span class=pc2 title="line 521 char 30 count 1"> </span><span class=pc2 title="line 521 char 56 count 1">relevant-vars</span><span class=pc2 title="line 521 char 30 count 1"> </span><span class=pc2 title="line 521 char 70 count 1">x</span><span class=pc2 title="line 521 char 30 count 1">)</span><span class=pc2 title="line 521 char 7 count 1">)</span>
                    <span class=pc2 title="line 521 char 7 count 1">((D A)   </span><span class=pc2 title="line 522 char 30 count 1">(</span><span class=pc2 title="line 522 char 31 count 1">drop-irrelevant</span><span class=pc2 title="line 522 char 30 count 1"> </span><span class=pc2 title="line 522 char 47 count 1">D</span><span class=pc2 title="line 522 char 30 count 1"> </span><span class=pc2 title="line 522 char 49 count 1">A</span><span class=pc2 title="line 522 char 30 count 1"> </span><span class=pc2 title="line 522 char 51 count 1">relevant-vars</span><span class=pc2 title="line 522 char 30 count 1">)</span><span class=pc2 title="line 521 char 7 count 1">)</span>
                    <span class=pc2 title="line 521 char 7 count 1">((D A)   </span><span class=pc2 title="line 523 char 30 count 1">(</span><span class=pc2 title="line 523 char 31 count 1">drop-subsumed</span><span class=pc2 title="line 523 char 30 count 1"> </span><span class=pc2 title="line 523 char 45 count 1">D</span><span class=pc2 title="line 523 char 30 count 1"> </span><span class=pc2 title="line 523 char 47 count 1">A</span><span class=pc2 title="line 523 char 30 count 1"> </span><span class=pc2 title="line 523 char 49 count 1">st</span><span class=pc2 title="line 523 char 30 count 1">)</span><span class=pc2 title="line 521 char 7 count 1">))</span>
        <span class=pc2 title="line 524 char 9 count 1">(</span><span class=pc2 title="line 524 char 10 count 1">form</span><span class=pc2 title="line 524 char 9 count 1"> </span><span class=pc2 title="line 524 char 15 count 1">(</span><span class=pc2 title="line 524 char 16 count 1">walk*</span><span class=pc2 title="line 524 char 15 count 1"> </span><span class=pc2 title="line 524 char 22 count 1">v</span><span class=pc2 title="line 524 char 15 count 1"> </span><span class=pc2 title="line 524 char 24 count 1">R</span><span class=pc2 title="line 524 char 15 count 1">)</span>
              <span class=pc2 title="line 525 char 15 count 1">(</span><span class=pc2 title="line 525 char 16 count 1">walk*</span><span class=pc2 title="line 525 char 15 count 1"> </span><span class=pc2 title="line 525 char 22 count 1">D</span><span class=pc2 title="line 525 char 15 count 1"> </span><span class=pc2 title="line 525 char 24 count 1">R</span><span class=pc2 title="line 525 char 15 count 1">)</span>
              <span class=pc2 title="line 526 char 15 count 1">(</span><span class=pc2 title="line 526 char 16 count 1">walk*</span><span class=pc2 title="line 526 char 15 count 1"> </span><span class=pc2 title="line 526 char 22 count 1">T</span><span class=pc2 title="line 526 char 15 count 1"> </span><span class=pc2 title="line 526 char 24 count 1">R</span><span class=pc2 title="line 526 char 15 count 1">)</span>
              <span class=pc2 title="line 527 char 15 count 1">(</span><span class=pc2 title="line 527 char 16 count 1">walk*</span><span class=pc2 title="line 527 char 15 count 1"> </span><span class=pc2 title="line 527 char 22 count 1">A</span><span class=pc2 title="line 527 char 15 count 1"> </span><span class=pc2 title="line 527 char 24 count 1">R</span><span class=pc2 title="line 527 char 15 count 1">)</span><span class=pc2 title="line 524 char 9 count 1">)</span><span class=pc2 title="line 521 char 7 count 1">)</span><span class=pc2 title="line 517 char 5 count 1">)</span><span class=pc2 title="line 516 char 3 count 1">)</span><span class=pc2 title="line 515 char 1 count 1">)</span>

<span class=pc2 title="line 529 char 1 count 1">(define (vars term)</span>
  <span class=pc2 title="line 530 char 3 count 155,806">(let rec ((term </span><span class=pc2 title="line 530 char 19 count 155,806">term</span><span class=pc2 title="line 530 char 3 count 155,806">) (acc </span><span class=pc2 title="line 530 char 30 count 155,806">'()</span><span class=pc2 title="line 530 char 3 count 155,806">))</span>
    <span class=pc2 title="line 531 char 5 count 5,398,452">(cond</span>
      <span class=pc2 title="line 531 char 5 count 5,398,452">(</span><span class=pc2 title="line 532 char 8 count 5,398,452">(</span><span class=pc2 title="line 532 char 9 count 5,398,452">var?</span><span class=pc2 title="line 532 char 8 count 5,398,452"> </span><span class=pc2 title="line 532 char 14 count 5,398,452">term</span><span class=pc2 title="line 532 char 8 count 5,398,452">)</span><span class=pc2 title="line 531 char 5 count 5,398,452"> </span><span class=pc2 title="line 532 char 20 count 2,543,867">(</span><span class=pc2 title="line 532 char 21 count 2,543,867">cons</span><span class=pc2 title="line 532 char 20 count 2,543,867"> </span><span class=pc2 title="line 532 char 26 count 2,543,867">term</span><span class=pc2 title="line 532 char 20 count 2,543,867"> </span><span class=pc2 title="line 532 char 31 count 2,543,867">acc</span><span class=pc2 title="line 532 char 20 count 2,543,867">)</span><span class=pc2 title="line 531 char 5 count 5,398,452">)</span>
      <span class=pc2 title="line 531 char 5 count 5,398,452">(</span><span class=pc2 title="line 533 char 8 count 2,854,585">(</span><span class=pc2 title="line 533 char 9 count 2,854,585">pair?</span><span class=pc2 title="line 533 char 8 count 2,854,585"> </span><span class=pc2 title="line 533 char 15 count 2,854,585">term</span><span class=pc2 title="line 533 char 8 count 2,854,585">)</span>
       <span class=pc2 title="line 534 char 8 count 2,621,323">(</span><span class=pc2 title="line 534 char 9 count 2,621,323">rec</span><span class=pc2 title="line 534 char 8 count 2,621,323"> </span><span class=pc2 title="line 534 char 13 count 2,621,323">(</span><span class=pc2 title="line 534 char 14 count 2,621,323">cdr</span><span class=pc2 title="line 534 char 13 count 2,621,323"> </span><span class=pc2 title="line 534 char 18 count 2,621,323">term</span><span class=pc2 title="line 534 char 13 count 2,621,323">)</span><span class=pc2 title="line 534 char 8 count 2,621,323"> </span><span class=pc2 title="line 534 char 24 count 2,621,323">(</span><span class=pc2 title="line 534 char 25 count 2,621,323">rec</span><span class=pc2 title="line 534 char 24 count 2,621,323"> </span><span class=pc2 title="line 534 char 29 count 2,621,323">(</span><span class=pc2 title="line 534 char 30 count 2,621,323">car</span><span class=pc2 title="line 534 char 29 count 2,621,323"> </span><span class=pc2 title="line 534 char 34 count 2,621,323">term</span><span class=pc2 title="line 534 char 29 count 2,621,323">)</span><span class=pc2 title="line 534 char 24 count 2,621,323"> </span><span class=pc2 title="line 534 char 40 count 2,621,323">acc</span><span class=pc2 title="line 534 char 24 count 2,621,323">)</span><span class=pc2 title="line 534 char 8 count 2,621,323">)</span><span class=pc2 title="line 531 char 5 count 5,398,452">)</span>
      <span class=pc2 title="line 531 char 5 count 5,398,452">(else </span><span class=pc2 title="line 535 char 13 count 233,262">(</span><span class=pc2 title="line 535 char 14 count 233,262">remove-duplicates</span><span class=pc2 title="line 535 char 13 count 233,262"> </span><span class=pc2 title="line 535 char 32 count 233,262">acc</span><span class=pc2 title="line 535 char 13 count 233,262">)</span><span class=pc2 title="line 531 char 5 count 5,398,452">))</span><span class=pc2 title="line 530 char 3 count 155,806">)</span><span class=pc2 title="line 529 char 1 count 1">)</span>

<span class=pc2 title="line 537 char 1 count 1">(define (extract-and-normalize st relevant-vars x)</span>
  <span class=pc2 title="line 537 char 1 count 1">(define T </span><span class=pc2 title="line 538 char 13 count 1">(</span><span class=pc2 title="line 538 char 14 count 1">map</span><span class=pc2 title="line 538 char 13 count 1"> </span><span class=pc2 title="line 538 char 18 count 1">(lambda (tc-type)</span>
                   <span class=pc2 title="line 539 char 20 count 3">(</span><span class=pc2 title="line 539 char 21 count 3">cons</span><span class=pc2 title="line 539 char 20 count 3"> </span><span class=pc2 title="line 539 char 26 count 3">(</span><span class=pc2 title="line 539 char 27 count 3">type-constraint-reified</span><span class=pc2 title="line 539 char 26 count 3"> </span><span class=pc2 title="line 539 char 51 count 3">tc-type</span><span class=pc2 title="line 539 char 26 count 3">)</span>
                         <span class=pc2 title="line 540 char 26 count 3">(</span><span class=pc2 title="line 540 char 27 count 3">filter-map</span><span class=pc2 title="line 540 char 26 count 3"> </span><span class=pc2 title="line 540 char 38 count 3">(lambda (x)</span>
                                       <span class=pc2 title="line 541 char 40 count 6">(let ((tc </span><span class=pc2 title="line 541 char 50 count 6">(</span><span class=pc2 title="line 541 char 51 count 6">c-T</span><span class=pc2 title="line 541 char 50 count 6"> </span><span class=pc2 title="line 541 char 55 count 6">(</span><span class=pc2 title="line 541 char 56 count 6">lookup-c</span><span class=pc2 title="line 541 char 55 count 6"> </span><span class=pc2 title="line 541 char 65 count 6">st</span><span class=pc2 title="line 541 char 55 count 6"> </span><span class=pc2 title="line 541 char 68 count 6">x</span><span class=pc2 title="line 541 char 55 count 6">)</span><span class=pc2 title="line 541 char 50 count 6">)</span><span class=pc2 title="line 541 char 40 count 6">))</span>
                                         <span class=pc2 title="line 542 char 42 count 6">(and </span><span class=pc2 title="line 542 char 47 count 6">(</span><span class=pc2 title="line 542 char 48 count 6">eq?</span><span class=pc2 title="line 542 char 47 count 6"> </span><span class=pc2 title="line 542 char 52 count 6">tc</span><span class=pc2 title="line 542 char 47 count 6"> </span><span class=pc2 title="line 542 char 55 count 6">tc-type</span><span class=pc2 title="line 542 char 47 count 6">)</span>
                                              <span class=pc2 title="line 543 char 47 count 2">x</span><span class=pc2 title="line 542 char 42 count 6">)</span><span class=pc2 title="line 541 char 40 count 6">)</span><span class=pc2 title="line 540 char 38 count 3">)</span>
                                     <span class=pc2 title="line 544 char 38 count 3">relevant-vars</span><span class=pc2 title="line 540 char 26 count 3">)</span><span class=pc2 title="line 539 char 20 count 3">)</span><span class=pc2 title="line 538 char 18 count 1">)</span>
                 <span class=pc2 title="line 545 char 18 count 1">type-constraints</span><span class=pc2 title="line 538 char 13 count 1">)</span><span class=pc2 title="line 537 char 1 count 1">)</span>
  <span class=pc2 title="line 537 char 1 count 1">(define D </span><span class=pc2 title="line 546 char 13 count 1">(</span><span class=pc2 title="line 546 char 14 count 1">append*</span>
              <span class=pc2 title="line 547 char 15 count 1">(</span><span class=pc2 title="line 547 char 16 count 1">map</span><span class=pc2 title="line 547 char 15 count 1"> </span><span class=pc2 title="line 547 char 20 count 1">(lambda (x)</span>
                     <span class=pc2 title="line 548 char 22 count 2">(</span><span class=pc2 title="line 548 char 23 count 2">filter-map</span><span class=pc2 title="line 548 char 22 count 2"> </span><span class=pc2 title="line 548 char 34 count 2">(</span><span class=pc2 title="line 548 char 35 count 2">normalize-diseq</span><span class=pc2 title="line 548 char 34 count 2"> </span><span class=pc2 title="line 548 char 51 count 2">(</span><span class=pc2 title="line 548 char 52 count 2">state-S</span><span class=pc2 title="line 548 char 51 count 2"> </span><span class=pc2 title="line 548 char 60 count 2">st</span><span class=pc2 title="line 548 char 51 count 2">)</span><span class=pc2 title="line 548 char 34 count 2">)</span><span class=pc2 title="line 548 char 22 count 2"> </span><span class=pc2 title="line 548 char 65 count 2">(</span><span class=pc2 title="line 548 char 66 count 2">c-D</span><span class=pc2 title="line 548 char 65 count 2"> </span><span class=pc2 title="line 548 char 70 count 2">(</span><span class=pc2 title="line 548 char 71 count 2">lookup-c</span><span class=pc2 title="line 548 char 70 count 2"> </span><span class=pc2 title="line 548 char 80 count 2">st</span><span class=pc2 title="line 548 char 70 count 2"> </span><span class=pc2 title="line 548 char 83 count 2">x</span><span class=pc2 title="line 548 char 70 count 2">)</span><span class=pc2 title="line 548 char 65 count 2">)</span><span class=pc2 title="line 548 char 22 count 2">)</span><span class=pc2 title="line 547 char 20 count 1">)</span>
                   <span class=pc2 title="line 549 char 20 count 1">relevant-vars</span><span class=pc2 title="line 547 char 15 count 1">)</span><span class=pc2 title="line 546 char 13 count 1">)</span><span class=pc2 title="line 537 char 1 count 1">)</span>
  <span class=pc2 title="line 537 char 1 count 1">(define A </span><span class=pc2 title="line 550 char 13 count 1">(</span><span class=pc2 title="line 550 char 14 count 1">append*</span>
              <span class=pc2 title="line 551 char 15 count 1">(</span><span class=pc2 title="line 551 char 16 count 1">map</span><span class=pc2 title="line 551 char 15 count 1"> </span><span class=pc2 title="line 551 char 20 count 1">(lambda (x)</span>
                     <span class=pc2 title="line 552 char 22 count 2">(</span><span class=pc2 title="line 552 char 23 count 2">map</span><span class=pc2 title="line 552 char 22 count 2"> </span><span class=pc2 title="line 552 char 27 count 2">(lambda (a-lhs)</span>
                            <span class=pc2 title="line 553 char 29 count 10">(</span><span class=pc2 title="line 553 char 30 count 10">cons</span><span class=pc2 title="line 553 char 29 count 10"> </span><span class=pc2 title="line 553 char 35 count 10">(</span><span class=pc2 title="line 553 char 36 count 10">walk*</span><span class=pc2 title="line 553 char 35 count 10"> </span><span class=pc2 title="line 553 char 42 count 10">a-lhs</span><span class=pc2 title="line 553 char 35 count 10"> </span><span class=pc2 title="line 553 char 48 count 10">(</span><span class=pc2 title="line 553 char 49 count 10">state-S</span><span class=pc2 title="line 553 char 48 count 10"> </span><span class=pc2 title="line 553 char 57 count 10">st</span><span class=pc2 title="line 553 char 48 count 10">)</span><span class=pc2 title="line 553 char 35 count 10">)</span>
                                  <span class=pc2 title="line 554 char 35 count 10">x</span><span class=pc2 title="line 553 char 29 count 10">)</span><span class=pc2 title="line 552 char 27 count 2">)</span>
                          <span class=pc2 title="line 555 char 27 count 2">(</span><span class=pc2 title="line 555 char 28 count 2">c-A</span><span class=pc2 title="line 555 char 27 count 2"> </span><span class=pc2 title="line 555 char 32 count 2">(</span><span class=pc2 title="line 555 char 33 count 2">lookup-c</span><span class=pc2 title="line 555 char 32 count 2"> </span><span class=pc2 title="line 555 char 42 count 2">st</span><span class=pc2 title="line 555 char 32 count 2"> </span><span class=pc2 title="line 555 char 45 count 2">x</span><span class=pc2 title="line 555 char 32 count 2">)</span><span class=pc2 title="line 555 char 27 count 2">)</span><span class=pc2 title="line 552 char 22 count 2">)</span><span class=pc2 title="line 551 char 20 count 1">)</span>
                   <span class=pc2 title="line 556 char 20 count 1">relevant-vars</span><span class=pc2 title="line 551 char 15 count 1">)</span><span class=pc2 title="line 550 char 13 count 1">)</span><span class=pc2 title="line 537 char 1 count 1">)</span>

  <span class=pc2 title="line 558 char 3 count 1">(</span><span class=pc2 title="line 558 char 4 count 1">values</span><span class=pc2 title="line 558 char 3 count 1"> </span><span class=pc2 title="line 558 char 11 count 1">T</span><span class=pc2 title="line 558 char 3 count 1"> </span><span class=pc2 title="line 558 char 13 count 1">D</span><span class=pc2 title="line 558 char 3 count 1"> </span><span class=pc2 title="line 558 char 15 count 1">A</span><span class=pc2 title="line 558 char 3 count 1">)</span><span class=pc2 title="line 537 char 1 count 1">)</span>

<span class=pc2 title="line 560 char 1 count 1">(define (normalize-diseq S)</span>
  <span class=pc2 title="line 561 char 3 count 2">(lambda (S+)</span>
    <span class=pc2 title="line 562 char 5 count 142">(let-values (((S^ S+^) </span><span class=pc2 title="line 562 char 28 count 142">(</span><span class=pc2 title="line 562 char 29 count 142">unify*</span><span class=pc2 title="line 562 char 28 count 142"> </span><span class=pc2 title="line 562 char 36 count 142">S+</span><span class=pc2 title="line 562 char 28 count 142"> </span><span class=pc2 title="line 562 char 39 count 142">S</span><span class=pc2 title="line 562 char 28 count 142">)</span><span class=pc2 title="line 562 char 5 count 142">))</span>
      <span class=pc2 title="line 563 char 7 count 142">(and </span><span class=pc2 title="line 563 char 12 count 142">S^</span><span class=pc2 title="line 563 char 7 count 142"> </span><span class=pc2 title="line 563 char 15 count 142">(</span><span class=pc2 title="line 563 char 16 count 142">walk*</span><span class=pc2 title="line 563 char 15 count 142"> </span><span class=pc2 title="line 563 char 22 count 142">S+^</span><span class=pc2 title="line 563 char 15 count 142"> </span><span class=pc2 title="line 563 char 26 count 142">S</span><span class=pc2 title="line 563 char 15 count 142">)</span><span class=pc2 title="line 563 char 7 count 142">)</span><span class=pc2 title="line 562 char 5 count 142">)</span><span class=pc2 title="line 561 char 3 count 2">)</span><span class=pc2 title="line 560 char 1 count 1">)</span>

; Drop constraints that are satisfiable in any assignment of the reified
; variables, because they refer to unassigned variables that are not part of
; the answer, which can be assigned as needed to satisfy the constraint.
<span class=pc2 title="line 568 char 1 count 1">(define (drop-irrelevant D A relevant-vars)</span>
  <span class=pc2 title="line 569 char 3 count 1">(define (all-relevant? t)</span>
    <span class=pc2 title="line 570 char 5 count 152">(</span><span class=pc2 title="line 570 char 6 count 152">andmap</span><span class=pc2 title="line 570 char 5 count 152"> </span><span class=pc2 title="line 570 char 13 count 152">(lambda (v) </span><span class=pc2 title="line 570 char 25 count 170">(</span><span class=pc2 title="line 570 char 26 count 170">member</span><span class=pc2 title="line 570 char 25 count 170"> </span><span class=pc2 title="line 570 char 33 count 170">v</span><span class=pc2 title="line 570 char 25 count 170"> </span><span class=pc2 title="line 570 char 35 count 170">relevant-vars</span><span class=pc2 title="line 570 char 25 count 170">)</span><span class=pc2 title="line 570 char 13 count 152">)</span>
            <span class=pc2 title="line 571 char 13 count 152">(</span><span class=pc2 title="line 571 char 14 count 152">vars</span><span class=pc2 title="line 571 char 13 count 152"> </span><span class=pc2 title="line 571 char 19 count 152">t</span><span class=pc2 title="line 571 char 13 count 152">)</span><span class=pc2 title="line 570 char 5 count 152">)</span><span class=pc2 title="line 569 char 3 count 1">)</span>
  <span class=pc2 title="line 572 char 3 count 1">(</span><span class=pc2 title="line 572 char 4 count 1">values</span><span class=pc2 title="line 572 char 3 count 1"> </span><span class=pc2 title="line 572 char 11 count 1">(</span><span class=pc2 title="line 572 char 12 count 1">filter</span><span class=pc2 title="line 572 char 11 count 1"> </span><span class=pc2 title="line 572 char 19 count 1">all-relevant?</span><span class=pc2 title="line 572 char 11 count 1"> </span><span class=pc2 title="line 572 char 33 count 1">D</span><span class=pc2 title="line 572 char 11 count 1">)</span>
          <span class=pc2 title="line 573 char 11 count 1">(</span><span class=pc2 title="line 573 char 12 count 1">filter</span><span class=pc2 title="line 573 char 11 count 1"> </span><span class=pc2 title="line 573 char 19 count 1">all-relevant?</span><span class=pc2 title="line 573 char 11 count 1"> </span><span class=pc2 title="line 573 char 33 count 1">A</span><span class=pc2 title="line 573 char 11 count 1">)</span><span class=pc2 title="line 572 char 3 count 1">)</span><span class=pc2 title="line 568 char 1 count 1">)</span>


<span class=pc2 title="line 576 char 1 count 1">(define (drop-subsumed D A st)</span>
  <span class=pc2 title="line 576 char 1 count 1">(define D^ </span><span class=pc2 title="line 577 char 14 count 1">(</span><span class=pc2 title="line 577 char 15 count 1">rem-subsumed</span>
                 <span class=pc2 title="line 578 char 18 count 1">d-subsumed-by?</span>
                 <span class=pc2 title="line 579 char 18 count 1">(</span><span class=pc2 title="line 579 char 19 count 1">filter</span><span class=pc2 title="line 579 char 18 count 1"> </span><span class=pc2 title="line 579 char 26 count 1">(lambda (d)</span>
                           <span class=pc2 title="line 580 char 28 count 142">(</span><span class=pc2 title="line 580 char 29 count 142">not</span><span class=pc2 title="line 580 char 28 count 142"> </span><span class=pc2 title="line 580 char 33 count 142">(or </span><span class=pc2 title="line 580 char 37 count 142">(</span><span class=pc2 title="line 580 char 38 count 142">d-subsumed-by-T?</span><span class=pc2 title="line 580 char 37 count 142"> </span><span class=pc2 title="line 580 char 55 count 142">d</span><span class=pc2 title="line 580 char 37 count 142"> </span><span class=pc2 title="line 580 char 57 count 142">st</span><span class=pc2 title="line 580 char 37 count 142">)</span>
                                    <span class=pc2 title="line 581 char 37 count 92">(</span><span class=pc2 title="line 581 char 38 count 92">d-subsumed-by-A?</span><span class=pc2 title="line 581 char 37 count 92"> </span><span class=pc2 title="line 581 char 55 count 92">d</span><span class=pc2 title="line 581 char 37 count 92"> </span><span class=pc2 title="line 581 char 57 count 92">A</span><span class=pc2 title="line 581 char 37 count 92"> </span><span class=pc2 title="line 581 char 59 count 92">st</span><span class=pc2 title="line 581 char 37 count 92">)</span><span class=pc2 title="line 580 char 33 count 142">)</span><span class=pc2 title="line 580 char 28 count 142">)</span><span class=pc2 title="line 579 char 26 count 1">)</span>
                         <span class=pc2 title="line 582 char 26 count 1">D</span><span class=pc2 title="line 579 char 18 count 1">)</span><span class=pc2 title="line 577 char 14 count 1">)</span><span class=pc2 title="line 576 char 1 count 1">)</span>
  <span class=pc2 title="line 576 char 1 count 1">(define A^ </span><span class=pc2 title="line 583 char 14 count 1">(</span><span class=pc2 title="line 583 char 15 count 1">rem-subsumed</span>
                 <span class=pc2 title="line 584 char 18 count 1">a-subsumed-by?</span>
                 <span class=pc2 title="line 585 char 18 count 1">(</span><span class=pc2 title="line 585 char 19 count 1">filter</span><span class=pc2 title="line 585 char 18 count 1"> </span><span class=pc2 title="line 585 char 26 count 1">(lambda (a)</span>
                           <span class=pc2 title="line 586 char 28 count 10">(</span><span class=pc2 title="line 586 char 29 count 10">not</span><span class=pc2 title="line 586 char 28 count 10"> </span><span class=pc2 title="line 586 char 33 count 10">(or </span><span class=pc2 title="line 586 char 37 count 10">(</span><span class=pc2 title="line 586 char 38 count 10">absento-rhs-atomic?</span><span class=pc2 title="line 586 char 37 count 10"> </span><span class=pc2 title="line 586 char 58 count 10">a</span><span class=pc2 title="line 586 char 37 count 10"> </span><span class=pc2 title="line 586 char 60 count 10">st</span><span class=pc2 title="line 586 char 37 count 10">)</span>
                                    <span class=pc1 title="line 587 char 37 count 0">(</span><span class=pc1 title="line 587 char 38 count 0">absento-rhs-occurs-lhs?</span><span class=pc1 title="line 587 char 37 count 0"> </span><span class=pc1 title="line 587 char 62 count 0">a</span><span class=pc1 title="line 587 char 37 count 0"> </span><span class=pc1 title="line 587 char 64 count 0">st</span><span class=pc1 title="line 587 char 37 count 0">)</span><span class=pc2 title="line 586 char 33 count 10">)</span><span class=pc2 title="line 586 char 28 count 10">)</span><span class=pc2 title="line 585 char 26 count 1">)</span>
                         <span class=pc2 title="line 588 char 26 count 1">A</span><span class=pc2 title="line 585 char 18 count 1">)</span><span class=pc2 title="line 583 char 14 count 1">)</span><span class=pc2 title="line 576 char 1 count 1">)</span>
  <span class=pc2 title="line 589 char 3 count 1">(</span><span class=pc2 title="line 589 char 4 count 1">values</span><span class=pc2 title="line 589 char 3 count 1"> </span><span class=pc2 title="line 589 char 11 count 1">D^</span><span class=pc2 title="line 589 char 3 count 1"> </span><span class=pc2 title="line 589 char 14 count 1">A^</span><span class=pc2 title="line 589 char 3 count 1">)</span><span class=pc2 title="line 576 char 1 count 1">)</span>

; Drop absento constraints where the RHS is known to be atomic, such that
; the disequality attached by absento solving is sufficient.
<span class=pc2 title="line 593 char 1 count 1">(define (absento-rhs-atomic? a st)</span>
  <span class=pc2 title="line 593 char 1 count 1">; absento on pairs is pushed down and type constraints are atomic,</span>
  <span class=pc2 title="line 593 char 1 count 1">; so the only kind of non-atomic RHS is an untyped var.</span>
  <span class=pc2 title="line 596 char 3 count 930">(</span><span class=pc2 title="line 596 char 4 count 930">not</span><span class=pc2 title="line 596 char 3 count 930"> </span><span class=pc2 title="line 596 char 8 count 930">(and </span><span class=pc2 title="line 596 char 13 count 930">(</span><span class=pc2 title="line 596 char 14 count 930">var?</span><span class=pc2 title="line 596 char 13 count 930"> </span><span class=pc2 title="line 596 char 19 count 930">(</span><span class=pc2 title="line 596 char 20 count 930">rhs</span><span class=pc2 title="line 596 char 19 count 930"> </span><span class=pc2 title="line 596 char 24 count 930">a</span><span class=pc2 title="line 596 char 19 count 930">)</span><span class=pc2 title="line 596 char 13 count 930">)</span><span class=pc2 title="line 596 char 8 count 930"> </span><span class=pc2 title="line 596 char 28 count 930">(</span><span class=pc2 title="line 596 char 29 count 930">unbound?</span><span class=pc2 title="line 596 char 28 count 930"> </span><span class=pc2 title="line 596 char 38 count 930">(</span><span class=pc2 title="line 596 char 39 count 930">var-type</span><span class=pc2 title="line 596 char 38 count 930"> </span><span class=pc2 title="line 596 char 48 count 930">(</span><span class=pc2 title="line 596 char 49 count 930">rhs</span><span class=pc2 title="line 596 char 48 count 930"> </span><span class=pc2 title="line 596 char 53 count 930">a</span><span class=pc2 title="line 596 char 48 count 930">)</span><span class=pc2 title="line 596 char 38 count 930"> </span><span class=pc2 title="line 596 char 56 count 930">st</span><span class=pc2 title="line 596 char 38 count 930">)</span><span class=pc2 title="line 596 char 28 count 930">)</span><span class=pc2 title="line 596 char 8 count 930">)</span><span class=pc2 title="line 596 char 3 count 930">)</span><span class=pc2 title="line 593 char 1 count 1">)</span>

; Drop absento constraints that are trivially satisfied because
; any violation would cause a failure of the occurs check.
; Example:
;  (absento (list x y z) x) is trivially true because a violation would
;  require x to occur within itself.
<span class=pc2 title="line 603 char 1 count 1">(define (absento-rhs-occurs-lhs? a st)</span>
  <span class=pc1 title="line 604 char 3 count 0">(</span><span class=pc1 title="line 604 char 4 count 0">occurs-check</span><span class=pc1 title="line 604 char 3 count 0"> </span><span class=pc1 title="line 604 char 17 count 0">(</span><span class=pc1 title="line 604 char 18 count 0">rhs</span><span class=pc1 title="line 604 char 17 count 0"> </span><span class=pc1 title="line 604 char 22 count 0">a</span><span class=pc1 title="line 604 char 17 count 0">)</span><span class=pc1 title="line 604 char 3 count 0"> </span><span class=pc1 title="line 604 char 25 count 0">(</span><span class=pc1 title="line 604 char 26 count 0">lhs</span><span class=pc1 title="line 604 char 25 count 0"> </span><span class=pc1 title="line 604 char 30 count 0">a</span><span class=pc1 title="line 604 char 25 count 0">)</span><span class=pc1 title="line 604 char 3 count 0"> </span><span class=pc1 title="line 604 char 33 count 0">(</span><span class=pc1 title="line 604 char 34 count 0">state-S</span><span class=pc1 title="line 604 char 33 count 0"> </span><span class=pc1 title="line 604 char 42 count 0">st</span><span class=pc1 title="line 604 char 33 count 0">)</span><span class=pc1 title="line 604 char 3 count 0">)</span><span class=pc2 title="line 603 char 1 count 1">)</span>

; Drop disequalities that are subsumed by an absento contraint
; that is not itself equivalent to just a disequality.
<span class=pc2 title="line 608 char 1 count 1">(define (d-subsumed-by-A? d A st)</span>
  <span class=pc2 title="line 609 char 3 count 92">(</span><span class=pc2 title="line 609 char 4 count 92">exists</span><span class=pc2 title="line 609 char 3 count 92"> </span><span class=pc2 title="line 609 char 11 count 92">(lambda (a)</span>
            <span class=pc2 title="line 610 char 13 count 920">(and </span><span class=pc2 title="line 610 char 18 count 920">(</span><span class=pc2 title="line 610 char 19 count 920">not</span><span class=pc2 title="line 610 char 18 count 920"> </span><span class=pc2 title="line 610 char 23 count 920">(</span><span class=pc2 title="line 610 char 24 count 920">absento-rhs-atomic?</span><span class=pc2 title="line 610 char 23 count 920"> </span><span class=pc2 title="line 610 char 44 count 920">a</span><span class=pc2 title="line 610 char 23 count 920"> </span><span class=pc2 title="line 610 char 46 count 920">st</span><span class=pc2 title="line 610 char 23 count 920">)</span><span class=pc2 title="line 610 char 18 count 920">)</span>
                 <span class=pc1 title="line 611 char 18 count 0">(</span><span class=pc1 title="line 611 char 19 count 0">d-subsumed-by?</span><span class=pc1 title="line 611 char 18 count 0"> </span><span class=pc1 title="line 611 char 34 count 0">d</span><span class=pc1 title="line 611 char 18 count 0"> </span><span class=pc1 title="line 611 char 36 count 0">(</span><span class=pc1 title="line 611 char 37 count 0">absento-&gt;diseq</span><span class=pc1 title="line 611 char 36 count 0"> </span><span class=pc1 title="line 611 char 52 count 0">a</span><span class=pc1 title="line 611 char 36 count 0">)</span><span class=pc1 title="line 611 char 18 count 0">)</span><span class=pc2 title="line 610 char 13 count 920">)</span><span class=pc2 title="line 609 char 11 count 92">)</span>
          <span class=pc2 title="line 612 char 11 count 92">A</span><span class=pc2 title="line 609 char 3 count 92">)</span><span class=pc2 title="line 608 char 1 count 1">)</span>

; Drop disequalities that are fully satisfied because the types are disjoint
; either due to type constraints or ground values.
; Examples:
;  * given (symbolo x) and (numbero y), (=/= x y) is dropped.
<span class=pc2 title="line 618 char 1 count 1">(define (d-subsumed-by-T? d st)</span>
  <span class=pc2 title="line 619 char 3 count 142">(</span><span class=pc2 title="line 619 char 4 count 142">exists</span><span class=pc2 title="line 619 char 3 count 142"> </span><span class=pc2 title="line 619 char 11 count 142">(lambda (pr) </span><span class=pc2 title="line 619 char 24 count 142">(</span><span class=pc2 title="line 619 char 25 count 142">not</span><span class=pc2 title="line 619 char 24 count 142"> </span><span class=pc2 title="line 619 char 29 count 142">(</span><span class=pc2 title="line 619 char 30 count 142">var-types-match?</span><span class=pc2 title="line 619 char 29 count 142"> </span><span class=pc2 title="line 619 char 47 count 142">(</span><span class=pc2 title="line 619 char 48 count 142">lhs</span><span class=pc2 title="line 619 char 47 count 142"> </span><span class=pc2 title="line 619 char 52 count 142">pr</span><span class=pc2 title="line 619 char 47 count 142">)</span><span class=pc2 title="line 619 char 29 count 142"> </span><span class=pc2 title="line 619 char 56 count 142">(</span><span class=pc2 title="line 619 char 57 count 142">rhs</span><span class=pc2 title="line 619 char 56 count 142"> </span><span class=pc2 title="line 619 char 61 count 142">pr</span><span class=pc2 title="line 619 char 56 count 142">)</span><span class=pc2 title="line 619 char 29 count 142"> </span><span class=pc2 title="line 619 char 65 count 142">st</span><span class=pc2 title="line 619 char 29 count 142">)</span><span class=pc2 title="line 619 char 24 count 142">)</span><span class=pc2 title="line 619 char 11 count 142">)</span>
          <span class=pc2 title="line 620 char 11 count 142">d</span><span class=pc2 title="line 619 char 3 count 142">)</span><span class=pc2 title="line 618 char 1 count 1">)</span>

<span class=pc2 title="line 622 char 1 count 1">(define (var-types-match? t1 t2 st)</span>
  <span class=pc2 title="line 623 char 3 count 142">(or </span><span class=pc2 title="line 623 char 7 count 142">(</span><span class=pc2 title="line 623 char 8 count 142">unbound?</span><span class=pc2 title="line 623 char 7 count 142"> </span><span class=pc2 title="line 623 char 17 count 142">(</span><span class=pc2 title="line 623 char 18 count 142">var-type</span><span class=pc2 title="line 623 char 17 count 142"> </span><span class=pc2 title="line 623 char 27 count 142">t1</span><span class=pc2 title="line 623 char 17 count 142"> </span><span class=pc2 title="line 623 char 30 count 142">st</span><span class=pc2 title="line 623 char 17 count 142">)</span><span class=pc2 title="line 623 char 7 count 142">)</span>
      <span class=pc2 title="line 624 char 7 count 142">(if </span><span class=pc2 title="line 624 char 11 count 142">(</span><span class=pc2 title="line 624 char 12 count 142">var?</span><span class=pc2 title="line 624 char 11 count 142"> </span><span class=pc2 title="line 624 char 17 count 142">t2</span><span class=pc2 title="line 624 char 11 count 142">)</span>
        <span class=pc2 title="line 625 char 9 count 18">(or </span><span class=pc2 title="line 625 char 13 count 18">(</span><span class=pc2 title="line 625 char 14 count 18">unbound?</span><span class=pc2 title="line 625 char 13 count 18"> </span><span class=pc2 title="line 625 char 23 count 18">(</span><span class=pc2 title="line 625 char 24 count 18">var-type</span><span class=pc2 title="line 625 char 23 count 18"> </span><span class=pc2 title="line 625 char 33 count 18">t2</span><span class=pc2 title="line 625 char 23 count 18"> </span><span class=pc2 title="line 625 char 36 count 18">st</span><span class=pc2 title="line 625 char 23 count 18">)</span><span class=pc2 title="line 625 char 13 count 18">)</span>
            <span class=pc2 title="line 626 char 13 count 18">(</span><span class=pc2 title="line 626 char 14 count 18">eq?</span><span class=pc2 title="line 626 char 13 count 18"> </span><span class=pc2 title="line 626 char 18 count 18">(</span><span class=pc2 title="line 626 char 19 count 18">var-type</span><span class=pc2 title="line 626 char 18 count 18"> </span><span class=pc2 title="line 626 char 28 count 18">t1</span><span class=pc2 title="line 626 char 18 count 18"> </span><span class=pc2 title="line 626 char 31 count 18">st</span><span class=pc2 title="line 626 char 18 count 18">)</span><span class=pc2 title="line 626 char 13 count 18"> </span><span class=pc2 title="line 626 char 35 count 18">(</span><span class=pc2 title="line 626 char 36 count 18">var-type</span><span class=pc2 title="line 626 char 35 count 18"> </span><span class=pc2 title="line 626 char 45 count 18">t2</span><span class=pc2 title="line 626 char 35 count 18"> </span><span class=pc2 title="line 626 char 48 count 18">st</span><span class=pc2 title="line 626 char 35 count 18">)</span><span class=pc2 title="line 626 char 13 count 18">)</span><span class=pc2 title="line 625 char 9 count 18">)</span>
        <span class=pc2 title="line 627 char 9 count 124">(</span><span class=pc2 title="line 627 char 10 count 124">(</span><span class=pc2 title="line 627 char 11 count 124">type-constraint-predicate</span><span class=pc2 title="line 627 char 10 count 124"> </span><span class=pc2 title="line 627 char 37 count 124">(</span><span class=pc2 title="line 627 char 38 count 124">var-type</span><span class=pc2 title="line 627 char 37 count 124"> </span><span class=pc2 title="line 627 char 47 count 124">t1</span><span class=pc2 title="line 627 char 37 count 124"> </span><span class=pc2 title="line 627 char 50 count 124">st</span><span class=pc2 title="line 627 char 37 count 124">)</span><span class=pc2 title="line 627 char 10 count 124">)</span>
         <span class=pc2 title="line 628 char 10 count 124">t2</span><span class=pc2 title="line 627 char 9 count 124">)</span><span class=pc2 title="line 624 char 7 count 142">)</span><span class=pc2 title="line 623 char 3 count 142">)</span><span class=pc2 title="line 622 char 1 count 1">)</span>

<span class=pc2 title="line 630 char 1 count 1">(define (var-type x st) </span><span class=pc2 title="line 630 char 25 count 1,250">(or </span><span class=pc2 title="line 630 char 29 count 1,250">(</span><span class=pc2 title="line 630 char 30 count 1,250">c-T</span><span class=pc2 title="line 630 char 29 count 1,250"> </span><span class=pc2 title="line 630 char 34 count 1,250">(</span><span class=pc2 title="line 630 char 35 count 1,250">lookup-c</span><span class=pc2 title="line 630 char 34 count 1,250"> </span><span class=pc2 title="line 630 char 44 count 1,250">st</span><span class=pc2 title="line 630 char 34 count 1,250"> </span><span class=pc2 title="line 630 char 47 count 1,250">x</span><span class=pc2 title="line 630 char 34 count 1,250">)</span><span class=pc2 title="line 630 char 29 count 1,250">)</span><span class=pc2 title="line 630 char 25 count 1,250"> </span><span class=pc1 title="line 630 char 51 count 0">unbound</span><span class=pc2 title="line 630 char 25 count 1,250">)</span><span class=pc2 title="line 630 char 1 count 1">)</span>

<span class=pc2 title="line 632 char 1 count 1">(define (absento-&gt;diseq t) </span><span class=pc1 title="line 632 char 28 count 0">(</span><span class=pc1 title="line 632 char 29 count 0">list</span><span class=pc1 title="line 632 char 28 count 0"> </span><span class=pc1 title="line 632 char 34 count 0">t</span><span class=pc1 title="line 632 char 28 count 0">)</span><span class=pc2 title="line 632 char 1 count 1">)</span>

<span class=pc2 title="line 634 char 1 count 1">(define (rem-subsumed subsumed-by? el*)</span>
  <span class=pc2 title="line 635 char 3 count 2">(define (subsumed-by-one-of? el el*)</span>
    <span class=pc2 title="line 636 char 5 count 101">(</span><span class=pc2 title="line 636 char 6 count 101">ormap</span><span class=pc2 title="line 636 char 5 count 101"> </span><span class=pc2 title="line 636 char 12 count 101">(lambda (el2) </span><span class=pc2 title="line 636 char 26 count 653">(</span><span class=pc2 title="line 636 char 27 count 653">subsumed-by?</span><span class=pc2 title="line 636 char 26 count 653"> </span><span class=pc2 title="line 636 char 40 count 653">el</span><span class=pc2 title="line 636 char 26 count 653"> </span><span class=pc2 title="line 636 char 43 count 653">el2</span><span class=pc2 title="line 636 char 26 count 653">)</span><span class=pc2 title="line 636 char 12 count 101">)</span><span class=pc2 title="line 636 char 5 count 101"> </span><span class=pc2 title="line 636 char 49 count 101">el*</span><span class=pc2 title="line 636 char 5 count 101">)</span><span class=pc2 title="line 635 char 3 count 2">)</span>

  <span class=pc2 title="line 638 char 3 count 2">(let loop ((el* </span><span class=pc2 title="line 638 char 19 count 2">el*</span><span class=pc2 title="line 638 char 3 count 2">)</span>
             <span class=pc2 title="line 638 char 3 count 2">(result </span><span class=pc2 title="line 639 char 22 count 2">'()</span><span class=pc2 title="line 638 char 3 count 2">))</span>
    <span class=pc2 title="line 640 char 5 count 94">(cond</span>
      <span class=pc2 title="line 640 char 5 count 94">(</span><span class=pc2 title="line 641 char 8 count 94">(</span><span class=pc2 title="line 641 char 9 count 94">null?</span><span class=pc2 title="line 641 char 8 count 94"> </span><span class=pc2 title="line 641 char 15 count 94">el*</span><span class=pc2 title="line 641 char 8 count 94">)</span><span class=pc2 title="line 640 char 5 count 94"> </span><span class=pc2 title="line 641 char 20 count 2">result</span><span class=pc2 title="line 640 char 5 count 94">)</span>
      <span class=pc2 title="line 640 char 5 count 94">(else</span>
        <span class=pc2 title="line 643 char 9 count 92">(let ((el </span><span class=pc2 title="line 643 char 19 count 92">(</span><span class=pc2 title="line 643 char 20 count 92">car</span><span class=pc2 title="line 643 char 19 count 92"> </span><span class=pc2 title="line 643 char 24 count 92">el*</span><span class=pc2 title="line 643 char 19 count 92">)</span><span class=pc2 title="line 643 char 9 count 92">))</span>
          <span class=pc2 title="line 644 char 11 count 92">(cond</span>
            <span class=pc2 title="line 644 char 11 count 92">(</span><span class=pc2 title="line 645 char 14 count 92">(or </span><span class=pc2 title="line 645 char 18 count 92">(</span><span class=pc2 title="line 645 char 19 count 92">subsumed-by-one-of?</span><span class=pc2 title="line 645 char 18 count 92"> </span><span class=pc2 title="line 645 char 39 count 92">el</span><span class=pc2 title="line 645 char 18 count 92"> </span><span class=pc2 title="line 645 char 42 count 92">(</span><span class=pc2 title="line 645 char 43 count 92">cdr</span><span class=pc2 title="line 645 char 42 count 92"> </span><span class=pc2 title="line 645 char 47 count 92">el*</span><span class=pc2 title="line 645 char 42 count 92">)</span><span class=pc2 title="line 645 char 18 count 92">)</span>
                 <span class=pc2 title="line 646 char 18 count 9">(</span><span class=pc2 title="line 646 char 19 count 9">subsumed-by-one-of?</span><span class=pc2 title="line 646 char 18 count 9"> </span><span class=pc2 title="line 646 char 39 count 9">el</span><span class=pc2 title="line 646 char 18 count 9"> </span><span class=pc2 title="line 646 char 42 count 9">result</span><span class=pc2 title="line 646 char 18 count 9">)</span><span class=pc2 title="line 645 char 14 count 92">)</span>
             <span class=pc2 title="line 647 char 14 count 83">(</span><span class=pc2 title="line 647 char 15 count 83">loop</span><span class=pc2 title="line 647 char 14 count 83"> </span><span class=pc2 title="line 647 char 20 count 83">(</span><span class=pc2 title="line 647 char 21 count 83">cdr</span><span class=pc2 title="line 647 char 20 count 83"> </span><span class=pc2 title="line 647 char 25 count 83">el*</span><span class=pc2 title="line 647 char 20 count 83">)</span><span class=pc2 title="line 647 char 14 count 83"> </span><span class=pc2 title="line 647 char 30 count 83">result</span><span class=pc2 title="line 647 char 14 count 83">)</span><span class=pc2 title="line 644 char 11 count 92">)</span>
            <span class=pc2 title="line 644 char 11 count 92">(else </span><span class=pc2 title="line 648 char 19 count 9">(</span><span class=pc2 title="line 648 char 20 count 9">loop</span><span class=pc2 title="line 648 char 19 count 9"> </span><span class=pc2 title="line 648 char 25 count 9">(</span><span class=pc2 title="line 648 char 26 count 9">cdr</span><span class=pc2 title="line 648 char 25 count 9"> </span><span class=pc2 title="line 648 char 30 count 9">el*</span><span class=pc2 title="line 648 char 25 count 9">)</span>
                        <span class=pc2 title="line 649 char 25 count 9">(</span><span class=pc2 title="line 649 char 26 count 9">cons</span><span class=pc2 title="line 649 char 25 count 9"> </span><span class=pc2 title="line 649 char 31 count 9">el</span><span class=pc2 title="line 649 char 25 count 9"> </span><span class=pc2 title="line 649 char 34 count 9">result</span><span class=pc2 title="line 649 char 25 count 9">)</span><span class=pc2 title="line 648 char 19 count 9">)</span><span class=pc2 title="line 644 char 11 count 92">))</span><span class=pc2 title="line 643 char 9 count 92">)</span><span class=pc2 title="line 640 char 5 count 94">))</span><span class=pc2 title="line 638 char 3 count 2">)</span><span class=pc2 title="line 634 char 1 count 1">)</span>

; Examples:
; * (absento `(cat . ,S) y) is subsumed by (absento S y)
;
; Note that absento constraints are pushed down to tree leaves, so we would never have
;  (absento 'closure q) given (== q (list x)). Thus we do not need to consider subsumption
;  between absento constraints on q and x.
<span class=pc2 title="line 657 char 1 count 1">(define (a-subsumed-by? t1 t2)</span>
  <span class=pc1 title="line 658 char 3 count 0">(and </span><span class=pc1 title="line 658 char 8 count 0">(</span><span class=pc1 title="line 658 char 9 count 0">var-eq?</span><span class=pc1 title="line 658 char 8 count 0"> </span><span class=pc1 title="line 658 char 17 count 0">(</span><span class=pc1 title="line 658 char 18 count 0">rhs</span><span class=pc1 title="line 658 char 17 count 0"> </span><span class=pc1 title="line 658 char 22 count 0">t1</span><span class=pc1 title="line 658 char 17 count 0">)</span><span class=pc1 title="line 658 char 8 count 0"> </span><span class=pc1 title="line 658 char 26 count 0">(</span><span class=pc1 title="line 658 char 27 count 0">rhs</span><span class=pc1 title="line 658 char 26 count 0"> </span><span class=pc1 title="line 658 char 31 count 0">t2</span><span class=pc1 title="line 658 char 26 count 0">)</span><span class=pc1 title="line 658 char 8 count 0">)</span><span class=pc1 title="line 658 char 3 count 0"> </span><span class=pc1 title="line 658 char 36 count 0">(</span><span class=pc1 title="line 658 char 37 count 0">member*</span><span class=pc1 title="line 658 char 36 count 0"> </span><span class=pc1 title="line 658 char 45 count 0">(</span><span class=pc1 title="line 658 char 46 count 0">lhs</span><span class=pc1 title="line 658 char 45 count 0"> </span><span class=pc1 title="line 658 char 50 count 0">t2</span><span class=pc1 title="line 658 char 45 count 0">)</span><span class=pc1 title="line 658 char 36 count 0"> </span><span class=pc1 title="line 658 char 54 count 0">(</span><span class=pc1 title="line 658 char 55 count 0">lhs</span><span class=pc1 title="line 658 char 54 count 0"> </span><span class=pc1 title="line 658 char 59 count 0">t1</span><span class=pc1 title="line 658 char 54 count 0">)</span><span class=pc1 title="line 658 char 36 count 0">)</span><span class=pc1 title="line 658 char 3 count 0">)</span><span class=pc2 title="line 657 char 1 count 1">)</span>

<span class=pc2 title="line 660 char 1 count 1">(define (member* u v)</span>
  <span class=pc1 title="line 661 char 3 count 0">(cond</span>
    <span class=pc1 title="line 661 char 3 count 0">(</span><span class=pc1 title="line 662 char 6 count 0">(</span><span class=pc1 title="line 662 char 7 count 0">equal?</span><span class=pc1 title="line 662 char 6 count 0"> </span><span class=pc1 title="line 662 char 14 count 0">u</span><span class=pc1 title="line 662 char 6 count 0"> </span><span class=pc1 title="line 662 char 16 count 0">v</span><span class=pc1 title="line 662 char 6 count 0">)</span><span class=pc1 title="line 661 char 3 count 0"> </span><span class=pc1 title="line 662 char 19 count 0">#t</span><span class=pc1 title="line 661 char 3 count 0">)</span>
    <span class=pc1 title="line 661 char 3 count 0">(</span><span class=pc1 title="line 663 char 6 count 0">(</span><span class=pc1 title="line 663 char 7 count 0">pair?</span><span class=pc1 title="line 663 char 6 count 0"> </span><span class=pc1 title="line 663 char 13 count 0">v</span><span class=pc1 title="line 663 char 6 count 0">)</span>
     <span class=pc1 title="line 664 char 6 count 0">(or </span><span class=pc1 title="line 664 char 10 count 0">(</span><span class=pc1 title="line 664 char 11 count 0">member*</span><span class=pc1 title="line 664 char 10 count 0"> </span><span class=pc1 title="line 664 char 19 count 0">u</span><span class=pc1 title="line 664 char 10 count 0"> </span><span class=pc1 title="line 664 char 21 count 0">(</span><span class=pc1 title="line 664 char 22 count 0">car</span><span class=pc1 title="line 664 char 21 count 0"> </span><span class=pc1 title="line 664 char 26 count 0">v</span><span class=pc1 title="line 664 char 21 count 0">)</span><span class=pc1 title="line 664 char 10 count 0">)</span><span class=pc1 title="line 664 char 6 count 0"> </span><span class=pc1 title="line 664 char 30 count 0">(</span><span class=pc1 title="line 664 char 31 count 0">member*</span><span class=pc1 title="line 664 char 30 count 0"> </span><span class=pc1 title="line 664 char 39 count 0">u</span><span class=pc1 title="line 664 char 30 count 0"> </span><span class=pc1 title="line 664 char 41 count 0">(</span><span class=pc1 title="line 664 char 42 count 0">cdr</span><span class=pc1 title="line 664 char 41 count 0"> </span><span class=pc1 title="line 664 char 46 count 0">v</span><span class=pc1 title="line 664 char 41 count 0">)</span><span class=pc1 title="line 664 char 30 count 0">)</span><span class=pc1 title="line 664 char 6 count 0">)</span><span class=pc1 title="line 661 char 3 count 0">)</span>
    <span class=pc1 title="line 661 char 3 count 0">(else </span><span class=pc1 title="line 665 char 11 count 0">#f</span><span class=pc1 title="line 661 char 3 count 0">))</span><span class=pc2 title="line 660 char 1 count 1">)</span>

; (-&gt; disequality/c disequality/c boolean?)
; Examples:
;  * ((a . 5) (b . 6)) is subsumed by ((a . 5)) because (not (== a 5)) is a stronger constraint
;    than (not (and (== a 5) (== b 6)))
<span class=pc2 title="line 671 char 1 count 1">(define (d-subsumed-by? d1 d2)</span>
  <span class=pc2 title="line 672 char 3 count 653">(let*-values (((S ignore) </span><span class=pc2 title="line 672 char 29 count 653">(</span><span class=pc2 title="line 672 char 30 count 653">unify*</span><span class=pc2 title="line 672 char 29 count 653"> </span><span class=pc2 title="line 672 char 37 count 653">d1</span><span class=pc2 title="line 672 char 29 count 653"> </span><span class=pc2 title="line 672 char 40 count 653">(</span><span class=pc2 title="line 672 char 41 count 653">subst</span><span class=pc2 title="line 672 char 40 count 653"> </span><span class=pc2 title="line 672 char 47 count 653">empty-subst-map</span><span class=pc2 title="line 672 char 40 count 653"> </span><span class=pc2 title="line 672 char 63 count 653">nonlocal-scope</span><span class=pc2 title="line 672 char 40 count 653">)</span><span class=pc2 title="line 672 char 29 count 653">)</span><span class=pc2 title="line 672 char 3 count 653">)</span>
                <span class=pc2 title="line 672 char 3 count 653">((S+ added) </span><span class=pc2 title="line 673 char 29 count 653">(</span><span class=pc2 title="line 673 char 30 count 653">unify*</span><span class=pc2 title="line 673 char 29 count 653"> </span><span class=pc2 title="line 673 char 37 count 653">d2</span><span class=pc2 title="line 673 char 29 count 653"> </span><span class=pc2 title="line 673 char 40 count 653">S</span><span class=pc2 title="line 673 char 29 count 653">)</span><span class=pc2 title="line 672 char 3 count 653">))</span>
               <span class=pc2 title="line 674 char 16 count 653">(and </span><span class=pc2 title="line 674 char 21 count 653">S+</span><span class=pc2 title="line 674 char 16 count 653"> </span><span class=pc2 title="line 674 char 24 count 433">(</span><span class=pc2 title="line 674 char 25 count 433">null?</span><span class=pc2 title="line 674 char 24 count 433"> </span><span class=pc2 title="line 674 char 31 count 433">added</span><span class=pc2 title="line 674 char 24 count 433">)</span><span class=pc2 title="line 674 char 16 count 653">)</span><span class=pc2 title="line 672 char 3 count 653">)</span><span class=pc2 title="line 671 char 1 count 1">)</span>

<span class=pc2 title="line 676 char 1 count 1">(define (reify-S v S)</span>
  <span class=pc2 title="line 677 char 3 count 53">(let ((v </span><span class=pc2 title="line 677 char 12 count 53">(</span><span class=pc2 title="line 677 char 13 count 53">walk</span><span class=pc2 title="line 677 char 12 count 53"> </span><span class=pc2 title="line 677 char 18 count 53">v</span><span class=pc2 title="line 677 char 12 count 53"> </span><span class=pc2 title="line 677 char 20 count 53">S</span><span class=pc2 title="line 677 char 12 count 53">)</span><span class=pc2 title="line 677 char 3 count 53">))</span>
    <span class=pc2 title="line 678 char 5 count 53">(cond</span>
      <span class=pc2 title="line 678 char 5 count 53">(</span><span class=pc2 title="line 679 char 8 count 53">(</span><span class=pc2 title="line 679 char 9 count 53">var?</span><span class=pc2 title="line 679 char 8 count 53"> </span><span class=pc2 title="line 679 char 14 count 53">v</span><span class=pc2 title="line 679 char 8 count 53">)</span>
       <span class=pc2 title="line 680 char 8 count 2">(let ((n </span><span class=pc2 title="line 680 char 17 count 2">(</span><span class=pc2 title="line 680 char 18 count 2">subst-length</span><span class=pc2 title="line 680 char 17 count 2"> </span><span class=pc2 title="line 680 char 31 count 2">S</span><span class=pc2 title="line 680 char 17 count 2">)</span><span class=pc2 title="line 680 char 8 count 2">))</span>
         <span class=pc2 title="line 681 char 10 count 2">(let ((name </span><span class=pc2 title="line 681 char 22 count 2">(</span><span class=pc2 title="line 681 char 23 count 2">reify-name</span><span class=pc2 title="line 681 char 22 count 2"> </span><span class=pc2 title="line 681 char 34 count 2">n</span><span class=pc2 title="line 681 char 22 count 2">)</span><span class=pc2 title="line 681 char 10 count 2">))</span>
           <span class=pc2 title="line 682 char 12 count 2">(</span><span class=pc2 title="line 682 char 13 count 2">subst-add</span><span class=pc2 title="line 682 char 12 count 2"> </span><span class=pc2 title="line 682 char 23 count 2">S</span><span class=pc2 title="line 682 char 12 count 2"> </span><span class=pc2 title="line 682 char 25 count 2">v</span><span class=pc2 title="line 682 char 12 count 2"> </span><span class=pc2 title="line 682 char 27 count 2">name</span><span class=pc2 title="line 682 char 12 count 2">)</span><span class=pc2 title="line 681 char 10 count 2">)</span><span class=pc2 title="line 680 char 8 count 2">)</span><span class=pc2 title="line 678 char 5 count 53">)</span>
      <span class=pc2 title="line 678 char 5 count 53">(</span><span class=pc2 title="line 683 char 8 count 51">(</span><span class=pc2 title="line 683 char 9 count 51">pair?</span><span class=pc2 title="line 683 char 8 count 51"> </span><span class=pc2 title="line 683 char 15 count 51">v</span><span class=pc2 title="line 683 char 8 count 51">)</span>
       <span class=pc2 title="line 684 char 8 count 26">(let ((S </span><span class=pc2 title="line 684 char 17 count 26">(</span><span class=pc2 title="line 684 char 18 count 26">reify-S</span><span class=pc2 title="line 684 char 17 count 26"> </span><span class=pc2 title="line 684 char 26 count 26">(</span><span class=pc2 title="line 684 char 27 count 26">car</span><span class=pc2 title="line 684 char 26 count 26"> </span><span class=pc2 title="line 684 char 31 count 26">v</span><span class=pc2 title="line 684 char 26 count 26">)</span><span class=pc2 title="line 684 char 17 count 26"> </span><span class=pc2 title="line 684 char 34 count 26">S</span><span class=pc2 title="line 684 char 17 count 26">)</span><span class=pc2 title="line 684 char 8 count 26">))</span>
         <span class=pc2 title="line 685 char 10 count 26">(</span><span class=pc2 title="line 685 char 11 count 26">reify-S</span><span class=pc2 title="line 685 char 10 count 26"> </span><span class=pc2 title="line 685 char 19 count 26">(</span><span class=pc2 title="line 685 char 20 count 26">cdr</span><span class=pc2 title="line 685 char 19 count 26"> </span><span class=pc2 title="line 685 char 24 count 26">v</span><span class=pc2 title="line 685 char 19 count 26">)</span><span class=pc2 title="line 685 char 10 count 26"> </span><span class=pc2 title="line 685 char 27 count 26">S</span><span class=pc2 title="line 685 char 10 count 26">)</span><span class=pc2 title="line 684 char 8 count 26">)</span><span class=pc2 title="line 678 char 5 count 53">)</span>
      <span class=pc2 title="line 678 char 5 count 53">(else </span><span class=pc2 title="line 686 char 13 count 25">S</span><span class=pc2 title="line 678 char 5 count 53">))</span><span class=pc2 title="line 677 char 3 count 53">)</span><span class=pc2 title="line 676 char 1 count 1">)</span>

; Formatting

<span class=pc2 title="line 690 char 1 count 1">(define (reify-name n)</span>
  <span class=pc2 title="line 691 char 3 count 2">(</span><span class=pc2 title="line 691 char 4 count 2">string-&gt;symbol</span>
    <span class=pc2 title="line 692 char 5 count 2">(</span><span class=pc2 title="line 692 char 6 count 2">string-append</span><span class=pc2 title="line 692 char 5 count 2"> </span><span class=pc2 title="line 692 char 20 count 2">"_"</span><span class=pc2 title="line 692 char 5 count 2"> </span><span class=pc2 title="line 692 char 24 count 2">"."</span><span class=pc2 title="line 692 char 5 count 2"> </span><span class=pc2 title="line 692 char 28 count 2">(</span><span class=pc2 title="line 692 char 29 count 2">number-&gt;string</span><span class=pc2 title="line 692 char 28 count 2"> </span><span class=pc2 title="line 692 char 44 count 2">n</span><span class=pc2 title="line 692 char 28 count 2">)</span><span class=pc2 title="line 692 char 5 count 2">)</span><span class=pc2 title="line 691 char 3 count 2">)</span><span class=pc2 title="line 690 char 1 count 1">)</span>

<span class=pc2 title="line 694 char 1 count 1">(define (form v D T A)</span>
  <span class=pc2 title="line 695 char 3 count 1">(let ((ft </span><span class=pc2 title="line 695 char 13 count 1">(</span><span class=pc2 title="line 695 char 14 count 1">filter-map</span>
              <span class=pc2 title="line 696 char 15 count 1">(lambda (p)</span>
                <span class=pc2 title="line 697 char 17 count 3">(let ((tc-type </span><span class=pc2 title="line 697 char 32 count 3">(</span><span class=pc2 title="line 697 char 33 count 3">car</span><span class=pc2 title="line 697 char 32 count 3"> </span><span class=pc2 title="line 697 char 37 count 3">p</span><span class=pc2 title="line 697 char 32 count 3">)</span><span class=pc2 title="line 697 char 17 count 3">) (tc-vars </span><span class=pc2 title="line 697 char 50 count 3">(</span><span class=pc2 title="line 697 char 51 count 3">cdr</span><span class=pc2 title="line 697 char 50 count 3"> </span><span class=pc2 title="line 697 char 55 count 3">p</span><span class=pc2 title="line 697 char 50 count 3">)</span><span class=pc2 title="line 697 char 17 count 3">))</span>
                  <span class=pc2 title="line 698 char 19 count 3">(and </span><span class=pc2 title="line 698 char 24 count 3">(</span><span class=pc2 title="line 698 char 25 count 3">not</span><span class=pc2 title="line 698 char 24 count 3"> </span><span class=pc2 title="line 698 char 29 count 3">(</span><span class=pc2 title="line 698 char 30 count 3">null?</span><span class=pc2 title="line 698 char 29 count 3"> </span><span class=pc2 title="line 698 char 36 count 3">tc-vars</span><span class=pc2 title="line 698 char 29 count 3">)</span><span class=pc2 title="line 698 char 24 count 3">)</span>
                       <span class=pc2 title="line 699 char 24 count 1">`(,</span><span class=pc2 title="line 699 char 27 count 1">tc-type</span><span class=pc2 title="line 699 char 24 count 1"> . ,</span><span class=pc2 title="line 699 char 38 count 1">(</span><span class=pc2 title="line 699 char 39 count 1">sort-lex</span><span class=pc2 title="line 699 char 38 count 1"> </span><span class=pc2 title="line 699 char 48 count 1">tc-vars</span><span class=pc2 title="line 699 char 38 count 1">)</span><span class=pc2 title="line 699 char 24 count 1">)</span><span class=pc2 title="line 698 char 19 count 3">)</span><span class=pc2 title="line 697 char 17 count 3">)</span><span class=pc2 title="line 696 char 15 count 1">)</span>
              <span class=pc2 title="line 700 char 15 count 1">T</span><span class=pc2 title="line 695 char 13 count 1">)</span><span class=pc2 title="line 695 char 3 count 1">)</span>
        <span class=pc2 title="line 695 char 3 count 1">(fd </span><span class=pc2 title="line 701 char 13 count 1">(</span><span class=pc2 title="line 701 char 14 count 1">sort-D</span><span class=pc2 title="line 701 char 13 count 1"> </span><span class=pc2 title="line 701 char 21 count 1">D</span><span class=pc2 title="line 701 char 13 count 1">)</span><span class=pc2 title="line 695 char 3 count 1">)</span>
        <span class=pc2 title="line 695 char 3 count 1">(fa </span><span class=pc2 title="line 702 char 13 count 1">(</span><span class=pc2 title="line 702 char 14 count 1">sort-lex</span><span class=pc2 title="line 702 char 13 count 1"> </span><span class=pc2 title="line 702 char 23 count 1">A</span><span class=pc2 title="line 702 char 13 count 1">)</span><span class=pc2 title="line 695 char 3 count 1">))</span>
    <span class=pc2 title="line 703 char 5 count 1">(let ((fd </span><span class=pc2 title="line 703 char 15 count 1">(if </span><span class=pc2 title="line 703 char 19 count 1">(</span><span class=pc2 title="line 703 char 20 count 1">null?</span><span class=pc2 title="line 703 char 19 count 1"> </span><span class=pc2 title="line 703 char 26 count 1">fd</span><span class=pc2 title="line 703 char 19 count 1">)</span><span class=pc2 title="line 703 char 15 count 1"> </span><span class=pc1 title="line 703 char 30 count 0">fd</span>
                <span class=pc2 title="line 704 char 17 count 1">(let ((fd </span><span class=pc2 title="line 704 char 27 count 1">(</span><span class=pc2 title="line 704 char 28 count 1">drop-dot-D</span><span class=pc2 title="line 704 char 27 count 1"> </span><span class=pc2 title="line 704 char 39 count 1">fd</span><span class=pc2 title="line 704 char 27 count 1">)</span><span class=pc2 title="line 704 char 17 count 1">))</span>
                  <span class=pc2 title="line 705 char 19 count 1">`((=/= . ,</span><span class=pc2 title="line 705 char 29 count 1">fd</span><span class=pc2 title="line 705 char 19 count 1">))</span><span class=pc2 title="line 704 char 17 count 1">)</span><span class=pc2 title="line 703 char 15 count 1">)</span><span class=pc2 title="line 703 char 5 count 1">)</span>
          <span class=pc2 title="line 703 char 5 count 1">(fa </span><span class=pc2 title="line 706 char 15 count 1">(if </span><span class=pc2 title="line 706 char 19 count 1">(</span><span class=pc2 title="line 706 char 20 count 1">null?</span><span class=pc2 title="line 706 char 19 count 1"> </span><span class=pc2 title="line 706 char 26 count 1">fa</span><span class=pc2 title="line 706 char 19 count 1">)</span><span class=pc2 title="line 706 char 15 count 1"> </span><span class=pc2 title="line 706 char 30 count 1">fa</span>
                <span class=pc1 title="line 707 char 17 count 0">(let ((fa </span><span class=pc1 title="line 707 char 27 count 0">(</span><span class=pc1 title="line 707 char 28 count 0">drop-dot</span><span class=pc1 title="line 707 char 27 count 0"> </span><span class=pc1 title="line 707 char 37 count 0">fa</span><span class=pc1 title="line 707 char 27 count 0">)</span><span class=pc1 title="line 707 char 17 count 0">))</span>
                  <span class=pc1 title="line 708 char 19 count 0">`((absento . ,</span><span class=pc1 title="line 708 char 33 count 0">fa</span><span class=pc1 title="line 708 char 19 count 0">))</span><span class=pc1 title="line 707 char 17 count 0">)</span><span class=pc2 title="line 706 char 15 count 1">)</span><span class=pc2 title="line 703 char 5 count 1">))</span>
      <span class=pc2 title="line 709 char 7 count 1">(cond</span>
        <span class=pc2 title="line 709 char 7 count 1">(</span><span class=pc2 title="line 710 char 10 count 1">(and </span><span class=pc2 title="line 710 char 15 count 1">(</span><span class=pc2 title="line 710 char 16 count 1">null?</span><span class=pc2 title="line 710 char 15 count 1"> </span><span class=pc2 title="line 710 char 22 count 1">fd</span><span class=pc2 title="line 710 char 15 count 1">)</span><span class=pc2 title="line 710 char 10 count 1"> </span><span class=pc1 title="line 710 char 26 count 0">(</span><span class=pc1 title="line 710 char 27 count 0">null?</span><span class=pc1 title="line 710 char 26 count 0"> </span><span class=pc1 title="line 710 char 33 count 0">ft</span><span class=pc1 title="line 710 char 26 count 0">)</span><span class=pc2 title="line 710 char 10 count 1"> </span><span class=pc1 title="line 710 char 37 count 0">(</span><span class=pc1 title="line 710 char 38 count 0">null?</span><span class=pc1 title="line 710 char 37 count 0"> </span><span class=pc1 title="line 710 char 44 count 0">fa</span><span class=pc1 title="line 710 char 37 count 0">)</span><span class=pc2 title="line 710 char 10 count 1"> </span><span class=pc1 title="line 710 char 48 count 0">(</span><span class=pc1 title="line 710 char 49 count 0">not</span><span class=pc1 title="line 710 char 48 count 0"> </span><span class=pc1 title="line 710 char 53 count 0">(</span><span class=pc1 title="line 710 char 54 count 0">always-wrap-reified?</span><span class=pc1 title="line 710 char 53 count 0">)</span><span class=pc1 title="line 710 char 48 count 0">)</span><span class=pc2 title="line 710 char 10 count 1">)</span>
         <span class=pc1 title="line 711 char 10 count 0">v</span><span class=pc2 title="line 709 char 7 count 1">)</span>
        <span class=pc2 title="line 709 char 7 count 1">(else </span><span class=pc2 title="line 712 char 15 count 1">(</span><span class=pc2 title="line 712 char 16 count 1">append</span><span class=pc2 title="line 712 char 15 count 1"> </span><span class=pc2 title="line 712 char 23 count 1">`(,</span><span class=pc2 title="line 712 char 26 count 1">v</span><span class=pc2 title="line 712 char 23 count 1">)</span><span class=pc2 title="line 712 char 15 count 1"> </span><span class=pc2 title="line 712 char 29 count 1">fd</span><span class=pc2 title="line 712 char 15 count 1"> </span><span class=pc2 title="line 712 char 32 count 1">ft</span><span class=pc2 title="line 712 char 15 count 1"> </span><span class=pc2 title="line 712 char 35 count 1">fa</span><span class=pc2 title="line 712 char 15 count 1">)</span><span class=pc2 title="line 709 char 7 count 1">))</span><span class=pc2 title="line 703 char 5 count 1">)</span><span class=pc2 title="line 695 char 3 count 1">)</span><span class=pc2 title="line 694 char 1 count 1">)</span>

<span class=pc2 title="line 714 char 1 count 1">(define (sort-lex ls)</span>
  <span class=pc2 title="line 715 char 3 count 3">(</span><span class=pc2 title="line 715 char 4 count 3">list-sort</span><span class=pc2 title="line 715 char 3 count 3"> </span><span class=pc2 title="line 715 char 14 count 3">lex&lt;=?</span><span class=pc2 title="line 715 char 3 count 3"> </span><span class=pc2 title="line 715 char 21 count 3">ls</span><span class=pc2 title="line 715 char 3 count 3">)</span><span class=pc2 title="line 714 char 1 count 1">)</span>

<span class=pc2 title="line 717 char 1 count 1">(define (sort-D D)</span>
  <span class=pc2 title="line 718 char 3 count 1">(</span><span class=pc2 title="line 718 char 4 count 1">sort-lex</span><span class=pc2 title="line 718 char 3 count 1"> </span><span class=pc2 title="line 718 char 13 count 1">(</span><span class=pc2 title="line 718 char 14 count 1">map</span><span class=pc2 title="line 718 char 13 count 1"> </span><span class=pc2 title="line 718 char 18 count 1">sort-d</span><span class=pc2 title="line 718 char 13 count 1"> </span><span class=pc2 title="line 718 char 25 count 1">D</span><span class=pc2 title="line 718 char 13 count 1">)</span><span class=pc2 title="line 718 char 3 count 1">)</span><span class=pc2 title="line 717 char 1 count 1">)</span>

<span class=pc2 title="line 720 char 1 count 1">(define (sort-d d)</span>
  <span class=pc2 title="line 721 char 3 count 9">(</span><span class=pc2 title="line 721 char 4 count 9">list-sort</span>
    <span class=pc2 title="line 722 char 5 count 9">(lambda (x y)</span>
      <span class=pc1 title="line 723 char 7 count 0">(</span><span class=pc1 title="line 723 char 8 count 0">lex&lt;=?</span><span class=pc1 title="line 723 char 7 count 0"> </span><span class=pc1 title="line 723 char 15 count 0">(</span><span class=pc1 title="line 723 char 16 count 0">car</span><span class=pc1 title="line 723 char 15 count 0"> </span><span class=pc1 title="line 723 char 20 count 0">x</span><span class=pc1 title="line 723 char 15 count 0">)</span><span class=pc1 title="line 723 char 7 count 0"> </span><span class=pc1 title="line 723 char 23 count 0">(</span><span class=pc1 title="line 723 char 24 count 0">car</span><span class=pc1 title="line 723 char 23 count 0"> </span><span class=pc1 title="line 723 char 28 count 0">y</span><span class=pc1 title="line 723 char 23 count 0">)</span><span class=pc1 title="line 723 char 7 count 0">)</span><span class=pc2 title="line 722 char 5 count 9">)</span>
    <span class=pc2 title="line 724 char 5 count 9">(</span><span class=pc2 title="line 724 char 6 count 9">map</span><span class=pc2 title="line 724 char 5 count 9"> </span><span class=pc2 title="line 724 char 10 count 9">sort-pr</span><span class=pc2 title="line 724 char 5 count 9"> </span><span class=pc2 title="line 724 char 18 count 9">d</span><span class=pc2 title="line 724 char 5 count 9">)</span><span class=pc2 title="line 721 char 3 count 9">)</span><span class=pc2 title="line 720 char 1 count 1">)</span>

<span class=pc2 title="line 726 char 1 count 1">(define (symbol&lt;? a b) </span><span class=pc2 title="line 726 char 24 count 1">(</span><span class=pc2 title="line 726 char 25 count 1">string&lt;?</span><span class=pc2 title="line 726 char 24 count 1"> </span><span class=pc2 title="line 726 char 34 count 1">(</span><span class=pc2 title="line 726 char 35 count 1">symbol-&gt;string</span><span class=pc2 title="line 726 char 34 count 1"> </span><span class=pc2 title="line 726 char 50 count 1">a</span><span class=pc2 title="line 726 char 34 count 1">)</span><span class=pc2 title="line 726 char 24 count 1"> </span><span class=pc2 title="line 726 char 53 count 1">(</span><span class=pc2 title="line 726 char 54 count 1">symbol-&gt;string</span><span class=pc2 title="line 726 char 53 count 1"> </span><span class=pc2 title="line 726 char 69 count 1">b</span><span class=pc2 title="line 726 char 53 count 1">)</span><span class=pc2 title="line 726 char 24 count 1">)</span><span class=pc2 title="line 726 char 1 count 1">)</span>

<span class=pc2 title="line 728 char 1 count 1">(define (sort-pr pr)</span>
  <span class=pc2 title="line 729 char 3 count 9">(let ((l </span><span class=pc2 title="line 729 char 12 count 9">(</span><span class=pc2 title="line 729 char 13 count 9">lhs</span><span class=pc2 title="line 729 char 12 count 9"> </span><span class=pc2 title="line 729 char 17 count 9">pr</span><span class=pc2 title="line 729 char 12 count 9">)</span><span class=pc2 title="line 729 char 3 count 9">) (r </span><span class=pc2 title="line 729 char 25 count 9">(</span><span class=pc2 title="line 729 char 26 count 9">rhs</span><span class=pc2 title="line 729 char 25 count 9"> </span><span class=pc2 title="line 729 char 30 count 9">pr</span><span class=pc2 title="line 729 char 25 count 9">)</span><span class=pc2 title="line 729 char 3 count 9">))</span>
    <span class=pc2 title="line 730 char 5 count 9">(cond</span>
      <span class=pc2 title="line 730 char 5 count 9">(</span><span class=pc2 title="line 731 char 8 count 9">(</span><span class=pc2 title="line 731 char 9 count 9">not</span><span class=pc2 title="line 731 char 8 count 9"> </span><span class=pc2 title="line 731 char 13 count 9">(</span><span class=pc2 title="line 731 char 14 count 9">reified-var?</span><span class=pc2 title="line 731 char 13 count 9"> </span><span class=pc2 title="line 731 char 27 count 9">r</span><span class=pc2 title="line 731 char 13 count 9">)</span><span class=pc2 title="line 731 char 8 count 9">)</span><span class=pc2 title="line 730 char 5 count 9"> </span><span class=pc2 title="line 731 char 31 count 8">pr</span><span class=pc2 title="line 730 char 5 count 9">)</span>
      <span class=pc2 title="line 730 char 5 count 9">(</span><span class=pc2 title="line 732 char 8 count 1">(</span><span class=pc2 title="line 732 char 9 count 1">symbol&lt;?</span><span class=pc2 title="line 732 char 8 count 1"> </span><span class=pc2 title="line 732 char 18 count 1">r</span><span class=pc2 title="line 732 char 8 count 1"> </span><span class=pc2 title="line 732 char 20 count 1">l</span><span class=pc2 title="line 732 char 8 count 1">)</span><span class=pc2 title="line 730 char 5 count 9"> </span><span class=pc1 title="line 732 char 23 count 0">`(,</span><span class=pc1 title="line 732 char 26 count 0">r</span><span class=pc1 title="line 732 char 23 count 0"> . ,</span><span class=pc1 title="line 732 char 31 count 0">l</span><span class=pc1 title="line 732 char 23 count 0">)</span><span class=pc2 title="line 730 char 5 count 9">)</span>
      <span class=pc2 title="line 730 char 5 count 9">(else </span><span class=pc2 title="line 733 char 13 count 1">pr</span><span class=pc2 title="line 730 char 5 count 9">))</span><span class=pc2 title="line 729 char 3 count 9">)</span><span class=pc2 title="line 728 char 1 count 1">)</span>

<span class=pc2 title="line 735 char 1 count 1">(define (reified-var? r)</span>
  <span class=pc2 title="line 736 char 3 count 9">(and </span><span class=pc2 title="line 736 char 8 count 9">(</span><span class=pc2 title="line 736 char 9 count 9">symbol?</span><span class=pc2 title="line 736 char 8 count 9"> </span><span class=pc2 title="line 736 char 17 count 9">r</span><span class=pc2 title="line 736 char 8 count 9">)</span>
       <span class=pc2 title="line 737 char 8 count 9">(</span><span class=pc2 title="line 737 char 9 count 9">char=?</span><span class=pc2 title="line 737 char 8 count 9"> </span><span class=pc2 title="line 737 char 16 count 9">(</span><span class=pc2 title="line 737 char 17 count 9">string-ref</span><span class=pc2 title="line 737 char 16 count 9"> </span><span class=pc2 title="line 737 char 28 count 9">(</span><span class=pc2 title="line 737 char 29 count 9">symbol-&gt;string</span><span class=pc2 title="line 737 char 28 count 9"> </span><span class=pc2 title="line 737 char 44 count 9">r</span><span class=pc2 title="line 737 char 28 count 9">)</span><span class=pc2 title="line 737 char 16 count 9"> </span><span class=pc2 title="line 737 char 47 count 9">0</span><span class=pc2 title="line 737 char 16 count 9">)</span>
               <span class=pc2 title="line 738 char 16 count 9">#\_</span><span class=pc2 title="line 737 char 8 count 9">)</span><span class=pc2 title="line 736 char 3 count 9">)</span><span class=pc2 title="line 735 char 1 count 1">)</span>

<span class=pc2 title="line 740 char 1 count 1">(define (drop-dot-D D)</span>
  <span class=pc2 title="line 741 char 3 count 1">(</span><span class=pc2 title="line 741 char 4 count 1">map</span><span class=pc2 title="line 741 char 3 count 1"> </span><span class=pc2 title="line 741 char 8 count 1">drop-dot</span><span class=pc2 title="line 741 char 3 count 1"> </span><span class=pc2 title="line 741 char 17 count 1">D</span><span class=pc2 title="line 741 char 3 count 1">)</span><span class=pc2 title="line 740 char 1 count 1">)</span>

<span class=pc2 title="line 743 char 1 count 1">(define (drop-dot X)</span>
  <span class=pc2 title="line 744 char 3 count 9">(</span><span class=pc2 title="line 744 char 4 count 9">map</span><span class=pc2 title="line 744 char 3 count 9"> </span><span class=pc2 title="line 744 char 8 count 9">(lambda (t) </span><span class=pc2 title="line 744 char 20 count 9">(</span><span class=pc2 title="line 744 char 21 count 9">list</span><span class=pc2 title="line 744 char 20 count 9"> </span><span class=pc2 title="line 744 char 26 count 9">(</span><span class=pc2 title="line 744 char 27 count 9">lhs</span><span class=pc2 title="line 744 char 26 count 9"> </span><span class=pc2 title="line 744 char 31 count 9">t</span><span class=pc2 title="line 744 char 26 count 9">)</span><span class=pc2 title="line 744 char 20 count 9"> </span><span class=pc2 title="line 744 char 34 count 9">(</span><span class=pc2 title="line 744 char 35 count 9">rhs</span><span class=pc2 title="line 744 char 34 count 9"> </span><span class=pc2 title="line 744 char 39 count 9">t</span><span class=pc2 title="line 744 char 34 count 9">)</span><span class=pc2 title="line 744 char 20 count 9">)</span><span class=pc2 title="line 744 char 8 count 9">)</span>
       <span class=pc2 title="line 745 char 8 count 9">X</span><span class=pc2 title="line 744 char 3 count 9">)</span><span class=pc2 title="line 743 char 1 count 1">)</span>

; (Listof (Pair Predicate Ordering))
<span class=pc2 title="line 748 char 1 count 1">(define type-orderings</span>
  <span class=pc2 title="line 749 char 3 count 1">(</span><span class=pc2 title="line 749 char 4 count 1">append</span>
    <span class=pc2 title="line 749 char 3 count 1">; atomic types</span>
    <span class=pc2 title="line 751 char 5 count 1">(</span><span class=pc2 title="line 751 char 6 count 1">map</span><span class=pc2 title="line 751 char 5 count 1"> </span><span class=pc2 title="line 751 char 10 count 1">(lambda (tc) </span><span class=pc2 title="line 751 char 23 count 3">(</span><span class=pc2 title="line 751 char 24 count 3">cons</span><span class=pc2 title="line 751 char 23 count 3"> </span><span class=pc2 title="line 751 char 29 count 3">(</span><span class=pc2 title="line 751 char 30 count 3">type-constraint-predicate</span><span class=pc2 title="line 751 char 29 count 3"> </span><span class=pc2 title="line 751 char 56 count 3">tc</span><span class=pc2 title="line 751 char 29 count 3">)</span>
                            <span class=pc2 title="line 752 char 29 count 3">(</span><span class=pc2 title="line 752 char 30 count 3">type-constraint-ordering</span><span class=pc2 title="line 752 char 29 count 3"> </span><span class=pc2 title="line 752 char 55 count 3">tc</span><span class=pc2 title="line 752 char 29 count 3">)</span><span class=pc2 title="line 751 char 23 count 3">)</span><span class=pc2 title="line 751 char 10 count 1">)</span>
         <span class=pc2 title="line 753 char 10 count 1">type-constraints</span><span class=pc2 title="line 751 char 5 count 1">)</span>
    <span class=pc2 title="line 754 char 5 count 1">`(; booleans</span>
      <span class=pc2 title="line 754 char 5 count 1">(,</span><span class=pc2 title="line 755 char 9 count 1">(lambda (v) </span><span class=pc2 title="line 755 char 21 count 64">(</span><span class=pc2 title="line 755 char 22 count 64">eq?</span><span class=pc2 title="line 755 char 21 count 64"> </span><span class=pc2 title="line 755 char 26 count 64">v</span><span class=pc2 title="line 755 char 21 count 64"> </span><span class=pc2 title="line 755 char 28 count 64">#f</span><span class=pc2 title="line 755 char 21 count 64">)</span><span class=pc2 title="line 755 char 9 count 1">)</span><span class=pc2 title="line 754 char 5 count 1"> . ,</span><span class=pc2 title="line 755 char 36 count 1">(lambda (x y) </span><span class=pc1 title="line 755 char 50 count 0">'=</span><span class=pc2 title="line 755 char 36 count 1">)</span><span class=pc2 title="line 754 char 5 count 1">)</span>
      <span class=pc2 title="line 754 char 5 count 1">(,</span><span class=pc2 title="line 756 char 9 count 1">(lambda (v) </span><span class=pc2 title="line 756 char 21 count 64">(</span><span class=pc2 title="line 756 char 22 count 64">eq?</span><span class=pc2 title="line 756 char 21 count 64"> </span><span class=pc2 title="line 756 char 26 count 64">v</span><span class=pc2 title="line 756 char 21 count 64"> </span><span class=pc2 title="line 756 char 28 count 64">#t</span><span class=pc2 title="line 756 char 21 count 64">)</span><span class=pc2 title="line 756 char 9 count 1">)</span><span class=pc2 title="line 754 char 5 count 1"> . ,</span><span class=pc2 title="line 756 char 36 count 1">(lambda (x y) </span><span class=pc1 title="line 756 char 50 count 0">'=</span><span class=pc2 title="line 756 char 36 count 1">)</span><span class=pc2 title="line 754 char 5 count 1">)</span>
      <span class=pc2 title="line 754 char 5 count 1">; lists</span>
      <span class=pc2 title="line 754 char 5 count 1">(,</span><span class=pc2 title="line 758 char 9 count 1">null?</span><span class=pc2 title="line 754 char 5 count 1"> . ,</span><span class=pc2 title="line 758 char 18 count 1">(lambda (x y) </span><span class=pc1 title="line 758 char 32 count 0">'=</span><span class=pc2 title="line 758 char 18 count 1">)</span><span class=pc2 title="line 754 char 5 count 1">)</span>
      <span class=pc2 title="line 754 char 5 count 1">(,</span><span class=pc2 title="line 759 char 9 count 1">pair?</span><span class=pc2 title="line 754 char 5 count 1"> . ,</span><span class=pc2 title="line 759 char 18 count 1">(lambda (x y)</span>
                   <span class=pc2 title="line 760 char 20 count 32">(let ((r </span><span class=pc2 title="line 760 char 29 count 32">(</span><span class=pc2 title="line 760 char 30 count 32">lex-compare</span><span class=pc2 title="line 760 char 29 count 32"> </span><span class=pc2 title="line 760 char 42 count 32">(</span><span class=pc2 title="line 760 char 43 count 32">car</span><span class=pc2 title="line 760 char 42 count 32"> </span><span class=pc2 title="line 760 char 47 count 32">x</span><span class=pc2 title="line 760 char 42 count 32">)</span><span class=pc2 title="line 760 char 29 count 32"> </span><span class=pc2 title="line 760 char 50 count 32">(</span><span class=pc2 title="line 760 char 51 count 32">car</span><span class=pc2 title="line 760 char 50 count 32"> </span><span class=pc2 title="line 760 char 55 count 32">y</span><span class=pc2 title="line 760 char 50 count 32">)</span><span class=pc2 title="line 760 char 29 count 32">)</span><span class=pc2 title="line 760 char 20 count 32">))</span>
                     <span class=pc2 title="line 761 char 22 count 32">(if </span><span class=pc2 title="line 761 char 26 count 32">(</span><span class=pc2 title="line 761 char 27 count 32">eq?</span><span class=pc2 title="line 761 char 26 count 32"> </span><span class=pc2 title="line 761 char 31 count 32">r</span><span class=pc2 title="line 761 char 26 count 32"> </span><span class=pc2 title="line 761 char 33 count 32">'=</span><span class=pc2 title="line 761 char 26 count 32">)</span>
                       <span class=pc2 title="line 762 char 24 count 14">(</span><span class=pc2 title="line 762 char 25 count 14">lex-compare</span><span class=pc2 title="line 762 char 24 count 14"> </span><span class=pc2 title="line 762 char 37 count 14">(</span><span class=pc2 title="line 762 char 38 count 14">cdr</span><span class=pc2 title="line 762 char 37 count 14"> </span><span class=pc2 title="line 762 char 42 count 14">x</span><span class=pc2 title="line 762 char 37 count 14">)</span><span class=pc2 title="line 762 char 24 count 14"> </span><span class=pc2 title="line 762 char 45 count 14">(</span><span class=pc2 title="line 762 char 46 count 14">cdr</span><span class=pc2 title="line 762 char 45 count 14"> </span><span class=pc2 title="line 762 char 50 count 14">y</span><span class=pc2 title="line 762 char 45 count 14">)</span><span class=pc2 title="line 762 char 24 count 14">)</span>
                       <span class=pc2 title="line 763 char 24 count 18">r</span><span class=pc2 title="line 761 char 22 count 32">)</span><span class=pc2 title="line 760 char 20 count 32">)</span><span class=pc2 title="line 759 char 18 count 1">)</span><span class=pc2 title="line 754 char 5 count 1">))</span><span class=pc2 title="line 749 char 3 count 1">)</span><span class=pc2 title="line 748 char 1 count 1">)</span>

<span class=pc2 title="line 765 char 1 count 1">(define (index+element-where l pred)</span>
  <span class=pc2 title="line 766 char 3 count 126">(let loop ((l </span><span class=pc2 title="line 766 char 17 count 126">l</span><span class=pc2 title="line 766 char 3 count 126">)</span>
             <span class=pc2 title="line 766 char 3 count 126">(i </span><span class=pc2 title="line 767 char 17 count 126">0</span><span class=pc2 title="line 766 char 3 count 126">))</span>
    <span class=pc2 title="line 768 char 5 count 634">(cond</span>
      <span class=pc2 title="line 768 char 5 count 634">[</span><span class=pc2 title="line 769 char 8 count 634">(</span><span class=pc2 title="line 769 char 9 count 634">null?</span><span class=pc2 title="line 769 char 8 count 634"> </span><span class=pc2 title="line 769 char 15 count 634">l</span><span class=pc2 title="line 769 char 8 count 634">)</span><span class=pc2 title="line 768 char 5 count 634">      </span><span class=pc1 title="line 769 char 23 count 0">(</span><span class=pc1 title="line 769 char 24 count 0">values</span><span class=pc1 title="line 769 char 23 count 0"> </span><span class=pc1 title="line 769 char 31 count 0">#f</span><span class=pc1 title="line 769 char 23 count 0"> </span><span class=pc1 title="line 769 char 34 count 0">#f</span><span class=pc1 title="line 769 char 23 count 0">)</span><span class=pc2 title="line 768 char 5 count 634">]</span>
      <span class=pc2 title="line 768 char 5 count 634">[</span><span class=pc2 title="line 770 char 8 count 634">(</span><span class=pc2 title="line 770 char 9 count 634">pred</span><span class=pc2 title="line 770 char 8 count 634"> </span><span class=pc2 title="line 770 char 14 count 634">(</span><span class=pc2 title="line 770 char 15 count 634">car</span><span class=pc2 title="line 770 char 14 count 634"> </span><span class=pc2 title="line 770 char 19 count 634">l</span><span class=pc2 title="line 770 char 14 count 634">)</span><span class=pc2 title="line 770 char 8 count 634">)</span><span class=pc2 title="line 768 char 5 count 634"> </span><span class=pc2 title="line 770 char 23 count 126">(</span><span class=pc2 title="line 770 char 24 count 126">values</span><span class=pc2 title="line 770 char 23 count 126"> </span><span class=pc2 title="line 770 char 31 count 126">i</span><span class=pc2 title="line 770 char 23 count 126"> </span><span class=pc2 title="line 770 char 33 count 126">(</span><span class=pc2 title="line 770 char 34 count 126">car</span><span class=pc2 title="line 770 char 33 count 126"> </span><span class=pc2 title="line 770 char 38 count 126">l</span><span class=pc2 title="line 770 char 33 count 126">)</span><span class=pc2 title="line 770 char 23 count 126">)</span><span class=pc2 title="line 768 char 5 count 634">]</span>
      <span class=pc2 title="line 768 char 5 count 634">[else           </span><span class=pc2 title="line 771 char 23 count 508">(</span><span class=pc2 title="line 771 char 24 count 508">loop</span><span class=pc2 title="line 771 char 23 count 508"> </span><span class=pc2 title="line 771 char 29 count 508">(</span><span class=pc2 title="line 771 char 30 count 508">cdr</span><span class=pc2 title="line 771 char 29 count 508"> </span><span class=pc2 title="line 771 char 34 count 508">l</span><span class=pc2 title="line 771 char 29 count 508">)</span><span class=pc2 title="line 771 char 23 count 508"> </span><span class=pc2 title="line 771 char 37 count 508">(</span><span class=pc2 title="line 771 char 38 count 508">+</span><span class=pc2 title="line 771 char 37 count 508"> </span><span class=pc2 title="line 771 char 40 count 508">i</span><span class=pc2 title="line 771 char 37 count 508"> </span><span class=pc2 title="line 771 char 42 count 508">1</span><span class=pc2 title="line 771 char 37 count 508">)</span><span class=pc2 title="line 771 char 23 count 508">)</span><span class=pc2 title="line 768 char 5 count 634">])</span><span class=pc2 title="line 766 char 3 count 126">)</span><span class=pc2 title="line 765 char 1 count 1">)</span>

<span class=pc2 title="line 773 char 1 count 1">(define (type-ordering v)</span>
  <span class=pc2 title="line 774 char 3 count 126">(let-values ([(idx pr) </span><span class=pc2 title="line 774 char 26 count 126">(</span><span class=pc2 title="line 774 char 27 count 126">index+element-where</span><span class=pc2 title="line 774 char 26 count 126"> </span><span class=pc2 title="line 774 char 47 count 126">type-orderings</span><span class=pc2 title="line 774 char 26 count 126"> </span><span class=pc2 title="line 774 char 62 count 126">(lambda (pr) </span><span class=pc2 title="line 774 char 75 count 634">(</span><span class=pc2 title="line 774 char 76 count 634">(</span><span class=pc2 title="line 774 char 77 count 634">lhs</span><span class=pc2 title="line 774 char 76 count 634"> </span><span class=pc2 title="line 774 char 81 count 634">pr</span><span class=pc2 title="line 774 char 76 count 634">)</span><span class=pc2 title="line 774 char 75 count 634"> </span><span class=pc2 title="line 774 char 85 count 634">v</span><span class=pc2 title="line 774 char 75 count 634">)</span><span class=pc2 title="line 774 char 62 count 126">)</span><span class=pc2 title="line 774 char 26 count 126">)</span><span class=pc2 title="line 774 char 3 count 126">])</span>
    <span class=pc2 title="line 775 char 5 count 126">(if </span><span class=pc2 title="line 775 char 9 count 126">idx</span>
      <span class=pc2 title="line 776 char 7 count 126">(</span><span class=pc2 title="line 776 char 8 count 126">values</span><span class=pc2 title="line 776 char 7 count 126"> </span><span class=pc2 title="line 776 char 15 count 126">idx</span><span class=pc2 title="line 776 char 7 count 126"> </span><span class=pc2 title="line 776 char 19 count 126">(</span><span class=pc2 title="line 776 char 20 count 126">rhs</span><span class=pc2 title="line 776 char 19 count 126"> </span><span class=pc2 title="line 776 char 24 count 126">pr</span><span class=pc2 title="line 776 char 19 count 126">)</span><span class=pc2 title="line 776 char 7 count 126">)</span>
      <span class=pc1 title="line 777 char 7 count 0">(</span><span class=pc1 title="line 777 char 8 count 0">error</span><span class=pc1 title="line 777 char 7 count 0"> </span><span class=pc1 title="line 777 char 14 count 0">'type-index</span><span class=pc1 title="line 777 char 7 count 0"> </span><span class=pc1 title="line 777 char 26 count 0">"missing ordering for type of value ~s"</span><span class=pc1 title="line 777 char 7 count 0"> </span><span class=pc1 title="line 777 char 66 count 0">v</span><span class=pc1 title="line 777 char 7 count 0">)</span><span class=pc2 title="line 775 char 5 count 126">)</span><span class=pc2 title="line 774 char 3 count 126">)</span><span class=pc2 title="line 773 char 1 count 1">)</span>

; (Term, Term) -&gt; (or CompareResult error)
; defined when arguments are pairs, null, or atomic types addressed by type-constraints;
; see type-orderings.
<span class=pc2 title="line 782 char 1 count 1">(define (lex-compare x y)</span>
  <span class=pc2 title="line 783 char 3 count 63">(let-values (((x-o-idx x-o) </span><span class=pc2 title="line 783 char 31 count 63">(</span><span class=pc2 title="line 783 char 32 count 63">type-ordering</span><span class=pc2 title="line 783 char 31 count 63"> </span><span class=pc2 title="line 783 char 46 count 63">x</span><span class=pc2 title="line 783 char 31 count 63">)</span><span class=pc2 title="line 783 char 3 count 63">)</span>
               <span class=pc2 title="line 783 char 3 count 63">((y-o-idx y-o) </span><span class=pc2 title="line 784 char 31 count 63">(</span><span class=pc2 title="line 784 char 32 count 63">type-ordering</span><span class=pc2 title="line 784 char 31 count 63"> </span><span class=pc2 title="line 784 char 46 count 63">y</span><span class=pc2 title="line 784 char 31 count 63">)</span><span class=pc2 title="line 783 char 3 count 63">))</span>
    <span class=pc2 title="line 785 char 5 count 63">(if </span><span class=pc2 title="line 785 char 9 count 63">(</span><span class=pc2 title="line 785 char 10 count 63">eqv?</span><span class=pc2 title="line 785 char 9 count 63"> </span><span class=pc2 title="line 785 char 15 count 63">x-o-idx</span><span class=pc2 title="line 785 char 9 count 63"> </span><span class=pc2 title="line 785 char 23 count 63">y-o-idx</span><span class=pc2 title="line 785 char 9 count 63">)</span>
      <span class=pc2 title="line 786 char 7 count 63">(</span><span class=pc2 title="line 786 char 8 count 63">x-o</span><span class=pc2 title="line 786 char 7 count 63"> </span><span class=pc2 title="line 786 char 12 count 63">x</span><span class=pc2 title="line 786 char 7 count 63"> </span><span class=pc2 title="line 786 char 14 count 63">y</span><span class=pc2 title="line 786 char 7 count 63">)</span>
      <span class=pc1 title="line 787 char 7 count 0">(</span><span class=pc1 title="line 787 char 8 count 0">number-compare</span><span class=pc1 title="line 787 char 7 count 0"> </span><span class=pc1 title="line 787 char 23 count 0">x-o-idx</span><span class=pc1 title="line 787 char 7 count 0"> </span><span class=pc1 title="line 787 char 31 count 0">y-o-idx</span><span class=pc1 title="line 787 char 7 count 0">)</span><span class=pc2 title="line 785 char 5 count 63">)</span><span class=pc2 title="line 783 char 3 count 63">)</span><span class=pc2 title="line 782 char 1 count 1">)</span>

<span class=pc2 title="line 789 char 1 count 1">(define (lex&lt;=? x y)</span>
  <span class=pc2 title="line 790 char 3 count 17">(</span><span class=pc2 title="line 790 char 4 count 17">member</span><span class=pc2 title="line 790 char 3 count 17"> </span><span class=pc2 title="line 790 char 11 count 17">(</span><span class=pc2 title="line 790 char 12 count 17">lex-compare</span><span class=pc2 title="line 790 char 11 count 17"> </span><span class=pc2 title="line 790 char 24 count 17">x</span><span class=pc2 title="line 790 char 11 count 17"> </span><span class=pc2 title="line 790 char 26 count 17">y</span><span class=pc2 title="line 790 char 11 count 17">)</span><span class=pc2 title="line 790 char 3 count 17"> </span><span class=pc2 title="line 790 char 29 count 17">'(&lt; =)</span><span class=pc2 title="line 790 char 3 count 17">)</span><span class=pc2 title="line 789 char 1 count 1">)</span>
</pre></td></tr></table>
</body>
</html>